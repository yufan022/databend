statement ok
set sandbox_tenant = 'test_tenant';

statement ok
use tpcds;

# Q1

query I
WITH customer_total_return AS
  (SELECT sr_customer_sk AS ctr_customer_sk,
          sr_store_sk AS ctr_store_sk,
          sum(sr_return_amt) AS ctr_total_return
   FROM store_returns,
        date_dim
   WHERE sr_returned_date_sk = d_date_sk
     AND d_year = 2000
   GROUP BY sr_customer_sk,
            sr_store_sk)
SELECT c_customer_id
FROM customer_total_return ctr1,
     store,
     customer
WHERE ctr1.ctr_total_return >
    (SELECT avg(ctr_total_return)*1.2
     FROM customer_total_return ctr2
     WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk)
  AND s_store_sk = ctr1.ctr_store_sk
  AND s_state = 'TN'
  AND ctr1.ctr_customer_sk = c_customer_sk
ORDER BY c_customer_id
LIMIT 100;
----
AAAAAAAAAACAAAAA
AAAAAAAAAGBAAAAA
AAAAAAAAAHCAAAAA
AAAAAAAAAICAAAAA
AAAAAAAAAKCAAAAA
AAAAAAAAAKDAAAAA
AAAAAAAAALBAAAAA
AAAAAAAAANBAAAAA
AAAAAAAAAPCAAAAA
AAAAAAAABEAAAAAA
AAAAAAAABGBAAAAA
AAAAAAAABGDAAAAA
AAAAAAAABMBAAAAA
AAAAAAAABMDAAAAA
AAAAAAAABNCAAAAA
AAAAAAAACDDAAAAA
AAAAAAAACEBAAAAA
AAAAAAAACECAAAAA
AAAAAAAACFDAAAAA
AAAAAAAACGBAAAAA
AAAAAAAACHBAAAAA
AAAAAAAACNDAAAAA
AAAAAAAADEBAAAAA
AAAAAAAADEDAAAAA
AAAAAAAADFAAAAAA
AAAAAAAADFCAAAAA
AAAAAAAADIBAAAAA
AAAAAAAADNAAAAAA
AAAAAAAADOCAAAAA
AAAAAAAAEBAAAAAA
AAAAAAAAEBBAAAAA
AAAAAAAAECBAAAAA
AAAAAAAAEKAAAAAA
AAAAAAAAEPBAAAAA
AAAAAAAAFCAAAAAA
AAAAAAAAFJAAAAAA
AAAAAAAAFJCAAAAA
AAAAAAAAFMCAAAAA
AAAAAAAAFPBAAAAA
AAAAAAAAGAAAAAAA
AAAAAAAAGBBAAAAA
AAAAAAAAGOBAAAAA
AAAAAAAAHEBAAAAA
AAAAAAAAHHDAAAAA
AAAAAAAAHICAAAAA
AAAAAAAAHLDAAAAA
AAAAAAAAHNCAAAAA
AAAAAAAAICAAAAAA
AAAAAAAAIFDAAAAA
AAAAAAAAIIAAAAAA
AAAAAAAAIMAAAAAA
AAAAAAAAINAAAAAA
AAAAAAAAIOAAAAAA
AAAAAAAAIODAAAAA
AAAAAAAAJCCAAAAA
AAAAAAAAJFBAAAAA
AAAAAAAAJFCAAAAA
AAAAAAAAJKAAAAAA
AAAAAAAAJMDAAAAA
AAAAAAAAKADAAAAA
AAAAAAAAKBAAAAAA
AAAAAAAAKCDAAAAA
AAAAAAAAKECAAAAA
AAAAAAAAKGDAAAAA
AAAAAAAAKHBAAAAA
AAAAAAAAKJAAAAAA
AAAAAAAAKJCAAAAA
AAAAAAAAKJDAAAAA
AAAAAAAAKNAAAAAA
AAAAAAAALABAAAAA
AAAAAAAALBCAAAAA
AAAAAAAALCAAAAAA
AAAAAAAALCDAAAAA
AAAAAAAALFAAAAAA
AAAAAAAALFCAAAAA
AAAAAAAALLCAAAAA
AAAAAAAALNBAAAAA
AAAAAAAAMAAAAAAA
AAAAAAAAMABAAAAA
AAAAAAAAMACAAAAA
AAAAAAAAMBBAAAAA
AAAAAAAAMBCAAAAA
AAAAAAAAMGCAAAAA
AAAAAAAAMHCAAAAA
AAAAAAAAMJAAAAAA
AAAAAAAAMJDAAAAA
AAAAAAAANBCAAAAA
AAAAAAAANBDAAAAA
AAAAAAAANCAAAAAA
AAAAAAAANDCAAAAA
AAAAAAAANLAAAAAA
AAAAAAAANLBAAAAA
AAAAAAAANMAAAAAA
AAAAAAAANMBAAAAA
AAAAAAAAODCAAAAA
AAAAAAAAOIAAAAAA
AAAAAAAAOIDAAAAA
AAAAAAAAONBAAAAA
AAAAAAAAONCAAAAA
AAAAAAAAOOAAAAAA

# Q2

query I
WITH wscs AS
  (SELECT sold_date_sk,
          sales_price
   FROM
     (SELECT ws_sold_date_sk sold_date_sk,
             ws_ext_sales_price sales_price
      FROM web_sales
      UNION ALL SELECT cs_sold_date_sk sold_date_sk,
                       cs_ext_sales_price sales_price
      FROM catalog_sales) sq1),
     wswscs AS
  (SELECT d_week_seq,
          sum(CASE
                  WHEN (d_day_name='Sunday') THEN sales_price
                  ELSE NULL
              END) sun_sales,
          sum(CASE
                  WHEN (d_day_name='Monday') THEN sales_price
                  ELSE NULL
              END) mon_sales,
          sum(CASE
                  WHEN (d_day_name='Tuesday') THEN sales_price
                  ELSE NULL
              END) tue_sales,
          sum(CASE
                  WHEN (d_day_name='Wednesday') THEN sales_price
                  ELSE NULL
              END) wed_sales,
          sum(CASE
                  WHEN (d_day_name='Thursday') THEN sales_price
                  ELSE NULL
              END) thu_sales,
          sum(CASE
                  WHEN (d_day_name='Friday') THEN sales_price
                  ELSE NULL
              END) fri_sales,
          sum(CASE
                  WHEN (d_day_name='Saturday') THEN sales_price
                  ELSE NULL
              END) sat_sales
   FROM wscs,
        date_dim
   WHERE d_date_sk = sold_date_sk
   GROUP BY d_week_seq)
SELECT d_week_seq1,
       round(sun_sales1/sun_sales2, 2) r1,
       round(mon_sales1/mon_sales2, 2) r2,
       round(tue_sales1/tue_sales2, 2) r3,
       round(wed_sales1/wed_sales2, 2) r4,
       round(thu_sales1/thu_sales2, 2) r5,
       round(fri_sales1/fri_sales2, 2) r6,
       round(sat_sales1/sat_sales2, 2)
FROM
  (SELECT wswscs.d_week_seq d_week_seq1,
          sun_sales sun_sales1,
          mon_sales mon_sales1,
          tue_sales tue_sales1,
          wed_sales wed_sales1,
          thu_sales thu_sales1,
          fri_sales fri_sales1,
          sat_sales sat_sales1
   FROM wswscs,
        date_dim
   WHERE date_dim.d_week_seq = wswscs.d_week_seq
     AND d_year = 2001) y,
  (SELECT wswscs.d_week_seq d_week_seq2,
          sun_sales sun_sales2,
          mon_sales mon_sales2,
          tue_sales tue_sales2,
          wed_sales wed_sales2,
          thu_sales thu_sales2,
          fri_sales fri_sales2,
          sat_sales sat_sales2
   FROM wswscs,
        date_dim
   WHERE date_dim.d_week_seq = wswscs.d_week_seq
     AND d_year = 2001+1) z
WHERE d_week_seq1 = d_week_seq2-53
ORDER BY d_week_seq1 NULLS FIRST limit 200;
----
5270 NULL 2.60 NULL 0.71 2.48 NULL NULL
5270 NULL 2.60 NULL 0.71 2.48 NULL NULL
5270 NULL 2.60 NULL 0.71 2.48 NULL NULL
5270 NULL 2.60 NULL 0.71 2.48 NULL NULL
5270 NULL 2.60 NULL 0.71 2.48 NULL NULL
5270 NULL 2.60 NULL 0.71 2.48 NULL NULL
5270 NULL 2.60 NULL 0.71 2.48 NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5271 NULL NULL 0.50 NULL NULL NULL NULL
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5272 NULL NULL NULL 0.52 1.42 NULL 0.49
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5273 NULL NULL NULL NULL NULL NULL 0.78
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL
5274 NULL NULL NULL NULL 0.54 NULL NULL

# Q3

query I
SELECT dt.d_year,
       item.i_brand_id brand_id,
       item.i_brand brand,
       sum(ss_ext_sales_price) sum_agg
FROM date_dim dt,
     store_sales,
     item
WHERE dt.d_date_sk = store_sales.ss_sold_date_sk
  AND store_sales.ss_item_sk = item.i_item_sk
  AND item.i_manufact_id = 128
  AND dt.d_moy=11
GROUP BY dt.d_year,
         item.i_brand,
         item.i_brand_id
ORDER BY dt.d_year,
         sum_agg DESC,
         brand_id
LIMIT 100;
----

# Q4

query I
WITH year_total AS
  (SELECT c_customer_id customer_id,
          c_first_name customer_first_name,
          c_last_name customer_last_name,
          c_preferred_cust_flag customer_preferred_cust_flag,
          c_birth_country customer_birth_country,
          c_login customer_login,
          c_email_address customer_email_address,
          d_year dyear,
          sum(((ss_ext_list_price-ss_ext_wholesale_cost-ss_ext_discount_amt)+ss_ext_sales_price)/2) year_total,
          's' sale_type
   FROM customer,
        store_sales,
        date_dim
   WHERE c_customer_sk = ss_customer_sk
     AND ss_sold_date_sk = d_date_sk
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            c_preferred_cust_flag,
            c_birth_country,
            c_login,
            c_email_address,
            d_year
   UNION ALL SELECT c_customer_id customer_id,
                    c_first_name customer_first_name,
                    c_last_name customer_last_name,
                    c_preferred_cust_flag customer_preferred_cust_flag,
                    c_birth_country customer_birth_country,
                    c_login customer_login,
                    c_email_address customer_email_address,
                    d_year dyear,
                    sum((((cs_ext_list_price-cs_ext_wholesale_cost-cs_ext_discount_amt)+cs_ext_sales_price)/2)) year_total,
                    'c' sale_type
   FROM customer,
        catalog_sales,
        date_dim
   WHERE c_customer_sk = cs_bill_customer_sk
     AND cs_sold_date_sk = d_date_sk
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            c_preferred_cust_flag,
            c_birth_country,
            c_login,
            c_email_address,
            d_year
   UNION ALL SELECT c_customer_id customer_id,
                    c_first_name customer_first_name,
                    c_last_name customer_last_name,
                    c_preferred_cust_flag customer_preferred_cust_flag,
                    c_birth_country customer_birth_country,
                    c_login customer_login,
                    c_email_address customer_email_address,
                    d_year dyear,
                    sum((((ws_ext_list_price-ws_ext_wholesale_cost-ws_ext_discount_amt)+ws_ext_sales_price)/2)) year_total,
                    'w' sale_type
   FROM customer,
        web_sales,
        date_dim
   WHERE c_customer_sk = ws_bill_customer_sk
     AND ws_sold_date_sk = d_date_sk
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            c_preferred_cust_flag,
            c_birth_country,
            c_login,
            c_email_address,
            d_year)
SELECT t_s_secyear.customer_id,
       t_s_secyear.customer_first_name,
       t_s_secyear.customer_last_name,
       t_s_secyear.customer_preferred_cust_flag
FROM year_total t_s_firstyear,
     year_total t_s_secyear,
     year_total t_c_firstyear,
     year_total t_c_secyear,
     year_total t_w_firstyear,
     year_total t_w_secyear
WHERE t_s_secyear.customer_id = t_s_firstyear.customer_id
  AND t_s_firstyear.customer_id = t_c_secyear.customer_id
  AND t_s_firstyear.customer_id = t_c_firstyear.customer_id
  AND t_s_firstyear.customer_id = t_w_firstyear.customer_id
  AND t_s_firstyear.customer_id = t_w_secyear.customer_id
  AND t_s_firstyear.sale_type = 's'
  AND t_c_firstyear.sale_type = 'c'
  AND t_w_firstyear.sale_type = 'w'
  AND t_s_secyear.sale_type = 's'
  AND t_c_secyear.sale_type = 'c'
  AND t_w_secyear.sale_type = 'w'
  AND t_s_firstyear.dyear = 2001
  AND t_s_secyear.dyear = 2001+1
  AND t_c_firstyear.dyear = 2001
  AND t_c_secyear.dyear = 2001+1
  AND t_w_firstyear.dyear = 2001
  AND t_w_secyear.dyear = 2001+1
  AND t_s_firstyear.year_total > 0
  AND t_c_firstyear.year_total > 0
  AND t_w_firstyear.year_total > 0
  AND CASE
          WHEN t_c_firstyear.year_total > 0 THEN t_c_secyear.year_total / t_c_firstyear.year_total
          ELSE NULL
      END > CASE
                WHEN t_s_firstyear.year_total > 0 THEN t_s_secyear.year_total / t_s_firstyear.year_total
                ELSE NULL
            END
  AND CASE
          WHEN t_c_firstyear.year_total > 0 THEN t_c_secyear.year_total / t_c_firstyear.year_total
          ELSE NULL
      END > CASE
                WHEN t_w_firstyear.year_total > 0 THEN t_w_secyear.year_total / t_w_firstyear.year_total
                ELSE NULL
            END
ORDER BY t_s_secyear.customer_id NULLS FIRST,
         t_s_secyear.customer_first_name NULLS FIRST,
         t_s_secyear.customer_last_name NULLS FIRST,
         t_s_secyear.customer_preferred_cust_flag NULLS FIRST
LIMIT 100;
----


# Q5

query I
WITH ssr AS
  (SELECT s_store_id,
          sum(sales_price) AS sales,
          sum(profit) AS profit,
          sum(return_amt) AS returns_,
          sum(net_loss) AS profit_loss
   FROM
     (SELECT ss_store_sk AS store_sk,
             ss_sold_date_sk AS date_sk,
             ss_ext_sales_price AS sales_price,
             ss_net_profit AS profit,
             cast(0 AS decimal(7,2)) AS return_amt,
             cast(0 AS decimal(7,2)) AS net_loss
      FROM store_sales
      UNION ALL SELECT sr_store_sk AS store_sk,
                       sr_returned_date_sk AS date_sk,
                       cast(0 AS decimal(7,2)) AS sales_price,
                       cast(0 AS decimal(7,2)) AS profit,
                       sr_return_amt AS return_amt,
                       sr_net_loss AS net_loss
      FROM store_returns ) salesreturns,
        date_dim,
        store
   WHERE date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-06' AS date)
     AND store_sk = s_store_sk
   GROUP BY s_store_id) ,
     csr AS
  (SELECT cp_catalog_page_id,
          sum(sales_price) AS sales,
          sum(profit) AS profit,
          sum(return_amt) AS returns_,
          sum(net_loss) AS profit_loss
   FROM
     (SELECT cs_catalog_page_sk AS page_sk,
             cs_sold_date_sk AS date_sk,
             cs_ext_sales_price AS sales_price,
             cs_net_profit AS profit,
             cast(0 AS decimal(7,2)) AS return_amt,
             cast(0 AS decimal(7,2)) AS net_loss
      FROM catalog_sales
      UNION ALL SELECT cr_catalog_page_sk AS page_sk,
                       cr_returned_date_sk AS date_sk,
                       cast(0 AS decimal(7,2)) AS sales_price,
                       cast(0 AS decimal(7,2)) AS profit,
                       cr_return_amount AS return_amt,
                       cr_net_loss AS net_loss
      FROM catalog_returns ) salesreturns,
        date_dim,
        catalog_page
   WHERE date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-06' AS date)
     AND page_sk = cp_catalog_page_sk
   GROUP BY cp_catalog_page_id) ,
     wsr AS
  (SELECT web_site_id,
          sum(sales_price) AS sales,
          sum(profit) AS profit,
          sum(return_amt) AS returns_,
          sum(net_loss) AS profit_loss
   FROM
     (SELECT ws_web_site_sk AS wsr_web_site_sk,
             ws_sold_date_sk AS date_sk,
             ws_ext_sales_price AS sales_price,
             ws_net_profit AS profit,
             cast(0 AS decimal(7,2)) AS return_amt,
             cast(0 AS decimal(7,2)) AS net_loss
      FROM web_sales
      UNION ALL SELECT ws_web_site_sk AS wsr_web_site_sk,
                       wr_returned_date_sk AS date_sk,
                       cast(0 AS decimal(7,2)) AS sales_price,
                       cast(0 AS decimal(7,2)) AS profit,
                       wr_return_amt AS return_amt,
                       wr_net_loss AS net_loss
      FROM web_returns
      LEFT OUTER JOIN web_sales ON (wr_item_sk = ws_item_sk
                                    AND wr_order_number = ws_order_number) ) salesreturns,
        date_dim,
        web_site
   WHERE date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-06' AS date)
     AND wsr_web_site_sk = web_site_sk
   GROUP BY web_site_id)
SELECT channel ,
       id ,
       sum(sales) AS sales ,
       sum(returns_) AS returns_ ,
       sum(profit) AS profit
FROM
  (SELECT 'store channel' AS channel ,
          concat('store', s_store_id) AS id ,
          sales ,
          returns_ ,
          (profit - profit_loss) AS profit
   FROM ssr
   UNION ALL SELECT 'catalog channel' AS channel ,
                    concat('catalog_page', cp_catalog_page_id) AS id ,
                    sales ,
                    returns_ ,
                    (profit - profit_loss) AS profit
   FROM csr
   UNION ALL SELECT 'web channel' AS channel ,
                    concat('web_site', web_site_id) AS id ,
                    sales ,
                    returns_ ,
                    (profit - profit_loss) AS profit
   FROM wsr ) x
GROUP BY ROLLUP (channel,
                 id)
ORDER BY channel NULLS FIRST,
         id NULLS FIRST
LIMIT 100;
----
NULL NULL 1235226.36 22228.88 -364862.29
catalog channel NULL 394281.25 9538.33 -37140.33
catalog channel catalog_pageAAAAAAAAAAABAAAA 22.10 0.00 -96.00
catalog channel catalog_pageAAAAAAAAADABAAAA 372.40 0.00 53.79
catalog channel catalog_pageAAAAAAAAAFCBAAAA 626.40 0.00 -322.70
catalog channel catalog_pageAAAAAAAAAGABAAAA 3471.68 0.00 94.24
catalog channel catalog_pageAAAAAAAAAGCBAAAA 1891.89 0.00 -143.01
catalog channel catalog_pageAAAAAAAAAHCBAAAA 209.44 0.00 -5017.32
catalog channel catalog_pageAAAAAAAAAKPAAAAA 5304.00 0.00 735.20
catalog channel catalog_pageAAAAAAAAALPAAAAA 865.83 0.00 -695.97
catalog channel catalog_pageAAAAAAAAAOPAAAAA 7910.58 0.00 2044.14
catalog channel catalog_pageAAAAAAAABCABAAAA 3670.04 0.00 96.90
catalog channel catalog_pageAAAAAAAABDCBAAAA 4873.60 0.00 -84.62
catalog channel catalog_pageAAAAAAAABEABAAAA 16.80 0.00 -852.32
catalog channel catalog_pageAAAAAAAABFCBAAAA 627.36 0.00 42.36
catalog channel catalog_pageAAAAAAAABGABAAAA 3198.72 0.00 -3482.88
catalog channel catalog_pageAAAAAAAABHABAAAA 6152.40 0.00 972.90
catalog channel catalog_pageAAAAAAAABICBAAAA 150.90 0.00 -168.00
catalog channel catalog_pageAAAAAAAABLPAAAAA 5389.93 0.00 1362.50
catalog channel catalog_pageAAAAAAAACLPAAAAA 4581.66 0.00 820.04
catalog channel catalog_pageAAAAAAAACNCBAAAA 1537.38 0.00 -127.14
catalog channel catalog_pageAAAAAAAACNPAAAAA 2220.63 0.00 18.93
catalog channel catalog_pageAAAAAAAACOPAAAAA 9989.74 0.00 -83.60
catalog channel catalog_pageAAAAAAAACPPAAAAA 5447.76 0.00 786.97
catalog channel catalog_pageAAAAAAAADAABAAAA 1026.12 0.00 -2620.72
catalog channel catalog_pageAAAAAAAADBABAAAA 980.56 0.00 334.56
catalog channel catalog_pageAAAAAAAADEABAAAA 306.36 0.00 -275.65
catalog channel catalog_pageAAAAAAAADGABAAAA 7812.09 0.00 253.44
catalog channel catalog_pageAAAAAAAADGCBAAAA 330.60 0.00 -2791.10
catalog channel catalog_pageAAAAAAAADHABAAAA 1340.02 0.00 -316.14
catalog channel catalog_pageAAAAAAAADHPAAAAA 0.00 6954.50 -3284.09
catalog channel catalog_pageAAAAAAAADICBAAAA 5996.07 0.00 1360.17
catalog channel catalog_pageAAAAAAAADMPAAAAA 4181.33 0.00 513.30
catalog channel catalog_pageAAAAAAAADPPAAAAA 3313.75 0.00 -933.35
catalog channel catalog_pageAAAAAAAAEDABAAAA 3383.12 0.00 1440.92
catalog channel catalog_pageAAAAAAAAEDCBAAAA 581.94 0.00 -4024.82
catalog channel catalog_pageAAAAAAAAEECBAAAA 3658.50 0.00 2188.00
catalog channel catalog_pageAAAAAAAAEFCBAAAA 145.53 0.00 -469.63
catalog channel catalog_pageAAAAAAAAEGCBAAAA 9481.50 0.00 1839.00
catalog channel catalog_pageAAAAAAAAEHCBAAAA 1307.34 0.00 -2548.26
catalog channel catalog_pageAAAAAAAAEKPAAAAA 897.60 0.00 342.72
catalog channel catalog_pageAAAAAAAAELPAAAAA 14863.14 0.00 8761.40
catalog channel catalog_pageAAAAAAAAEMPAAAAA 209.56 0.00 -2501.94
catalog channel catalog_pageAAAAAAAAEOPAAAAA 2343.94 0.00 -2434.00
catalog channel catalog_pageAAAAAAAAEPPAAAAA 7316.92 0.00 -1759.63
catalog channel catalog_pageAAAAAAAAFAABAAAA 6500.52 0.00 1534.14
catalog channel catalog_pageAAAAAAAAFFABAAAA 614.25 0.00 -91.18
catalog channel catalog_pageAAAAAAAAFGABAAAA 643.20 0.00 62.10
catalog channel catalog_pageAAAAAAAAFGCBAAAA 231.42 0.00 116.10
catalog channel catalog_pageAAAAAAAAFHCBAAAA 721.20 0.00 158.40
catalog channel catalog_pageAAAAAAAAFICBAAAA 244.61 0.00 -437.98
catalog channel catalog_pageAAAAAAAAFMPAAAAA 9426.60 0.00 2692.80
catalog channel catalog_pageAAAAAAAAFOPAAAAA 202.02 0.00 -4314.20
catalog channel catalog_pageAAAAAAAAGAABAAAA 13698.23 0.00 5226.13
catalog channel catalog_pageAAAAAAAAGCCBAAAA 4558.02 0.00 161.77
catalog channel catalog_pageAAAAAAAAGGCBAAAA 25.11 0.00 -1437.78
catalog channel catalog_pageAAAAAAAAGNPAAAAA 2205.64 0.00 1169.82
catalog channel catalog_pageAAAAAAAAHAABAAAA 2695.35 0.00 12.95
catalog channel catalog_pageAAAAAAAAHBABAAAA 2377.98 0.00 264.00
catalog channel catalog_pageAAAAAAAAHCCBAAAA 162.11 0.00 -2316.41
catalog channel catalog_pageAAAAAAAAHDABAAAA 1948.05 0.00 744.75
catalog channel catalog_pageAAAAAAAAHGABAAAA 3490.56 0.00 -39.84
catalog channel catalog_pageAAAAAAAAHGCBAAAA 674.73 0.00 -3149.45
catalog channel catalog_pageAAAAAAAAHHCBAAAA 4625.50 0.00 2380.95
catalog channel catalog_pageAAAAAAAAHIPAAAAA 0.00 1073.70 -689.92
catalog channel catalog_pageAAAAAAAAHMPAAAAA 8269.73 0.00 -4607.62
catalog channel catalog_pageAAAAAAAAHOPAAAAA 8691.99 0.00 -4717.00
catalog channel catalog_pageAAAAAAAAHPCBAAAA 1295.56 0.00 -3035.55
catalog channel catalog_pageAAAAAAAAHPPAAAAA 4579.38 0.00 476.22
catalog channel catalog_pageAAAAAAAAIAABAAAA 7391.20 0.00 2330.40
catalog channel catalog_pageAAAAAAAAIBABAAAA 596.67 0.00 340.02
catalog channel catalog_pageAAAAAAAAIFABAAAA 667.60 0.00 -1763.21
catalog channel catalog_pageAAAAAAAAIFCBAAAA 242.40 0.00 -5386.40
catalog channel catalog_pageAAAAAAAAIICBAAAA 114.76 0.00 -842.08
catalog channel catalog_pageAAAAAAAAIKPAAAAA 1528.02 0.00 384.15
catalog channel catalog_pageAAAAAAAAILPAAAAA 2479.62 0.00 577.20
catalog channel catalog_pageAAAAAAAAIOPAAAAA 53.70 0.00 -324.90
catalog channel catalog_pageAAAAAAAAJAABAAAA 286.56 0.00 -21.12
catalog channel catalog_pageAAAAAAAAJCCBAAAA 430.56 0.00 -212.40
catalog channel catalog_pageAAAAAAAAJFCBAAAA 957.22 0.00 -339.91
catalog channel catalog_pageAAAAAAAAJHCBAAAA 416.25 0.00 75.50
catalog channel catalog_pageAAAAAAAAJKPAAAAA 4.20 0.00 -250.90
catalog channel catalog_pageAAAAAAAAJMPAAAAA 92.70 0.00 17.60
catalog channel catalog_pageAAAAAAAAJOPAAAAA 10521.42 0.00 2877.16
catalog channel catalog_pageAAAAAAAAKAABAAAA 183.60 0.00 -349.35
catalog channel catalog_pageAAAAAAAAKCABAAAA 494.55 0.00 -1750.77
catalog channel catalog_pageAAAAAAAAKDCBAAAA 2497.08 0.00 473.40
catalog channel catalog_pageAAAAAAAAKGABAAAA 132.86 0.00 -771.42
catalog channel catalog_pageAAAAAAAAKHCBAAAA 847.67 0.00 -2819.77
catalog channel catalog_pageAAAAAAAAKKPAAAAA 6799.36 0.00 3336.02
catalog channel catalog_pageAAAAAAAAKLPAAAAA 5040.20 0.00 -3162.45
catalog channel catalog_pageAAAAAAAAKNPAAAAA 3414.00 0.00 2130.40
catalog channel catalog_pageAAAAAAAAKOPAAAAA 7975.00 0.00 4245.00
catalog channel catalog_pageAAAAAAAALAABAAAA 19195.70 0.00 10003.50
catalog channel catalog_pageAAAAAAAALBABAAAA 221.88 0.00 18.40
catalog channel catalog_pageAAAAAAAALECBAAAA 761.36 0.00 -1823.29
catalog channel catalog_pageAAAAAAAALFCBAAAA 2881.80 0.00 691.20
catalog channel catalog_pageAAAAAAAALGABAAAA 747.20 0.00 408.44
catalog channel catalog_pageAAAAAAAALHCBAAAA 712.50 0.00 -250.50
catalog channel catalog_pageAAAAAAAALKPAAAAA 2395.69 0.00 -2898.62

# Q6

query I
SELECT a.ca_state state,
       count(*) cnt
FROM customer_address a ,
     customer c ,
     store_sales s ,
     date_dim d ,
     item i
WHERE a.ca_address_sk = c.c_current_addr_sk
  AND c.c_customer_sk = s.ss_customer_sk
  AND s.ss_sold_date_sk = d.d_date_sk
  AND s.ss_item_sk = i.i_item_sk
  AND d.d_month_seq =
    (SELECT DISTINCT (d_month_seq)
     FROM date_dim
     WHERE d_year = 2001
       AND d_moy = 1 )
  AND i.i_current_price > 1.2 *
    (SELECT avg(j.i_current_price)
     FROM item j
     WHERE j.i_category = i.i_category)
GROUP BY a.ca_state
HAVING count(*) >= 10
ORDER BY cnt NULLS FIRST,
         a.ca_state NULLS FIRST
LIMIT 100;
----
NC 12
VA 12

# Q7

query I
SELECT i_item_id,
       avg(ss_quantity) agg1,
       avg(ss_list_price) agg2,
       avg(ss_coupon_amt) agg3,
       avg(ss_sales_price) agg4
FROM store_sales,
     customer_demographics,
     date_dim,
     item,
     promotion
WHERE ss_sold_date_sk = d_date_sk
  AND ss_item_sk = i_item_sk
  AND ss_cdemo_sk = cd_demo_sk
  AND ss_promo_sk = p_promo_sk
  AND cd_gender = 'M'
  AND cd_marital_status = 'S'
  AND cd_education_status = 'College'
  AND (p_channel_email = 'N'
       OR p_channel_event = 'N')
  AND d_year = 2000
GROUP BY i_item_id
ORDER BY i_item_id
LIMIT 100;
----
AAAAAAAAABAAAAAA 20.0 120.65000000 0.00000000 10.85000000
AAAAAAAAACAAAAAA 39.0 134.44000000 0.00000000 34.07000000
AAAAAAAAAEAAAAAA 82.0 20.01000000 0.00000000 19.20000000
AAAAAAAAAKAAAAAA 17.0 79.04000000 0.00000000 38.72000000
AAAAAAAAALAAAAAA 7.0 143.17000000 0.00000000 124.55000000
AAAAAAAABAAAAAAA 69.0 112.61000000 0.00000000 83.33000000
AAAAAAAABDAAAAAA 32.0 81.55000000 0.00000000 61.16000000
AAAAAAAABGAAAAAA 26.0 97.02000000 0.00000000 51.42000000
AAAAAAAABJAAAAAA 59.0 105.49000000 0.00000000 73.84000000
AAAAAAAACAAAAAAA 75.0 1.85000000 0.00000000 1.77000000
AAAAAAAACDAAAAAA 11.0 117.58000000 0.00000000 37.62000000
AAAAAAAACFAAAAAA 97.0 119.93000000 1361.00000000 31.18000000
AAAAAAAACGAAAAAA 62.0 81.06000000 0.00000000 59.17000000
AAAAAAAACJAAAAAA 73.0 36.94500000 0.00000000 32.57000000
AAAAAAAACLAAAAAA 34.0 85.98000000 0.00000000 41.27000000
AAAAAAAADEAAAAAA 53.0 52.37000000 0.00000000 24.61000000
AAAAAAAADKAAAAAA 35.0 42.85500000 0.00000000 36.15500000
AAAAAAAAEDAAAAAA 96.0 27.30000000 0.00000000 15.83000000
AAAAAAAAEEAAAAAA 41.0 45.28000000 0.00000000 0.45000000
AAAAAAAAEGAAAAAA 78.0 29.19000000 0.00000000 14.01000000
AAAAAAAAEHAAAAAA 53.0 79.62000000 0.00000000 70.06000000
AAAAAAAAEJAAAAAA 49.0 23.28000000 27.85000000 1.16000000
AAAAAAAAEKAAAAAA 44.5 68.63000000 43.06500000 35.25500000
AAAAAAAAGBAAAAAA 31.0 93.14000000 831.42000000 29.80000000
AAAAAAAAGCAAAAAA 52.0 21.02000000 691.06000000 14.29000000
AAAAAAAAGKAAAAAA 53.5 46.49000000 0.00000000 32.18500000
AAAAAAAAHAAAAAAA 63.0 111.21000000 0.00000000 48.93000000
AAAAAAAAHDAAAAAA 84.0 68.70000000 0.00000000 13.05000000
AAAAAAAAHGAAAAAA 57.0 96.41000000 0.00000000 95.44000000
AAAAAAAAHJAAAAAA 58.0 56.05000000 0.00000000 4.48000000
AAAAAAAAICAAAAAA 34.0 160.21000000 0.00000000 1.60000000
AAAAAAAAIDAAAAAA 2.0 24.58000000 12.58000000 9.83000000
AAAAAAAAIFAAAAAA 18.0 90.88000000 0.00000000 84.51000000
AAAAAAAAIIAAAAAA 55.0 33.30666667 456.57333333 22.62666667
AAAAAAAAIJAAAAAA 34.0 64.02000000 0.00000000 12.16000000
AAAAAAAAJBAAAAAA 49.0 66.54000000 0.00000000 51.23000000
AAAAAAAAJEAAAAAA 90.0 38.92000000 0.00000000 28.41000000
AAAAAAAAJHAAAAAA 9.0 23.10000000 0.00000000 1.61000000
AAAAAAAAKBAAAAAA 99.0 125.38000000 0.00000000 119.11000000
AAAAAAAAKEAAAAAA 23.0 40.91000000 0.00000000 18.40000000
AAAAAAAAKJAAAAAA 27.5 90.58000000 9.71500000 67.17500000
AAAAAAAALCAAAAAA 24.0 38.51000000 0.00000000 10.39000000
AAAAAAAALIAAAAAA 88.0 64.56000000 0.00000000 58.10000000
AAAAAAAAMEAAAAAA 80.0 53.70000000 0.00000000 20.08500000
AAAAAAAAMFAAAAAA 48.666666666666664 78.86333333 0.00000000 29.83000000
AAAAAAAAMHAAAAAA 77.0 105.34000000 0.00000000 83.21000000
AAAAAAAAMIAAAAAA 51.0 50.09000000 0.00000000 4.00000000
AAAAAAAAMKAAAAAA 74.0 31.06000000 750.18000000 10.24000000
AAAAAAAANAAAAAAA 81.0 120.70000000 7337.09000000 114.66000000
AAAAAAAANDAAAAAA 22.0 83.14000000 0.00000000 5.81000000
AAAAAAAANGAAAAAA 73.0 79.15000000 0.00000000 9.49000000
AAAAAAAAOCAAAAAA 73.0 123.11500000 0.00000000 102.09000000
AAAAAAAAOFAAAAAA 100.0 84.32000000 0.00000000 75.04000000
AAAAAAAAOGAAAAAA 47.0 69.04000000 0.00000000 44.87000000
AAAAAAAAOIAAAAAA 56.5 88.10000000 0.00000000 50.81500000
AAAAAAAAOJAAAAAA 17.0 185.54000000 0.00000000 122.45000000
AAAAAAAAPBAAAAAA 5.0 108.12000000 0.00000000 16.21000000
AAAAAAAAPEAAAAAA 60.333333333333336 116.17666667 0.00000000 59.16666667
AAAAAAAAPHAAAAAA 55.0 81.22000000 0.00000000 26.34000000
AAAAAAAAPKAAAAAA 45.0 175.19000000 0.00000000 61.31000000


# Q8

query I
SELECT s_store_name,
       sum(ss_net_profit)
FROM store_sales,
     date_dim,
     store,
  (SELECT ca_zip
   FROM
     (SELECT SUBSTRING(ca_zip, 1, 5) ca_zip
      FROM customer_address
      WHERE SUBSTRING(ca_zip, 1, 5) IN ('24128',
                                     '76232',
                                     '65084',
                                     '87816',
                                     '83926',
                                     '77556',
                                     '20548',
                                     '26231',
                                     '43848',
                                     '15126',
                                     '91137',
                                     '61265',
                                     '98294',
                                     '25782',
                                     '17920',
                                     '18426',
                                     '98235',
                                     '40081',
                                     '84093',
                                     '28577',
                                     '55565',
                                     '17183',
                                     '54601',
                                     '67897',
                                     '22752',
                                     '86284',
                                     '18376',
                                     '38607',
                                     '45200',
                                     '21756',
                                     '29741',
                                     '96765',
                                     '23932',
                                     '89360',
                                     '29839',
                                     '25989',
                                     '28898',
                                     '91068',
                                     '72550',
                                     '10390',
                                     '18845',
                                     '47770',
                                     '82636',
                                     '41367',
                                     '76638',
                                     '86198',
                                     '81312',
                                     '37126',
                                     '39192',
                                     '88424',
                                     '72175',
                                     '81426',
                                     '53672',
                                     '10445',
                                     '42666',
                                     '66864',
                                     '66708',
                                     '41248',
                                     '48583',
                                     '82276',
                                     '18842',
                                     '78890',
                                     '49448',
                                     '14089',
                                     '38122',
                                     '34425',
                                     '79077',
                                     '19849',
                                     '43285',
                                     '39861',
                                     '66162',
                                     '77610',
                                     '13695',
                                     '99543',
                                     '83444',
                                     '83041',
                                     '12305',
                                     '57665',
                                     '68341',
                                     '25003',
                                     '57834',
                                     '62878',
                                     '49130',
                                     '81096',
                                     '18840',
                                     '27700',
                                     '23470',
                                     '50412',
                                     '21195',
                                     '16021',
                                     '76107',
                                     '71954',
                                     '68309',
                                     '18119',
                                     '98359',
                                     '64544',
                                     '10336',
                                     '86379',
                                     '27068',
                                     '39736',
                                     '98569',
                                     '28915',
                                     '24206',
                                     '56529',
                                     '57647',
                                     '54917',
                                     '42961',
                                     '91110',
                                     '63981',
                                     '14922',
                                     '36420',
                                     '23006',
                                     '67467',
                                     '32754',
                                     '30903',
                                     '20260',
                                     '31671',
                                     '51798',
                                     '72325',
                                     '85816',
                                     '68621',
                                     '13955',
                                     '36446',
                                     '41766',
                                     '68806',
                                     '16725',
                                     '15146',
                                     '22744',
                                     '35850',
                                     '88086',
                                     '51649',
                                     '18270',
                                     '52867',
                                     '39972',
                                     '96976',
                                     '63792',
                                     '11376',
                                     '94898',
                                     '13595',
                                     '10516',
                                     '90225',
                                     '58943',
                                     '39371',
                                     '94945',
                                     '28587',
                                     '96576',
                                     '57855',
                                     '28488',
                                     '26105',
                                     '83933',
                                     '25858',
                                     '34322',
                                     '44438',
                                     '73171',
                                     '30122',
                                     '34102',
                                     '22685',
                                     '71256',
                                     '78451',
                                     '54364',
                                     '13354',
                                     '45375',
                                     '40558',
                                     '56458',
                                     '28286',
                                     '45266',
                                     '47305',
                                     '69399',
                                     '83921',
                                     '26233',
                                     '11101',
                                     '15371',
                                     '69913',
                                     '35942',
                                     '15882',
                                     '25631',
                                     '24610',
                                     '44165',
                                     '99076',
                                     '33786',
                                     '70738',
                                     '26653',
                                     '14328',
                                     '72305',
                                     '62496',
                                     '22152',
                                     '10144',
                                     '64147',
                                     '48425',
                                     '14663',
                                     '21076',
                                     '18799',
                                     '30450',
                                     '63089',
                                     '81019',
                                     '68893',
                                     '24996',
                                     '51200',
                                     '51211',
                                     '45692',
                                     '92712',
                                     '70466',
                                     '79994',
                                     '22437',
                                     '25280',
                                     '38935',
                                     '71791',
                                     '73134',
                                     '56571',
                                     '14060',
                                     '19505',
                                     '72425',
                                     '56575',
                                     '74351',
                                     '68786',
                                     '51650',
                                     '20004',
                                     '18383',
                                     '76614',
                                     '11634',
                                     '18906',
                                     '15765',
                                     '41368',
                                     '73241',
                                     '76698',
                                     '78567',
                                     '97189',
                                     '28545',
                                     '76231',
                                     '75691',
                                     '22246',
                                     '51061',
                                     '90578',
                                     '56691',
                                     '68014',
                                     '51103',
                                     '94167',
                                     '57047',
                                     '14867',
                                     '73520',
                                     '15734',
                                     '63435',
                                     '25733',
                                     '35474',
                                     '24676',
                                     '94627',
                                     '53535',
                                     '17879',
                                     '15559',
                                     '53268',
                                     '59166',
                                     '11928',
                                     '59402',
                                     '33282',
                                     '45721',
                                     '43933',
                                     '68101',
                                     '33515',
                                     '36634',
                                     '71286',
                                     '19736',
                                     '58058',
                                     '55253',
                                     '67473',
                                     '41918',
                                     '19515',
                                     '36495',
                                     '19430',
                                     '22351',
                                     '77191',
                                     '91393',
                                     '49156',
                                     '50298',
                                     '87501',
                                     '18652',
                                     '53179',
                                     '18767',
                                     '63193',
                                     '23968',
                                     '65164',
                                     '68880',
                                     '21286',
                                     '72823',
                                     '58470',
                                     '67301',
                                     '13394',
                                     '31016',
                                     '70372',
                                     '67030',
                                     '40604',
                                     '24317',
                                     '45748',
                                     '39127',
                                     '26065',
                                     '77721',
                                     '31029',
                                     '31880',
                                     '60576',
                                     '24671',
                                     '45549',
                                     '13376',
                                     '50016',
                                     '33123',
                                     '19769',
                                     '22927',
                                     '97789',
                                     '46081',
                                     '72151',
                                     '15723',
                                     '46136',
                                     '51949',
                                     '68100',
                                     '96888',
                                     '64528',
                                     '14171',
                                     '79777',
                                     '28709',
                                     '11489',
                                     '25103',
                                     '32213',
                                     '78668',
                                     '22245',
                                     '15798',
                                     '27156',
                                     '37930',
                                     '62971',
                                     '21337',
                                     '51622',
                                     '67853',
                                     '10567',
                                     '38415',
                                     '15455',
                                     '58263',
                                     '42029',
                                     '60279',
                                     '37125',
                                     '56240',
                                     '88190',
                                     '50308',
                                     '26859',
                                     '64457',
                                     '89091',
                                     '82136',
                                     '62377',
                                     '36233',
                                     '63837',
                                     '58078',
                                     '17043',
                                     '30010',
                                     '60099',
                                     '28810',
                                     '98025',
                                     '29178',
                                     '87343',
                                     '73273',
                                     '30469',
                                     '64034',
                                     '39516',
                                     '86057',
                                     '21309',
                                     '90257',
                                     '67875',
                                     '40162',
                                     '11356',
                                     '73650',
                                     '61810',
                                     '72013',
                                     '30431',
                                     '22461',
                                     '19512',
                                     '13375',
                                     '55307',
                                     '30625',
                                     '83849',
                                     '68908',
                                     '26689',
                                     '96451',
                                     '38193',
                                     '46820',
                                     '88885',
                                     '84935',
                                     '69035',
                                     '83144',
                                     '47537',
                                     '56616',
                                     '94983',
                                     '48033',
                                     '69952',
                                     '25486',
                                     '61547',
                                     '27385',
                                     '61860',
                                     '58048',
                                     '56910',
                                     '16807',
                                     '17871',
                                     '35258',
                                     '31387',
                                     '35458',
                                     '35576') INTERSECT
        SELECT ca_zip
        FROM
          (SELECT SUBSTRING(ca_zip, 1, 5) ca_zip,
                  count(*) cnt
           FROM customer_address,
                customer
           WHERE ca_address_sk = c_current_addr_sk
             AND c_preferred_cust_flag='Y'
           GROUP BY ca_zip
           HAVING count(*) > 10)A1)A2) V1
WHERE ss_store_sk = s_store_sk
  AND ss_sold_date_sk = d_date_sk
  AND d_qoy = 2
  AND d_year = 1998
  AND (SUBSTRING(s_zip, 1, 2) = SUBSTRING(V1.ca_zip, 1, 2))
GROUP BY s_store_name
ORDER BY s_store_name
LIMIT 100;
----

# Q9

query I
SELECT CASE
           WHEN
                  (SELECT count(*)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 1 AND 20) > 74129 THEN
                  (SELECT avg(ss_ext_discount_amt)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 1 AND 20)
           ELSE
                  (SELECT avg(ss_net_paid)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 1 AND 20)
       END bucket1,
       CASE
           WHEN
                  (SELECT count(*)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 21 AND 40) > 122840 THEN
                  (SELECT avg(ss_ext_discount_amt)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 21 AND 40)
           ELSE
                  (SELECT avg(ss_net_paid)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 21 AND 40)
       END bucket2,
       CASE
           WHEN
                  (SELECT count(*)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 41 AND 60) > 56580 THEN
                  (SELECT avg(ss_ext_discount_amt)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 41 AND 60)
           ELSE
                  (SELECT avg(ss_net_paid)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 41 AND 60)
       END bucket3,
       CASE
           WHEN
                  (SELECT count(*)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 61 AND 80) > 10097 THEN
                  (SELECT avg(ss_ext_discount_amt)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 61 AND 80)
           ELSE
                  (SELECT avg(ss_net_paid)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 61 AND 80)
       END bucket4,
       CASE
           WHEN
                  (SELECT count(*)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 81 AND 100) > 165306 THEN
                  (SELECT avg(ss_ext_discount_amt)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 81 AND 100)
           ELSE
                  (SELECT avg(ss_net_paid)
                   FROM store_sales
                   WHERE ss_quantity BETWEEN 81 AND 100)
       END bucket5
FROM reason
WHERE r_reason_sk = 1 ;
----
362.00306254 1049.47549458 1712.05443883 2357.55806873 3100.35929556

# Q10

query I
SELECT cd_gender,
       cd_marital_status,
       cd_education_status,
       count(*) cnt1,
       cd_purchase_estimate,
       count(*) cnt2,
       cd_credit_rating,
       count(*) cnt3,
       cd_dep_count,
       count(*) cnt4,
       cd_dep_employed_count,
       count(*) cnt5,
       cd_dep_college_count,
       count(*) cnt6
FROM customer c,
     customer_address ca,
     customer_demographics
WHERE c.c_current_addr_sk = ca.ca_address_sk
  AND ca_county IN ('Rush County',
                    'Toole County',
                    'Jefferson County',
                    'Dona Ana County',
                    'La Porte County')
  AND cd_demo_sk = c.c_current_cdemo_sk
  AND EXISTS
    (SELECT *
     FROM store_sales,
          date_dim
     WHERE c.c_customer_sk = ss_customer_sk
       AND ss_sold_date_sk = d_date_sk
       AND d_year = 2002
       AND d_moy BETWEEN 1 AND 1+3)
  AND (EXISTS
         (SELECT *
          FROM web_sales,
               date_dim
          WHERE c.c_customer_sk = ws_bill_customer_sk
            AND ws_sold_date_sk = d_date_sk
            AND d_year = 2002
            AND d_moy BETWEEN 1 AND 1+3)
       OR EXISTS
         (SELECT *
          FROM catalog_sales,
               date_dim
          WHERE c.c_customer_sk = cs_ship_customer_sk
            AND cs_sold_date_sk = d_date_sk
            AND d_year = 2002
            AND d_moy BETWEEN 1 AND 1+3))
GROUP BY cd_gender,
         cd_marital_status,
         cd_education_status,
         cd_purchase_estimate,
         cd_credit_rating,
         cd_dep_count,
         cd_dep_employed_count,
         cd_dep_college_count
ORDER BY cd_gender,
         cd_marital_status,
         cd_education_status,
         cd_purchase_estimate,
         cd_credit_rating,
         cd_dep_count,
         cd_dep_employed_count,
         cd_dep_college_count
LIMIT 100;
----

# Q11

query I
WITH year_total AS
  (SELECT c_customer_id customer_id,
          c_first_name customer_first_name,
          c_last_name customer_last_name,
          c_preferred_cust_flag customer_preferred_cust_flag,
          c_birth_country customer_birth_country,
          c_login customer_login,
          c_email_address customer_email_address,
          d_year dyear,
          sum(ss_ext_list_price-ss_ext_discount_amt) year_total,
          's' sale_type
   FROM customer,
        store_sales,
        date_dim
   WHERE c_customer_sk = ss_customer_sk
     AND ss_sold_date_sk = d_date_sk
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            c_preferred_cust_flag,
            c_birth_country,
            c_login,
            c_email_address,
            d_year
   UNION ALL SELECT c_customer_id customer_id,
                    c_first_name customer_first_name,
                    c_last_name customer_last_name,
                    c_preferred_cust_flag customer_preferred_cust_flag,
                    c_birth_country customer_birth_country,
                    c_login customer_login,
                    c_email_address customer_email_address,
                    d_year dyear,
                    sum(ws_ext_list_price-ws_ext_discount_amt) year_total,
                    'w' sale_type
   FROM customer,
        web_sales,
        date_dim
   WHERE c_customer_sk = ws_bill_customer_sk
     AND ws_sold_date_sk = d_date_sk
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            c_preferred_cust_flag,
            c_birth_country,
            c_login,
            c_email_address,
            d_year)
SELECT t_s_secyear.customer_id,
       t_s_secyear.customer_first_name,
       t_s_secyear.customer_last_name,
       t_s_secyear.customer_preferred_cust_flag
FROM year_total t_s_firstyear,
     year_total t_s_secyear,
     year_total t_w_firstyear,
     year_total t_w_secyear
WHERE t_s_secyear.customer_id = t_s_firstyear.customer_id
  AND t_s_firstyear.customer_id = t_w_secyear.customer_id
  AND t_s_firstyear.customer_id = t_w_firstyear.customer_id
  AND t_s_firstyear.sale_type = 's'
  AND t_w_firstyear.sale_type = 'w'
  AND t_s_secyear.sale_type = 's'
  AND t_w_secyear.sale_type = 'w'
  AND t_s_firstyear.dyear = 2001
  AND t_s_secyear.dyear = 2001+1
  AND t_w_firstyear.dyear = 2001
  AND t_w_secyear.dyear = 2001+1
  AND t_s_firstyear.year_total > 0
  AND t_w_firstyear.year_total > 0
  AND CASE
          WHEN t_w_firstyear.year_total > 0 THEN (t_w_secyear.year_total*1.0000) / t_w_firstyear.year_total
          ELSE 0.0
      END > CASE
                WHEN t_s_firstyear.year_total > 0 THEN (t_s_secyear.year_total*1.0000) / t_s_firstyear.year_total
                ELSE 0.0
            END
ORDER BY t_s_secyear.customer_id NULLS FIRST,
         t_s_secyear.customer_first_name NULLS FIRST,
         t_s_secyear.customer_last_name NULLS FIRST,
         t_s_secyear.customer_preferred_cust_flag NULLS FIRST
LIMIT 100;
----

# Q12

query I
SELECT i_item_id,
       i_item_desc,
       i_category,
       i_class,
       i_current_price,
       sum(ws_ext_sales_price) AS itemrevenue,
       sum(ws_ext_sales_price)*100.0000/sum(sum(ws_ext_sales_price)) OVER (PARTITION BY i_class) AS revenueratio
FROM web_sales,
     item,
     date_dim
WHERE ws_item_sk = i_item_sk
  AND i_category IN ('Sports',
                     'Books',
                     'Home')
  AND ws_sold_date_sk = d_date_sk
  AND d_date BETWEEN cast('1999-02-22' AS date) AND cast('1999-03-24' AS date)
GROUP BY i_item_id,
         i_item_desc,
         i_category,
         i_class,
         i_current_price
ORDER BY i_category,
         i_class,
         i_item_id,
         i_item_desc,
         revenueratio
LIMIT 100;
----
AAAAAAAABGAAAAAA More reg Books fiction 57.09 577.44 20.982634384573
AAAAAAAALIAAAAAA Lines shall describe explicitly northern, firm systems. Later Books fiction 2.99 2174.55 79.017365615427
AAAAAAAAIGAAAAAA Connections must constitute only eastern leaves. Primary, elderly times make expectations. Never tory stores build very points. Books mystery 2.33 12229.28 100.000000000000
AAAAAAAABJAAAAAA Prospects know Books self-help 59.77 573.27 100.000000000000
AAAAAAAALCAAAAAA Resources shall not continue thus similar, practical results. Practical words f Books travel 6.08 64.65 2.357897040319
AAAAAAAAMEAAAAAA Original interests see of course british, important terms. Yet appropriate principles conclude in a arrangements; good countries would get sometimes;  Books travel 3.84 2677.20 97.642102959681
AAAAAAAAAIAAAAAA Great, tiny animals adopt then outcomes. Terms sweep less dry, physical signs. National, black terms adapt for a reasons; groups shall  Home curtains/drapes 4.06 803.88 100.000000000000
AAAAAAAADHAAAAAA Policies used to decrease social forms; well massive parts admire lacking, necessary cities. More rational areas deceive therefore only facilities. Yet persist Home furniture 2.68 228.20 100.000000000000
AAAAAAAAICAAAAAA Usually other children must stop shares. Relations Home lighting 9.93 3487.54 100.000000000000
AAAAAAAACIAAAAAA Final orders give else. International, living personnel may miss significant companies. Black, american numbers put then  Sports fishing 1.70 2250.40 62.846642351666
AAAAAAAAPBAAAAAA Bright advisers explain i Sports fishing 8.48 1330.38 37.153357648334
AAAAAAAAAEAAAAAA Public, annual h Sports optics 2.02 20.14 0.495522094282
AAAAAAAAMFAAAAAA New, quick observations merge too worth a children; shares could live there crucial mountains. Simply eastern pounds shall crush immediately married long wives. Corporate, import Sports optics 4.48 4044.26 99.504477905718
AAAAAAAAAKAAAAAA Legs cannot make much across a children. Well industrial ports see so. Equal, full systems rise police. Labour departments will leave. Political, social  Sports sailing 1.17 45.44 100.000000000000

# Q13

query I
SELECT avg(ss_quantity) avg1,
       avg(ss_ext_sales_price) avg2,
       avg(ss_ext_wholesale_cost) avg3,
       sum(ss_ext_wholesale_cost)
FROM store_sales ,
     store ,
     customer_demographics ,
     household_demographics ,
     customer_address ,
     date_dim
WHERE s_store_sk = ss_store_sk
  AND ss_sold_date_sk = d_date_sk
  AND d_year = 2001 and((ss_hdemo_sk=hd_demo_sk
                         AND cd_demo_sk = ss_cdemo_sk
                         AND cd_marital_status = 'M'
                         AND cd_education_status = 'Advanced Degree'
                         AND ss_sales_price BETWEEN 100.00 AND 150.00
                         AND hd_dep_count = 3)
                        OR (ss_hdemo_sk=hd_demo_sk
                            AND cd_demo_sk = ss_cdemo_sk
                            AND cd_marital_status = 'S'
                            AND cd_education_status = 'College'
                            AND ss_sales_price BETWEEN 50.00 AND 100.00
                            AND hd_dep_count = 1 )
                        OR (ss_hdemo_sk=hd_demo_sk
                            AND cd_demo_sk = ss_cdemo_sk
                            AND cd_marital_status = 'W'
                            AND cd_education_status = '2 yr Degree'
                            AND ss_sales_price BETWEEN 150.00 AND 200.00
                            AND hd_dep_count = 1)) and((ss_addr_sk = ca_address_sk
                                                        AND ca_country = 'United States'
                                                        AND ca_state IN ('TX', 'OH', 'TX')
                                                        AND ss_net_profit BETWEEN 100 AND 200)
                                                       OR (ss_addr_sk = ca_address_sk
                                                           AND ca_country = 'United States'
                                                           AND ca_state IN ('OR', 'NM', 'KY')
                                                           AND ss_net_profit BETWEEN 150 AND 300)
                                                       OR (ss_addr_sk = ca_address_sk
                                                           AND ca_country = 'United States'
                                                           AND ca_state IN ('VA', 'TX', 'MS')
                                                           AND ss_net_profit BETWEEN 50 AND 250)) ;
----
NULL NULL NULL NULL


# Q14
onlyif todo
query I
WITH cross_items AS
  (SELECT i_item_sk ss_item_sk
   FROM item,
     (SELECT iss.i_brand_id brand_id,
             iss.i_class_id class_id,
             iss.i_category_id category_id
      FROM store_sales,
           item iss,
           date_dim d1
      WHERE ss_item_sk = iss.i_item_sk
        AND ss_sold_date_sk = d1.d_date_sk
        AND d1.d_year BETWEEN 1999 AND 1999 + 2 INTERSECT
        SELECT ics.i_brand_id,
               ics.i_class_id,
               ics.i_category_id
        FROM catalog_sales,
             item ics,
             date_dim d2 WHERE cs_item_sk = ics.i_item_sk
        AND cs_sold_date_sk = d2.d_date_sk
        AND d2.d_year BETWEEN 1999 AND 1999 + 2 INTERSECT
        SELECT iws.i_brand_id,
               iws.i_class_id,
               iws.i_category_id
        FROM web_sales,
             item iws,
             date_dim d3 WHERE ws_item_sk = iws.i_item_sk
        AND ws_sold_date_sk = d3.d_date_sk
        AND d3.d_year BETWEEN 1999 AND 1999 + 2) sq1
   WHERE i_brand_id = brand_id
     AND i_class_id = class_id
     AND i_category_id = category_id ),
     avg_sales AS
  (SELECT avg(quantity*list_price) average_sales
   FROM
     (SELECT ss_quantity quantity,
             ss_list_price list_price
      FROM store_sales,
           date_dim
      WHERE ss_sold_date_sk = d_date_sk
        AND d_year BETWEEN 1999 AND 1999 + 2
      UNION ALL SELECT cs_quantity quantity,
                       cs_list_price list_price
      FROM catalog_sales,
           date_dim
      WHERE cs_sold_date_sk = d_date_sk
        AND d_year BETWEEN 1999 AND 1999 + 2
      UNION ALL SELECT ws_quantity quantity,
                       ws_list_price list_price
      FROM web_sales,
           date_dim
      WHERE ws_sold_date_sk = d_date_sk
        AND d_year BETWEEN 1999 AND 1999 + 2) sq2)
SELECT channel,
       i_brand_id,
       i_class_id,
       i_category_id,
       sum(sales) AS sum_sales,
       sum(number_sales) AS sum_number_sales
FROM
  (SELECT 'store' channel,
                  i_brand_id,
                  i_class_id,
                  i_category_id,
                  sum(ss_quantity*ss_list_price) sales,
                  count(*) number_sales
   FROM store_sales,
        item,
        date_dim
   WHERE ss_item_sk IN
       (SELECT ss_item_sk
        FROM cross_items)
     AND ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND d_year = 1999+2
     AND d_moy = 11
   GROUP BY i_brand_id,
            i_class_id,
            i_category_id
   HAVING sum(ss_quantity*ss_list_price) >
     (SELECT average_sales
      FROM avg_sales)
   UNION ALL SELECT 'catalog' channel,
                              i_brand_id,
                              i_class_id,
                              i_category_id,
                              sum(cs_quantity*cs_list_price) sales,
                              count(*) number_sales
   FROM catalog_sales,
        item,
        date_dim
   WHERE cs_item_sk IN
       (SELECT ss_item_sk
        FROM cross_items)
     AND cs_item_sk = i_item_sk
     AND cs_sold_date_sk = d_date_sk
     AND d_year = 1999+2
     AND d_moy = 11
   GROUP BY i_brand_id,
            i_class_id,
            i_category_id
   HAVING sum(cs_quantity*cs_list_price) >
     (SELECT average_sales
      FROM avg_sales)
   UNION ALL SELECT 'web' channel,
                          i_brand_id,
                          i_class_id,
                          i_category_id,
                          sum(ws_quantity*ws_list_price) sales,
                          count(*) number_sales
   FROM web_sales,
        item,
        date_dim
   WHERE ws_item_sk IN
       (SELECT ss_item_sk
        FROM cross_items)
     AND ws_item_sk = i_item_sk
     AND ws_sold_date_sk = d_date_sk
     AND d_year = 1999+2
     AND d_moy = 11
   GROUP BY i_brand_id,
            i_class_id,
            i_category_id
   HAVING sum(ws_quantity*ws_list_price) >
     (SELECT average_sales
      FROM avg_sales)) y
GROUP BY ROLLUP (channel,
                 i_brand_id,
                 i_class_id,
                 i_category_id)
ORDER BY channel NULLS FIRST,
         i_brand_id NULLS FIRST,
         i_class_id NULLS FIRST,
         i_category_id NULLS FIRST
LIMIT 100;
----
NULL NULL NULL NULL 5873545.32 1353
catalog NULL NULL NULL 813316.25 168
catalog 1002001 NULL NULL 38898.36 7
catalog 1002001 2 NULL 12226.90 3
catalog 1002001 2 6 12226.90 3
catalog 1002001 4 NULL 26671.46 4
catalog 1002001 4 5 26671.46 4
catalog 1002002 NULL NULL 6595.62 4
catalog 1002002 3 NULL 6595.62 4
catalog 1002002 3 1 6595.62 4
catalog 1004001 NULL NULL 11009.24 2
catalog 1004001 3 NULL 11009.24 2
catalog 1004001 3 5 11009.24 2
catalog 1004002 NULL NULL 55339.87 7
catalog 1004002 3 NULL 35712.07 3
catalog 1004002 3 1 35712.07 3
catalog 1004002 4 NULL 19627.80 4
catalog 1004002 4 1 19627.80 4
catalog 2001002 NULL NULL 12977.91 4
catalog 2001002 1 NULL 12977.91 4
catalog 2001002 1 2 12977.91 4
catalog 2002002 NULL NULL 18697.23 8
catalog 2002002 2 NULL 18697.23 8
catalog 2002002 2 2 18697.23 8
catalog 2003002 NULL NULL 5401.55 1
catalog 2003002 3 NULL 5401.55 1
catalog 2003002 3 2 5401.55 1
catalog 2004001 NULL NULL 53328.26 13
catalog 2004001 2 NULL 13088.08 3
catalog 2004001 2 1 6389.44 2
catalog 2004001 2 9 6698.64 1
catalog 2004001 4 NULL 21765.20 5
catalog 2004001 4 6 13842.35 4
catalog 2004001 4 10 7922.85 1
catalog 2004001 10 NULL 18474.98 5
catalog 2004001 10 6 18474.98 5
catalog 2004002 NULL NULL 45015.27 8
catalog 2004002 4 NULL 45015.27 8
catalog 2004002 4 2 45015.27 8
catalog 3001001 NULL NULL 15573.73 5
catalog 3001001 1 NULL 10534.64 3
catalog 3001001 1 2 10534.64 3
catalog 3001001 3 NULL 5039.09 2
catalog 3001001 3 10 5039.09 2
catalog 3002001 NULL NULL 11599.18 2
catalog 3002001 10 NULL 11599.18 2
catalog 3002001 10 10 11599.18 2
catalog 3003002 NULL NULL 11691.79 3
catalog 3003002 3 NULL 11691.79 3
catalog 3003002 3 3 11691.79 3
catalog 3004002 NULL NULL 23948.15 5
catalog 3004002 3 NULL 9333.48 1
catalog 3004002 3 3 9333.48 1
catalog 3004002 4 NULL 14614.67 4
catalog 3004002 4 3 14614.67 4
catalog 4002001 NULL NULL 17752.24 4
catalog 4002001 13 NULL 17752.24 4
catalog 4002001 13 9 17752.24 4
catalog 4002002 NULL NULL 7706.12 1
catalog 4002002 3 NULL 7706.12 1
catalog 4002002 3 4 7706.12 1
catalog 4003001 NULL NULL 14007.16 3
catalog 4003001 3 NULL 14007.16 3
catalog 4003001 3 10 14007.16 3
catalog 4004001 NULL NULL 28688.40 5
catalog 4004001 4 NULL 28688.40 5
catalog 4004001 4 6 28688.40 5
catalog 5002002 NULL NULL 16928.67 4
catalog 5002002 2 NULL 16928.67 4
catalog 5002002 2 5 16928.67 4
catalog 5003002 NULL NULL 21719.62 4
catalog 5003002 3 NULL 21719.62 4
catalog 5003002 3 5 21719.62 4
catalog 6004007 NULL NULL 13246.40 2
catalog 6004007 2 NULL 13246.40 2
catalog 6004007 2 2 13246.40 2
catalog 6007005 NULL NULL 12569.75 3
catalog 6007005 7 NULL 12569.75 3
catalog 6007005 7 5 12569.75 3
catalog 6011003 NULL NULL 17811.53 5
catalog 6011003 4 NULL 17811.53 5
catalog 6011003 4 5 17811.53 5
catalog 6015002 NULL NULL 14696.30 2
catalog 6015002 15 NULL 14696.30 2
catalog 6015002 15 6 14696.30 2
catalog 6016006 NULL NULL 31290.52 3
catalog 6016006 3 NULL 31290.52 3
catalog 6016006 3 6 31290.52 3
catalog 7003008 NULL NULL 29154.89 4
catalog 7003008 3 NULL 29154.89 4
catalog 7003008 3 7 29154.89 4
catalog 7008001 NULL NULL 5613.64 3
catalog 7008001 8 NULL 5613.64 3
catalog 7008001 8 3 5613.64 3
catalog 8004001 NULL NULL 18520.62 2
catalog 8004001 4 NULL 18520.62 2
catalog 8004001 4 5 18520.62 2
catalog 8007003 NULL NULL 5725.65 1
catalog 8007003 1 NULL 5725.65 1
catalog 8007003 1 2 5725.65 1

# Q15

query I
SELECT ca_zip,
       sum(cs_sales_price)
FROM catalog_sales,
     customer,
     customer_address,
     date_dim
WHERE cs_bill_customer_sk = c_customer_sk
  AND c_current_addr_sk = ca_address_sk
  AND (SUBSTRING(ca_zip, 1, 5) IN ('85669',
                                '86197',
                                '88274',
                                '83405',
                                '86475',
                                '85392',
                                '85460',
                                '80348',
                                '81792')
       OR ca_state IN ('CA',
                       'WA',
                       'GA')
       OR cs_sales_price > 500)
  AND cs_sold_date_sk = d_date_sk
  AND d_qoy = 2
  AND d_year = 2001
GROUP BY ca_zip
ORDER BY ca_zip NULLS FIRST
LIMIT 100;
----
30059 1432.92
30399 1676.44
34136 614.94
34593 820.50
35124 582.35
35804 146.12
98579 714.52

# Q16

query I
SELECT count(DISTINCT cs_order_number) AS "order count",
       sum(cs_ext_ship_cost) AS "total shipping cost",
       sum(cs_net_profit) AS "total net profit"
FROM catalog_sales cs1,
     date_dim,
     customer_address,
     call_center
WHERE d_date BETWEEN '2002-02-01' AND cast('2002-04-02' AS date)
  AND cs1.cs_ship_date_sk = d_date_sk
  AND cs1.cs_ship_addr_sk = ca_address_sk
  AND ca_state = 'GA'
  AND cs1.cs_call_center_sk = cc_call_center_sk
  AND cc_county = 'Williamson County'
  AND EXISTS
    (SELECT *
     FROM catalog_sales cs2
     WHERE cs1.cs_order_number = cs2.cs_order_number
       AND cs1.cs_warehouse_sk <> cs2.cs_warehouse_sk)
  AND NOT EXISTS
    (SELECT *
     FROM catalog_returns cr1
     WHERE cs1.cs_order_number = cr1.cr_order_number)
ORDER BY count(DISTINCT cs_order_number)
LIMIT 100;
----
0 NULL NULL

# Q17

query I
SELECT i_item_id,
       i_item_desc,
       s_state,
       count(ss_quantity) AS store_sales_quantitycount,
       avg(ss_quantity) AS store_sales_quantityave,
       stddev_samp(ss_quantity) AS store_sales_quantitystdev,
       stddev_samp(ss_quantity)/avg(ss_quantity) AS store_sales_quantitycov,
       count(sr_return_quantity) AS store_returns_quantitycount,
       avg(sr_return_quantity) AS store_returns_quantityave,
       stddev_samp(sr_return_quantity) AS store_returns_quantitystdev,
       stddev_samp(sr_return_quantity)/avg(sr_return_quantity) AS store_returns_quantitycov,
       count(cs_quantity) AS catalog_sales_quantitycount,
       avg(cs_quantity) AS catalog_sales_quantityave,
       stddev_samp(cs_quantity) AS catalog_sales_quantitystdev,
       stddev_samp(cs_quantity)/avg(cs_quantity) AS catalog_sales_quantitycov
FROM store_sales,
     store_returns,
     catalog_sales,
     date_dim d1,
     date_dim d2,
     date_dim d3,
     store,
     item
WHERE d1.d_quarter_name = '2001Q1'
  AND d1.d_date_sk = ss_sold_date_sk
  AND i_item_sk = ss_item_sk
  AND s_store_sk = ss_store_sk
  AND ss_customer_sk = sr_customer_sk
  AND ss_item_sk = sr_item_sk
  AND ss_ticket_number = sr_ticket_number
  AND sr_returned_date_sk = d2.d_date_sk
  AND d2.d_quarter_name IN ('2001Q1',
                            '2001Q2',
                            '2001Q3')
  AND sr_customer_sk = cs_bill_customer_sk
  AND sr_item_sk = cs_item_sk
  AND cs_sold_date_sk = d3.d_date_sk
  AND d3.d_quarter_name IN ('2001Q1',
                            '2001Q2',
                            '2001Q3')
GROUP BY i_item_id,
         i_item_desc,
         s_state
ORDER BY i_item_id NULLS FIRST,
         i_item_desc NULLS FIRST,
         s_state NULLS FIRST
LIMIT 100;
----
AAAAAAAAEDAAAAAA Total styles cannot assume companies. Cases may constitute shops. Local years meet still different, superb players. Delicate, peaceful  TN 1 2.0 NaN NaN 1 2.0 NaN NaN 1 42.0 NaN NaN
AAAAAAAAHGAAAAAA As short materials might go sometime new, tall skills. M TN 1 19.0 NaN NaN 1 1.0 NaN NaN 1 31.0 NaN NaN

# Q18

query I
SELECT i_item_id,
       ca_country,
       ca_state,
       ca_county,
       avg(cast(cs_quantity AS decimal(12, 2)))      agg1,
       avg(cast(cs_list_price AS decimal(12, 2)))    agg2,
       avg(cast(cs_coupon_amt AS decimal(12, 2)))    agg3,
       avg(cast(cs_sales_price AS decimal(12, 2)))   agg4,
       avg(cast(cs_net_profit AS decimal(12, 2)))    agg5,
       avg(cast(c_birth_year AS decimal(12, 2)))     agg6,
       avg(cast(cd1.cd_dep_count AS decimal(12, 2))) agg7
FROM catalog_sales,
     customer_demographics cd1,
     customer_demographics cd2,
     customer,
     customer_address,
     date_dim,
     item
WHERE cs_sold_date_sk = d_date_sk
  AND cs_item_sk = i_item_sk
  AND cs_bill_cdemo_sk = cd1.cd_demo_sk
  AND cs_bill_customer_sk = c_customer_sk
  AND cd1.cd_gender = 'F'
  AND cd1.cd_education_status = 'Unknown'
  AND c_current_cdemo_sk = cd2.cd_demo_sk
  AND c_current_addr_sk = ca_address_sk
  AND c_birth_month IN (1,
                        6,
                        8,
                        9,
                        12,
                        2)
  AND d_year = 1998
  AND ca_state IN ('MS',
                   'IN',
                   'ND',
                   'OK',
                   'NM',
                   'VA',
                   'MS')
GROUP BY ROLLUP (i_item_id,
    ca_country,
    ca_state,
    ca_county)
ORDER BY ca_country NULLS FIRST,
    ca_state NULLS FIRST,
    ca_county NULLS FIRST,
    i_item_id NULLS FIRST
LIMIT 100;
----
NULL NULL NULL NULL 47.18181818 89.21818182 81.57454545 32.26181818 -752.99363636 1970.27272727 1.54545455
AAAAAAAAAFAAAAAA NULL NULL NULL 15.00000000 85.79000000 0.00000000 10.29000000 -771.45000000 1953.00000000 2.00000000
AAAAAAAADHAAAAAA NULL NULL NULL 30.00000000 17.05000000 0.00000000 3.23000000 -190.50000000 1953.00000000 2.00000000
AAAAAAAADKAAAAAA NULL NULL NULL 40.00000000 43.24000000 0.00000000 23.34000000 -386.80000000 1991.00000000 1.00000000
AAAAAAAAFCAAAAAA NULL NULL NULL 91.00000000 30.03000000 394.55000000 11.41000000 -1910.61000000 1991.00000000 1.00000000
AAAAAAAAJBAAAAAA NULL NULL NULL 60.00000000 226.60000000 0.00000000 47.58000000 -1915.80000000 1953.00000000 2.00000000
AAAAAAAAJHAAAAAA NULL NULL NULL 62.00000000 75.51000000 0.00000000 24.91000000 -2002.60000000 1953.00000000 2.00000000
AAAAAAAAKDAAAAAA NULL NULL NULL 34.00000000 85.70000000 0.00000000 69.41000000 263.50000000 1953.00000000 2.00000000
AAAAAAAAMHAAAAAA NULL NULL NULL 22.00000000 203.34000000 0.00000000 63.03000000 -485.10000000 1991.00000000 1.00000000
AAAAAAAANJAAAAAA NULL NULL NULL 37.00000000 73.11000000 0.00000000 67.99000000 942.76000000 1953.00000000 2.00000000
AAAAAAAAPHAAAAAA NULL NULL NULL 76.00000000 31.39000000 502.77000000 10.67000000 -565.85000000 1991.00000000 1.00000000
AAAAAAAAPKAAAAAA NULL NULL NULL 52.00000000 109.64000000 0.00000000 23.02000000 -1260.48000000 1991.00000000 1.00000000
AAAAAAAAAFAAAAAA United States NULL NULL 15.00000000 85.79000000 0.00000000 10.29000000 -771.45000000 1953.00000000 2.00000000
AAAAAAAADHAAAAAA United States NULL NULL 30.00000000 17.05000000 0.00000000 3.23000000 -190.50000000 1953.00000000 2.00000000
AAAAAAAADKAAAAAA United States NULL NULL 40.00000000 43.24000000 0.00000000 23.34000000 -386.80000000 1991.00000000 1.00000000
AAAAAAAAFCAAAAAA United States NULL NULL 91.00000000 30.03000000 394.55000000 11.41000000 -1910.61000000 1991.00000000 1.00000000
AAAAAAAAJBAAAAAA United States NULL NULL 60.00000000 226.60000000 0.00000000 47.58000000 -1915.80000000 1953.00000000 2.00000000
AAAAAAAAJHAAAAAA United States NULL NULL 62.00000000 75.51000000 0.00000000 24.91000000 -2002.60000000 1953.00000000 2.00000000
AAAAAAAAKDAAAAAA United States NULL NULL 34.00000000 85.70000000 0.00000000 69.41000000 263.50000000 1953.00000000 2.00000000
AAAAAAAAMHAAAAAA United States NULL NULL 22.00000000 203.34000000 0.00000000 63.03000000 -485.10000000 1991.00000000 1.00000000
AAAAAAAANJAAAAAA United States NULL NULL 37.00000000 73.11000000 0.00000000 67.99000000 942.76000000 1953.00000000 2.00000000
AAAAAAAAPHAAAAAA United States NULL NULL 76.00000000 31.39000000 502.77000000 10.67000000 -565.85000000 1991.00000000 1.00000000
AAAAAAAAPKAAAAAA United States NULL NULL 52.00000000 109.64000000 0.00000000 23.02000000 -1260.48000000 1991.00000000 1.00000000
AAAAAAAAAFAAAAAA United States IN NULL 15.00000000 85.79000000 0.00000000 10.29000000 -771.45000000 1953.00000000 2.00000000
AAAAAAAADHAAAAAA United States IN NULL 30.00000000 17.05000000 0.00000000 3.23000000 -190.50000000 1953.00000000 2.00000000
AAAAAAAAJBAAAAAA United States IN NULL 60.00000000 226.60000000 0.00000000 47.58000000 -1915.80000000 1953.00000000 2.00000000
AAAAAAAAJHAAAAAA United States IN NULL 62.00000000 75.51000000 0.00000000 24.91000000 -2002.60000000 1953.00000000 2.00000000
AAAAAAAAKDAAAAAA United States IN NULL 34.00000000 85.70000000 0.00000000 69.41000000 263.50000000 1953.00000000 2.00000000
AAAAAAAANJAAAAAA United States IN NULL 37.00000000 73.11000000 0.00000000 67.99000000 942.76000000 1953.00000000 2.00000000
AAAAAAAAAFAAAAAA United States IN Switzerland County 15.00000000 85.79000000 0.00000000 10.29000000 -771.45000000 1953.00000000 2.00000000
AAAAAAAADHAAAAAA United States IN Switzerland County 30.00000000 17.05000000 0.00000000 3.23000000 -190.50000000 1953.00000000 2.00000000
AAAAAAAAJBAAAAAA United States IN Switzerland County 60.00000000 226.60000000 0.00000000 47.58000000 -1915.80000000 1953.00000000 2.00000000
AAAAAAAAJHAAAAAA United States IN Switzerland County 62.00000000 75.51000000 0.00000000 24.91000000 -2002.60000000 1953.00000000 2.00000000
AAAAAAAAKDAAAAAA United States IN Switzerland County 34.00000000 85.70000000 0.00000000 69.41000000 263.50000000 1953.00000000 2.00000000
AAAAAAAANJAAAAAA United States IN Switzerland County 37.00000000 73.11000000 0.00000000 67.99000000 942.76000000 1953.00000000 2.00000000
AAAAAAAADKAAAAAA United States MS NULL 40.00000000 43.24000000 0.00000000 23.34000000 -386.80000000 1991.00000000 1.00000000
AAAAAAAAFCAAAAAA United States MS NULL 91.00000000 30.03000000 394.55000000 11.41000000 -1910.61000000 1991.00000000 1.00000000
AAAAAAAAMHAAAAAA United States MS NULL 22.00000000 203.34000000 0.00000000 63.03000000 -485.10000000 1991.00000000 1.00000000
AAAAAAAAPHAAAAAA United States MS NULL 76.00000000 31.39000000 502.77000000 10.67000000 -565.85000000 1991.00000000 1.00000000
AAAAAAAAPKAAAAAA United States MS NULL 52.00000000 109.64000000 0.00000000 23.02000000 -1260.48000000 1991.00000000 1.00000000
AAAAAAAADKAAAAAA United States MS Panola County 40.00000000 43.24000000 0.00000000 23.34000000 -386.80000000 1991.00000000 1.00000000
AAAAAAAAFCAAAAAA United States MS Panola County 91.00000000 30.03000000 394.55000000 11.41000000 -1910.61000000 1991.00000000 1.00000000
AAAAAAAAMHAAAAAA United States MS Panola County 22.00000000 203.34000000 0.00000000 63.03000000 -485.10000000 1991.00000000 1.00000000
AAAAAAAAPHAAAAAA United States MS Panola County 76.00000000 31.39000000 502.77000000 10.67000000 -565.85000000 1991.00000000 1.00000000
AAAAAAAAPKAAAAAA United States MS Panola County 52.00000000 109.64000000 0.00000000 23.02000000 -1260.48000000 1991.00000000 1.00000000

# Q19

query I
SELECT i_brand_id brand_id,
       i_brand brand,
       i_manufact_id,
       i_manufact,
       sum(ss_ext_sales_price) ext_price
FROM date_dim,
     store_sales,
     item,
     customer,
     customer_address,
     store
WHERE d_date_sk = ss_sold_date_sk
  AND ss_item_sk = i_item_sk
  AND i_manager_id=8
  AND d_moy=11
  AND d_year=1998
  AND ss_customer_sk = c_customer_sk
  AND c_current_addr_sk = ca_address_sk
  AND SUBSTRING(ca_zip, 1, 5) <> SUBSTRING(s_zip, 1, 5)
  AND ss_store_sk = s_store_sk
GROUP BY i_brand,
         i_brand_id,
         i_manufact_id,
         i_manufact
ORDER BY ext_price DESC,
         i_brand,
         i_brand_id,
         i_manufact_id,
         i_manufact
LIMIT 100 ;
----

# Q20

query I
SELECT i_item_id ,
       i_item_desc,
       i_category,
       i_class,
       i_current_price ,
       sum(cs_ext_sales_price) AS itemrevenue,
       sum(cs_ext_sales_price)*100.0000/sum(sum(cs_ext_sales_price)) OVER (PARTITION BY i_class) AS revenueratio
FROM catalog_sales ,
     item,
     date_dim
WHERE cs_item_sk = i_item_sk
  AND i_category IN ('Sports',
                     'Books',
                     'Home')
  AND cs_sold_date_sk = d_date_sk
  AND d_date BETWEEN cast('1999-02-22' AS date) AND cast('1999-03-24' AS date)
GROUP BY i_item_id ,
         i_item_desc,
         i_category ,
         i_class ,
         i_current_price
ORDER BY i_category NULLS FIRST,
         i_class NULLS FIRST,
         i_item_id NULLS FIRST,
         i_item_desc NULLS FIRST,
         revenueratio NULLS FIRST
LIMIT 100;
----
AAAAAAAABGAAAAAA More reg Books fiction 57.09 12969.90 49.980077178774
AAAAAAAADEAAAAAA Already  Books fiction 1.47 11845.19 45.645957979417
AAAAAAAALIAAAAAA Lines shall describe explicitly northern, firm systems. Later Books fiction 2.99 1135.05 4.373964841808
AAAAAAAAIGAAAAAA Connections must constitute only eastern leaves. Primary, elderly times make expectations. Never tory stores build very points. Books mystery 2.33 7156.75 100.000000000000
AAAAAAAAKHAAAAAA Well lovely hands know even  Books parenting 2.62 8427.48 100.000000000000
AAAAAAAANJAAAAAA Recent performances get yet other publications; current patients could not carry comparatively intense, vital times. Wide problems smooth truly. Tomorrow used years catch a Books reference 2.21 25579.86 100.000000000000
AAAAAAAABJAAAAAA Prospects know Books self-help 59.77 615.92 5.426125076095
AAAAAAAAJHAAAAAA However increasing dates meet. Large, ready goals mean now blind structures. Crea Books self-help 38.79 10735.09 94.573874923905
AAAAAAAALCAAAAAA Resources shall not continue thus similar, practical results. Practical words f Books travel 6.08 40750.01 74.418721444676
AAAAAAAAMEAAAAAA Original interests see of course british, important terms. Yet appropriate principles conclude in a arrangements; good countries would get sometimes;  Books travel 3.84 14007.73 25.581278555324
AAAAAAAAACAAAAAA Ce Home curtains/drapes 1.77 7311.58 60.762584319993
AAAAAAAAAIAAAAAA Great, tiny animals adopt then outcomes. Terms sweep less dry, physical signs. National, black terms adapt for a reasons; groups shall  Home curtains/drapes 4.06 4721.45 39.237415680007
AAAAAAAADHAAAAAA Policies used to decrease social forms; well massive parts admire lacking, necessary cities. More rational areas deceive therefore only facilities. Yet persist Home furniture 2.68 3149.53 100.000000000000
AAAAAAAAPHAAAAAA High, black homes shall not greet also magnificent facts; inc, environmental areas say well howev Home kids 3.66 3092.75 100.000000000000
AAAAAAAAICAAAAAA Usually other children must stop shares. Relations Home lighting 9.93 1552.03 35.219858896360
AAAAAAAAOJAAAAAA Great, absent relations should participate alone wonderful issues; chains will care on behalf of a police. Substantial activities exert grey, free Home lighting 9.17 2854.66 64.780141103640
AAAAAAAANGAAAAAA Solutions may not go central, interesting sectors. Enterprises resist inte Home rugs 9.46 10907.48 100.000000000000
AAAAAAAAKKAAAAAA Important, glad rights change however. Only regular arms ought to operate in a minutes. Units fail quite like a centuries. Simply safe branches accompany major tenants;  Sports camping 1.65 1384.02 100.000000000000
AAAAAAAACIAAAAAA Final orders give else. International, living personnel may miss significant companies. Black, american numbers put then  Sports fishing 1.70 6924.44 100.000000000000
AAAAAAAAMKAAAAAA Automatic, black developments get thus new profits. Chemicals describe widely similar temperatures. Easy features used to emphasize different  Sports hockey 0.83 10869.87 81.200542339455
AAAAAAAAOAAAAAAA Important grounds rip there just big vehicles. Journalists w Sports hockey 1.85 2516.58 18.799457660545
AAAAAAAAMFAAAAAA New, quick observations merge too worth a children; shares could live there crucial mountains. Simply eastern pounds shall crush immediately married long wives. Corporate, import Sports optics 4.48 4287.88 100.000000000000
AAAAAAAACGAAAAAA Years know merely religious reasons. New animals modernise well racial pieces. Various, chi Sports outdoor 3.16 4585.36 100.000000000000
AAAAAAAAAKAAAAAA Legs cannot make much across a children. Well industrial ports see so. Equal, full systems rise police. Labour departments will leave. Political, social  Sports sailing 1.17 13646.97 100.000000000000

# Q21

query I
SELECT *
FROM
  (SELECT w_warehouse_name,
          i_item_id,
          sum(CASE
                  WHEN (cast(d_date AS date) < CAST ('2000-03-11' AS date)) THEN inv_quantity_on_hand
                  ELSE 0
              END) AS inv_before,
          sum(CASE
                  WHEN (cast(d_date AS date) >= CAST ('2000-03-11' AS date)) THEN inv_quantity_on_hand
                  ELSE 0
              END) AS inv_after
   FROM inventory,
        warehouse,
        item,
        date_dim
   WHERE i_current_price BETWEEN 0.99 AND 1.49
     AND i_item_sk = inv_item_sk
     AND inv_warehouse_sk = w_warehouse_sk
     AND inv_date_sk = d_date_sk
     AND d_date BETWEEN CAST ('2000-02-10' AS date) AND CAST ('2000-04-10' AS date)
   GROUP BY w_warehouse_name,
            i_item_id) x
WHERE (CASE
           WHEN inv_before > 0 THEN (inv_after*1.000) / inv_before
           ELSE NULL
       END) BETWEEN 2.000/3.000 AND 3.000/2.000
ORDER BY w_warehouse_name NULLS FIRST,
         i_item_id NULLS FIRST
LIMIT 100;
----
Conventional childr AAAAAAAACAAAAAAA 2128 3114
Conventional childr AAAAAAAAHDAAAAAA 2669 2348
Conventional childr AAAAAAAAKJAAAAAA 2735 2813
Conventional childr AAAAAAAAMBAAAAAA 2760 2626
Conventional childr AAAAAAAAPKAAAAAA 1839 2093

# Q22

query I
SELECT i_product_name ,
       i_brand ,
       i_class ,
       i_category ,
       avg(inv_quantity_on_hand) qoh
FROM inventory ,
     date_dim ,
     item
WHERE inv_date_sk=d_date_sk
  AND inv_item_sk=i_item_sk
  AND d_month_seq BETWEEN 1200 AND 1200 + 11
GROUP BY rollup(i_product_name ,i_brand ,i_class ,i_category)
ORDER BY qoh NULLS FIRST,
         i_product_name NULLS FIRST,
         i_brand NULLS FIRST,
         i_class NULLS FIRST,
         i_category NULLS FIRST
LIMIT 100;
----
ationn st NULL NULL NULL 416.4423076923077
ationn st scholarunivamalg #2 NULL NULL 416.4423076923077
ationn st scholarunivamalg #2 fiction NULL 416.4423076923077
ationn st scholarunivamalg #2 fiction Books 416.4423076923077
n steing NULL NULL NULL 430.13461538461536
n steing amalgimporto #2 NULL NULL 430.13461538461536
n steing amalgimporto #2 accessories NULL 430.13461538461536
n steing amalgimporto #2 accessories Men 430.13461538461536
oughtpri NULL NULL NULL 435.9807692307692
oughtpri scholarmaxi #2 NULL NULL 435.9807692307692
oughtpri scholarmaxi #2 fishing NULL 435.9807692307692
oughtpri scholarmaxi #2 fishing Sports 435.9807692307692
bareseought NULL NULL NULL 438.0769230769231
bareseought importoscholar #1 NULL NULL 438.0769230769231
bareseought importoscholar #1 country NULL 438.0769230769231
bareseought importoscholar #1 country Music 438.0769230769231
antieseought NULL NULL NULL 441.28846153846155
antieseought exportiunivamalg #2 NULL NULL 441.28846153846155
antieseought exportiunivamalg #2 self-help NULL 441.28846153846155
antieseought exportiunivamalg #2 self-help Books 441.28846153846155
oughtn st NULL NULL NULL 448.65384615384613
oughtn st corpunivamalg #7 NULL NULL 448.65384615384613
oughtn st corpunivamalg #7 musical NULL 448.65384615384613
oughtn st corpunivamalg #7 musical Electronics 448.65384615384613
oughtableought NULL NULL NULL 448.84615384615387
oughtableought exportiunivamalg #2 NULL NULL 448.84615384615387
oughtableought exportiunivamalg #2 self-help NULL 448.84615384615387
oughtableought exportiunivamalg #2 self-help Books 448.84615384615387
ablecally NULL NULL NULL 450.28846153846155
ablecally edu packcorp #7 NULL NULL 450.28846153846155
ablecally edu packcorp #7 bracelets NULL 450.28846153846155
ablecally edu packcorp #7 bracelets Jewelry 450.28846153846155
priation NULL NULL NULL 451.5192307692308
priation exportiamalg #2 NULL NULL 451.5192307692308
priation exportiamalg #2 maternity NULL 451.5192307692308
priation exportiamalg #2 maternity Women 451.5192307692308
n stese NULL NULL NULL 453.3269230769231
n stese edu packexporti #2 NULL NULL 453.3269230769231
n stese edu packexporti #2 school-uniforms NULL 453.3269230769231
n stese edu packexporti #2 school-uniforms Children 453.3269230769231
ationcallyought NULL NULL NULL 460.15384615384613
ationcallyought exporticorp #8 NULL NULL 460.15384615384613
ationcallyought exporticorp #8 gold NULL 460.15384615384613
ationcallyought exporticorp #8 gold Jewelry 460.15384615384613
pricallyought NULL NULL NULL 461.2692307692308
pricallyought edu packimporto #2 NULL NULL 461.2692307692308
pricallyought edu packimporto #2 sports-apparel NULL 461.2692307692308
pricallyought edu packimporto #2 sports-apparel Men 461.2692307692308
prioughtought NULL NULL NULL 461.9230769230769
prioughtought importomaxi #4 NULL NULL 461.9230769230769
prioughtought importomaxi #4 guns NULL 461.9230769230769
prioughtought importomaxi #4 guns Sports 461.9230769230769
bareing NULL NULL NULL 464.6923076923077
bareing exportiedu pack #1 NULL NULL 464.6923076923077
bareing exportiedu pack #1 kids NULL 464.6923076923077
bareing exportiedu pack #1 kids Shoes 464.6923076923077
ation NULL NULL NULL 465.0576923076923
ation amalgexporti #2 NULL NULL 465.0576923076923
ation amalgexporti #2 newborn NULL 465.0576923076923
ation amalgexporti #2 newborn Children 465.0576923076923
callyoughtought NULL NULL NULL 465.71153846153845
callyoughtought brandcorp #5 NULL NULL 465.71153846153845
callyoughtought brandcorp #5 pendants NULL 465.71153846153845
callyoughtought brandcorp #5 pendants Jewelry 465.71153846153845
baranti NULL NULL NULL 469.1923076923077
baranti edu packedu pack #1 NULL NULL 469.1923076923077
baranti edu packedu pack #1 athletic NULL 469.1923076923077
baranti edu packedu pack #1 athletic Shoes 469.1923076923077
prieing NULL NULL NULL 470.11538461538464
prieing brandcorp #4 NULL NULL 470.11538461538464
prieing brandcorp #4 pendants NULL 470.11538461538464
prieing brandcorp #4 pendants Jewelry 470.11538461538464
ationation NULL NULL NULL 470.3076923076923
ationation exportiexporti #2 NULL NULL 470.3076923076923
ationation exportiexporti #2 toddlers NULL 470.3076923076923
ationation exportiexporti #2 toddlers Children 470.3076923076923
callyanti NULL NULL NULL 470.6923076923077
callyanti amalgamalgamalg #6 NULL NULL 470.6923076923077
callyanti amalgamalgamalg #6 disk drives NULL 470.6923076923077
callyanti amalgamalgamalg #6 disk drives Electronics 470.6923076923077
n stcallyought NULL NULL NULL 471.03846153846155
n stcallyought amalgbrand #2 NULL NULL 471.03846153846155
n stcallyought amalgbrand #2 semi-precious NULL 471.03846153846155
n stcallyought amalgbrand #2 semi-precious Jewelry 471.03846153846155
n stoughtought NULL NULL NULL 471.0576923076923
n stoughtought edu packimporto #2 NULL NULL 471.0576923076923
n stoughtought edu packimporto #2 sports-apparel NULL 471.0576923076923
n stoughtought edu packimporto #2 sports-apparel Men 471.0576923076923
priought NULL NULL NULL 474.0
priought importobrand #6 NULL NULL 474.0
priought importobrand #6 costume NULL 474.0
priought importobrand #6 costume Jewelry 474.0
ablepri NULL NULL NULL 476.8269230769231
ablepri edu packbrand #3 NULL NULL 476.8269230769231
ablepri edu packbrand #3 curtains/drapes NULL 476.8269230769231
ablepri edu packbrand #3 curtains/drapes Home 476.8269230769231
priable NULL NULL NULL 478.46153846153845
priable scholarunivamalg #7 NULL NULL 478.46153846153845
priable scholarunivamalg #7 karoke NULL 478.46153846153845
priable scholarunivamalg #7 karoke Electronics 478.46153846153845

# Q23

query I
WITH frequent_ss_items AS
  (SELECT itemdesc,
          i_item_sk item_sk,
          d_date solddate,
          count(*) cnt
   FROM store_sales,
        date_dim,
     (SELECT SUBSTRING(i_item_desc, 1, 30) itemdesc,
             *
      FROM item) sq1
   WHERE ss_sold_date_sk = d_date_sk
     AND ss_item_sk = i_item_sk
     AND d_year IN (2000,
                    2000+1,
                    2000+2,
                    2000+3)
   GROUP BY itemdesc,
            i_item_sk,
            d_date
   HAVING count(*) >4),
     max_store_sales AS
  (SELECT max(csales) tpcds_cmax
   FROM
     (SELECT c_customer_sk,
             sum(ss_quantity*ss_sales_price) csales
      FROM store_sales,
           customer,
           date_dim
      WHERE ss_customer_sk = c_customer_sk
        AND ss_sold_date_sk = d_date_sk
        AND d_year IN (2000,
                       2000+1,
                       2000+2,
                       2000+3)
      GROUP BY c_customer_sk) sq2),
     best_ss_customer AS
  (SELECT c_customer_sk,
          sum(ss_quantity*ss_sales_price) ssales
   FROM store_sales,
        customer,
        max_store_sales
   WHERE ss_customer_sk = c_customer_sk
   GROUP BY c_customer_sk
   HAVING sum(ss_quantity*ss_sales_price) > (50/100.0) * max(tpcds_cmax))
SELECT c_last_name,
       c_first_name,
       sales
FROM
  (SELECT c_last_name,
          c_first_name,
          sum(cs_quantity*cs_list_price) sales
   FROM catalog_sales,
        customer,
        date_dim,
        frequent_ss_items,
        best_ss_customer
   WHERE d_year = 2000
     AND d_moy = 2
     AND cs_sold_date_sk = d_date_sk
     AND cs_item_sk = item_sk
     AND cs_bill_customer_sk = best_ss_customer.c_customer_sk
     AND cs_bill_customer_sk = customer.c_customer_sk
   GROUP BY c_last_name,
            c_first_name
   UNION ALL SELECT c_last_name,
                    c_first_name,
                    sum(ws_quantity*ws_list_price) sales
   FROM web_sales,
        customer,
        date_dim,
        frequent_ss_items,
        best_ss_customer
   WHERE d_year = 2000
     AND d_moy = 2
     AND ws_sold_date_sk = d_date_sk
     AND ws_item_sk = item_sk
     AND ws_bill_customer_sk = best_ss_customer.c_customer_sk
     AND ws_bill_customer_sk = customer.c_customer_sk
   GROUP BY c_last_name,
            c_first_name) sq3
ORDER BY c_last_name NULLS FIRST,
         c_first_name NULLS FIRST,
         sales NULLS FIRST
LIMIT 100;
----

# Q24

query I
WITH ssales AS
  (SELECT c_last_name,
          c_first_name,
          s_store_name,
          ca_state,
          s_state,
          i_color,
          i_current_price,
          i_manager_id,
          i_units,
          i_size,
          sum(ss_net_paid) netpaid
   FROM store_sales,
        store_returns,
        store,
        item,
        customer,
        customer_address
   WHERE ss_ticket_number = sr_ticket_number
     AND ss_item_sk = sr_item_sk
     AND ss_customer_sk = c_customer_sk
     AND ss_item_sk = i_item_sk
     AND ss_store_sk = s_store_sk
     AND c_current_addr_sk = ca_address_sk
     AND c_birth_country <> upper(ca_country)
     AND s_zip = ca_zip
     AND s_market_id=8
   GROUP BY c_last_name,
            c_first_name,
            s_store_name,
            ca_state,
            s_state,
            i_color,
            i_current_price,
            i_manager_id,
            i_units,
            i_size)
SELECT c_last_name,
       c_first_name,
       s_store_name,
       sum(netpaid) paid
FROM ssales
WHERE i_color = 'peach'
GROUP BY c_last_name,
         c_first_name,
         s_store_name
HAVING sum(netpaid) >
  (SELECT 0.05*avg(netpaid)
   FROM ssales)
ORDER BY c_last_name,
         c_first_name,
         s_store_name ;
----

# Q25

query I
SELECT i_item_id ,
       i_item_desc ,
       s_store_id ,
       s_store_name ,
       sum(ss_net_profit) AS store_sales_profit ,
       sum(sr_net_loss) AS store_returns_loss ,
       sum(cs_net_profit) AS catalog_sales_profit
FROM store_sales ,
     store_returns ,
     catalog_sales ,
     date_dim d1 ,
     date_dim d2 ,
     date_dim d3 ,
     store ,
     item
WHERE d1.d_moy = 4
  AND d1.d_year = 2001
  AND d1.d_date_sk = ss_sold_date_sk
  AND i_item_sk = ss_item_sk
  AND s_store_sk = ss_store_sk
  AND ss_customer_sk = sr_customer_sk
  AND ss_item_sk = sr_item_sk
  AND ss_ticket_number = sr_ticket_number
  AND sr_returned_date_sk = d2.d_date_sk
  AND d2.d_moy BETWEEN 4 AND 10
  AND d2.d_year = 2001
  AND sr_customer_sk = cs_bill_customer_sk
  AND sr_item_sk = cs_item_sk
  AND cs_sold_date_sk = d3.d_date_sk
  AND d3.d_moy BETWEEN 4 AND 10
  AND d3.d_year = 2001
GROUP BY i_item_id ,
         i_item_desc ,
         s_store_id ,
         s_store_name
ORDER BY i_item_id ,
         i_item_desc ,
         s_store_id ,
         s_store_name
LIMIT 100;
----

# Q26

query I
SELECT i_item_id,
       avg(cs_quantity) agg1,
       avg(cs_list_price) agg2,
       avg(cs_coupon_amt) agg3,
       avg(cs_sales_price) agg4
FROM catalog_sales,
     customer_demographics,
     date_dim,
     item,
     promotion
WHERE cs_sold_date_sk = d_date_sk
  AND cs_item_sk = i_item_sk
  AND cs_bill_cdemo_sk = cd_demo_sk
  AND cs_promo_sk = p_promo_sk
  AND cd_gender = 'M'
  AND cd_marital_status = 'S'
  AND cd_education_status = 'College'
  AND (p_channel_email = 'N'
       OR p_channel_event = 'N')
  AND d_year = 2000
GROUP BY i_item_id
ORDER BY i_item_id
LIMIT 100;
----
AAAAAAAAALAAAAAA 1.0 58.96000000 0.00000000 12.38000000
AAAAAAAABAAAAAAA 44.0 112.68000000 0.00000000 52.95000000
AAAAAAAACAAAAAAA 70.5 39.49000000 0.00000000 11.60500000
AAAAAAAACDAAAAAA 7.0 140.11000000 0.00000000 56.04000000
AAAAAAAACFAAAAAA 6.0 78.52000000 0.00000000 4.71000000
AAAAAAAACLAAAAAA 4.0 122.55000000 0.00000000 80.88000000
AAAAAAAADEAAAAAA 37.0 19.42000000 0.00000000 5.04000000
AAAAAAAADKAAAAAA 27.5 44.49000000 5.48500000 24.43000000
AAAAAAAAEAAAAAAA 55.5 165.90500000 0.00000000 75.65000000
AAAAAAAAEBAAAAAA 11.0 60.20000000 0.00000000 8.42000000
AAAAAAAAEDAAAAAA 70.0 102.32000000 0.00000000 82.87000000
AAAAAAAAEEAAAAAA 47.0 56.22000000 0.00000000 1.12000000
AAAAAAAAFCAAAAAA 61.5 106.28000000 0.00000000 37.52500000
AAAAAAAAFFAAAAAA 37.0 27.65000000 0.00000000 27.65000000
AAAAAAAAGBAAAAAA 71.0 212.35000000 0.00000000 114.66000000
AAAAAAAAHAAAAAAA 45.0 29.86000000 155.16000000 16.42000000
AAAAAAAAHDAAAAAA 61.0 210.83000000 0.00000000 137.03000000
AAAAAAAAHGAAAAAA 100.0 127.90000000 0.00000000 28.13000000
AAAAAAAAKAAAAAAA 43.0 146.88000000 0.00000000 96.94000000
AAAAAAAAKEAAAAAA 36.0 219.29000000 0.00000000 203.93000000
AAAAAAAAKGAAAAAA 58.0 110.28000000 0.00000000 26.46000000
AAAAAAAAKHAAAAAA 31.0 117.68500000 1013.29000000 101.64500000
AAAAAAAAKJAAAAAA 47.0 156.03000000 0.00000000 106.10000000
AAAAAAAAMBAAAAAA 59.0 53.10000000 0.00000000 13.27000000
AAAAAAAAMEAAAAAA 13.0 35.19000000 0.00000000 20.41000000
AAAAAAAAMHAAAAAA 36.5 138.32000000 0.00000000 77.21500000
AAAAAAAANDAAAAAA 77.0 117.72000000 0.00000000 100.06000000
AAAAAAAAOFAAAAAA 28.0 48.42000000 278.18000000 17.43000000
AAAAAAAAPHAAAAAA 39.5 46.83000000 0.00000000 8.65000000
AAAAAAAAPKAAAAAA 21.0 119.99500000 24.33500000 32.80500000

# Q27

query I
WITH results AS
  (SELECT i_item_id,
          s_state,
          0 AS g_state,
          ss_quantity agg1,
          ss_list_price agg2,
          ss_coupon_amt agg3,
          ss_sales_price agg4
   FROM store_sales,
        customer_demographics,
        date_dim,
        store,
        item
   WHERE ss_sold_date_sk = d_date_sk
     AND ss_item_sk = i_item_sk
     AND ss_store_sk = s_store_sk
     AND ss_cdemo_sk = cd_demo_sk
     AND cd_gender = 'M'
     AND cd_marital_status = 'S'
     AND cd_education_status = 'College'
     AND d_year = 2002
     AND s_state = 'TN' )
SELECT i_item_id,
       s_state,
       g_state,
       agg1,
       agg2,
       agg3,
       agg4
FROM
  ( SELECT i_item_id,
           s_state,
           0 AS g_state,
           avg(agg1) agg1,
           avg(agg2) agg2,
           avg(agg3) agg3,
           avg(agg4) agg4
   FROM results
   GROUP BY i_item_id ,
            s_state
   UNION ALL SELECT i_item_id,
                    NULL AS s_state,
                    1 AS g_state,
                    avg(agg1) agg1,
                    avg(agg2) agg2,
                    avg(agg3) agg3,
                    avg(agg4) agg4
   FROM results
   GROUP BY i_item_id
   UNION ALL SELECT NULL AS i_item_id,
                    NULL AS s_state,
                    1 AS g_state,
                    avg(agg1) agg1,
                    avg(agg2) agg2,
                    avg(agg3) agg3,
                    avg(agg4) agg4
   FROM results ) foo
ORDER BY i_item_id NULLS FIRST,
         s_state NULLS FIRST
LIMIT 100;
----
NULL NULL 1 51.535714285714285 81.57047619 241.29547619 42.32321429
AAAAAAAAACAAAAAA NULL 1 54.0 107.97000000 0.00000000 0.00000000
AAAAAAAAACAAAAAA TN 0 54.0 107.97000000 0.00000000 0.00000000
AAAAAAAAAEAAAAAA NULL 1 91.0 63.95000000 0.00000000 14.06000000
AAAAAAAAAEAAAAAA TN 0 91.0 63.95000000 0.00000000 14.06000000
AAAAAAAAAHAAAAAA NULL 1 66.5 59.53500000 2542.45000000 47.70000000
AAAAAAAAAHAAAAAA TN 0 66.5 59.53500000 2542.45000000 47.70000000
AAAAAAAAAIAAAAAA NULL 1 75.0 124.31000000 2580.60000000 74.86500000
AAAAAAAAAIAAAAAA TN 0 75.0 124.31000000 2580.60000000 74.86500000
AAAAAAAAAKAAAAAA NULL 1 36.0 68.50333333 0.00000000 50.50333333
AAAAAAAAAKAAAAAA TN 0 36.0 68.50333333 0.00000000 50.50333333
AAAAAAAAALAAAAAA NULL 1 85.0 25.24000000 0.00000000 3.53000000
AAAAAAAAALAAAAAA TN 0 85.0 25.24000000 0.00000000 3.53000000
AAAAAAAACCAAAAAA NULL 1 40.0 90.50500000 365.38000000 23.32500000
AAAAAAAACCAAAAAA TN 0 40.0 90.50500000 365.38000000 23.32500000
AAAAAAAACDAAAAAA NULL 1 22.666666666666668 167.21000000 189.36000000 123.85000000
AAAAAAAACDAAAAAA TN 0 22.666666666666668 167.21000000 189.36000000 123.85000000
AAAAAAAACFAAAAAA NULL 1 93.0 99.48000000 0.00000000 38.79000000
AAAAAAAACFAAAAAA TN 0 93.0 99.48000000 0.00000000 38.79000000
AAAAAAAACIAAAAAA NULL 1 44.0 96.88333333 0.00000000 66.72666667
AAAAAAAACIAAAAAA TN 0 44.0 96.88333333 0.00000000 66.72666667
AAAAAAAACJAAAAAA NULL 1 23.0 103.96000000 0.00000000 35.17500000
AAAAAAAACJAAAAAA TN 0 23.0 103.96000000 0.00000000 35.17500000
AAAAAAAACLAAAAAA NULL 1 1.0 99.21000000 0.00000000 23.81000000
AAAAAAAACLAAAAAA TN 0 1.0 99.21000000 0.00000000 23.81000000
AAAAAAAADBAAAAAA NULL 1 2.0 59.54000000 0.00000000 57.75000000
AAAAAAAADBAAAAAA TN 0 2.0 59.54000000 0.00000000 57.75000000
AAAAAAAADEAAAAAA NULL 1 20.666666666666668 50.21000000 2.52333333 16.22333333
AAAAAAAADEAAAAAA TN 0 20.666666666666668 50.21000000 2.52333333 16.22333333
AAAAAAAADHAAAAAA NULL 1 54.0 72.46000000 0.00000000 23.18000000
AAAAAAAADHAAAAAA TN 0 54.0 72.46000000 0.00000000 23.18000000
AAAAAAAADKAAAAAA NULL 1 57.0 116.65000000 0.00000000 116.65000000
AAAAAAAADKAAAAAA TN 0 57.0 116.65000000 0.00000000 116.65000000
AAAAAAAAEAAAAAAA NULL 1 96.0 18.88000000 0.00000000 0.18000000
AAAAAAAAEAAAAAAA TN 0 96.0 18.88000000 0.00000000 0.18000000
AAAAAAAAEBAAAAAA NULL 1 89.0 72.02000000 198.64000000 3.60000000
AAAAAAAAEBAAAAAA TN 0 89.0 72.02000000 198.64000000 3.60000000
AAAAAAAAEEAAAAAA NULL 1 65.66666666666667 72.09666667 0.00000000 36.22000000
AAAAAAAAEEAAAAAA TN 0 65.66666666666667 72.09666667 0.00000000 36.22000000
AAAAAAAAEHAAAAAA NULL 1 47.0 103.80500000 0.00000000 50.52500000
AAAAAAAAEHAAAAAA TN 0 47.0 103.80500000 0.00000000 50.52500000
AAAAAAAAEJAAAAAA NULL 1 41.5 74.63500000 148.83000000 21.26000000
AAAAAAAAEJAAAAAA TN 0 41.5 74.63500000 148.83000000 21.26000000
AAAAAAAAEKAAAAAA NULL 1 53.0 78.36000000 0.00000000 13.32000000
AAAAAAAAEKAAAAAA TN 0 53.0 78.36000000 0.00000000 13.32000000
AAAAAAAAFCAAAAAA NULL 1 58.0 31.99666667 0.80333333 8.70666667
AAAAAAAAFCAAAAAA TN 0 58.0 31.99666667 0.80333333 8.70666667
AAAAAAAAFIAAAAAA NULL 1 61.5 106.53000000 0.00000000 38.92000000
AAAAAAAAFIAAAAAA TN 0 61.5 106.53000000 0.00000000 38.92000000
AAAAAAAAGCAAAAAA NULL 1 96.0 68.02000000 0.00000000 14.28000000
AAAAAAAAGCAAAAAA TN 0 96.0 68.02000000 0.00000000 14.28000000
AAAAAAAAGHAAAAAA NULL 1 89.0 68.05000000 499.29000000 7.48000000
AAAAAAAAGHAAAAAA TN 0 89.0 68.05000000 499.29000000 7.48000000
AAAAAAAAHDAAAAAA NULL 1 62.0 93.63000000 0.00000000 3.74000000
AAAAAAAAHDAAAAAA TN 0 62.0 93.63000000 0.00000000 3.74000000
AAAAAAAAHJAAAAAA NULL 1 76.33333333333333 88.60333333 471.82666667 40.75000000
AAAAAAAAHJAAAAAA TN 0 76.33333333333333 88.60333333 471.82666667 40.75000000
AAAAAAAAIAAAAAAA NULL 1 63.0 89.88000000 0.00000000 70.10000000
AAAAAAAAIAAAAAAA TN 0 63.0 89.88000000 0.00000000 70.10000000
AAAAAAAAICAAAAAA NULL 1 9.0 84.66000000 0.00000000 11.85000000
AAAAAAAAICAAAAAA TN 0 9.0 84.66000000 0.00000000 11.85000000
AAAAAAAAIDAAAAAA NULL 1 87.0 9.48000000 0.00000000 7.20000000
AAAAAAAAIDAAAAAA TN 0 87.0 9.48000000 0.00000000 7.20000000
AAAAAAAAIGAAAAAA NULL 1 66.0 23.59000000 0.00000000 11.08000000
AAAAAAAAIGAAAAAA TN 0 66.0 23.59000000 0.00000000 11.08000000
AAAAAAAAIIAAAAAA NULL 1 20.0 68.85000000 0.00000000 53.70000000
AAAAAAAAIIAAAAAA TN 0 20.0 68.85000000 0.00000000 53.70000000
AAAAAAAAJKAAAAAA NULL 1 97.0 39.45000000 0.00000000 24.06000000
AAAAAAAAJKAAAAAA TN 0 97.0 39.45000000 0.00000000 24.06000000
AAAAAAAAKAAAAAAA NULL 1 56.0 64.04000000 0.00000000 61.47000000
AAAAAAAAKAAAAAAA TN 0 56.0 64.04000000 0.00000000 61.47000000
AAAAAAAAKDAAAAAA NULL 1 36.0 31.77000000 0.00000000 30.18000000
AAAAAAAAKDAAAAAA TN 0 36.0 31.77000000 0.00000000 30.18000000
AAAAAAAALCAAAAAA NULL 1 34.0 147.08000000 1912.65000000 125.01000000
AAAAAAAALCAAAAAA TN 0 34.0 147.08000000 1912.65000000 125.01000000
AAAAAAAAMBAAAAAA NULL 1 60.0 71.13000000 0.00000000 11.38000000
AAAAAAAAMBAAAAAA TN 0 60.0 71.13000000 0.00000000 11.38000000
AAAAAAAAMCAAAAAA NULL 1 55.666666666666664 38.22333333 436.18666667 21.22666667
AAAAAAAAMCAAAAAA TN 0 55.666666666666664 38.22333333 436.18666667 21.22666667
AAAAAAAAMEAAAAAA NULL 1 55.5 150.41000000 0.00000000 107.43500000
AAAAAAAAMEAAAAAA TN 0 55.5 150.41000000 0.00000000 107.43500000
AAAAAAAAMFAAAAAA NULL 1 10.0 97.69000000 0.00000000 93.78000000
AAAAAAAAMFAAAAAA TN 0 10.0 97.69000000 0.00000000 93.78000000
AAAAAAAAMHAAAAAA NULL 1 48.0 59.96500000 0.00000000 15.91000000
AAAAAAAAMHAAAAAA TN 0 48.0 59.96500000 0.00000000 15.91000000
AAAAAAAANAAAAAAA NULL 1 65.5 70.54000000 0.00000000 68.42000000
AAAAAAAANAAAAAAA TN 0 65.5 70.54000000 0.00000000 68.42000000
AAAAAAAANDAAAAAA NULL 1 88.0 162.72000000 0.00000000 60.20000000
AAAAAAAANDAAAAAA TN 0 88.0 162.72000000 0.00000000 60.20000000
AAAAAAAANGAAAAAA NULL 1 27.666666666666668 92.24666667 201.94333333 78.62000000
AAAAAAAANGAAAAAA TN 0 27.666666666666668 92.24666667 201.94333333 78.62000000
AAAAAAAAOAAAAAAA NULL 1 6.0 22.97000000 0.00000000 12.86000000
AAAAAAAAOAAAAAAA TN 0 6.0 22.97000000 0.00000000 12.86000000
AAAAAAAAOCAAAAAA NULL 1 76.0 50.88000000 0.00000000 30.01000000
AAAAAAAAOCAAAAAA TN 0 76.0 50.88000000 0.00000000 30.01000000
AAAAAAAAODAAAAAA NULL 1 26.0 100.08500000 0.00000000 73.23500000
AAAAAAAAODAAAAAA TN 0 26.0 100.08500000 0.00000000 73.23500000
AAAAAAAAOFAAAAAA NULL 1 68.0 94.62000000 2432.08000000 39.74000000
AAAAAAAAOFAAAAAA TN 0 68.0 94.62000000 2432.08000000 39.74000000
AAAAAAAAOIAAAAAA NULL 1 17.0 25.93000000 0.00000000 23.59000000

# Q28

query I
SELECT *
FROM
  (SELECT avg(ss_list_price) B1_LP,
          count(ss_list_price) B1_CNT,
          count(DISTINCT ss_list_price) B1_CNTD
   FROM store_sales
   WHERE ss_quantity BETWEEN 0 AND 5
     AND (ss_list_price BETWEEN 8 AND 8+10
          OR ss_coupon_amt BETWEEN 459 AND 459+1000
          OR ss_wholesale_cost BETWEEN 57 AND 57+20)) B1,
  (SELECT avg(ss_list_price) B2_LP,
          count(ss_list_price) B2_CNT,
          count(DISTINCT ss_list_price) B2_CNTD
   FROM store_sales
   WHERE ss_quantity BETWEEN 6 AND 10
     AND (ss_list_price BETWEEN 90 AND 90+10
          OR ss_coupon_amt BETWEEN 2323 AND 2323+1000
          OR ss_wholesale_cost BETWEEN 31 AND 31+20)) B2,
  (SELECT avg(ss_list_price) B3_LP,
          count(ss_list_price) B3_CNT,
          count(DISTINCT ss_list_price) B3_CNTD
   FROM store_sales
   WHERE ss_quantity BETWEEN 11 AND 15
     AND (ss_list_price BETWEEN 142 AND 142+10
          OR ss_coupon_amt BETWEEN 12214 AND 12214+1000
          OR ss_wholesale_cost BETWEEN 79 AND 79+20)) B3,
  (SELECT avg(ss_list_price) B4_LP,
          count(ss_list_price) B4_CNT,
          count(DISTINCT ss_list_price) B4_CNTD
   FROM store_sales
   WHERE ss_quantity BETWEEN 16 AND 20
     AND (ss_list_price BETWEEN 135 AND 135+10
          OR ss_coupon_amt BETWEEN 6071 AND 6071+1000
          OR ss_wholesale_cost BETWEEN 38 AND 38+20)) B4,
  (SELECT avg(ss_list_price) B5_LP,
          count(ss_list_price) B5_CNT,
          count(DISTINCT ss_list_price) B5_CNTD
   FROM store_sales
   WHERE ss_quantity BETWEEN 21 AND 25
     AND (ss_list_price BETWEEN 122 AND 122+10
          OR ss_coupon_amt BETWEEN 836 AND 836+1000
          OR ss_wholesale_cost BETWEEN 17 AND 17+20)) B5,
  (SELECT avg(ss_list_price) B6_LP,
          count(ss_list_price) B6_CNT,
          count(DISTINCT ss_list_price) B6_CNTD
   FROM store_sales
   WHERE ss_quantity BETWEEN 26 AND 30
     AND (ss_list_price BETWEEN 154 AND 154+10
          OR ss_coupon_amt BETWEEN 7326 AND 7326+1000
          OR ss_wholesale_cost BETWEEN 7 AND 7+20)) B6
LIMIT 100;
----
76.54373239 426 416 70.37091146 384 368 134.18640845 284 279 82.53203593 334 328 56.61865435 379 370 39.32738994 318 311


# Q29

query I
SELECT i_item_id,
       i_item_desc,
       s_store_id,
       s_store_name,
       sum(ss_quantity) AS store_sales_quantity,
       sum(sr_return_quantity) AS store_returns_quantity,
       sum(cs_quantity) AS catalog_sales_quantity
FROM store_sales,
     store_returns,
     catalog_sales,
     date_dim d1,
     date_dim d2,
     date_dim d3,
     store,
     item
WHERE d1.d_moy = 9
  AND d1.d_year = 1999
  AND d1.d_date_sk = ss_sold_date_sk
  AND i_item_sk = ss_item_sk
  AND s_store_sk = ss_store_sk
  AND ss_customer_sk = sr_customer_sk
  AND ss_item_sk = sr_item_sk
  AND ss_ticket_number = sr_ticket_number
  AND sr_returned_date_sk = d2.d_date_sk
  AND d2.d_moy BETWEEN 9 AND 9 + 3
  AND d2.d_year = 1999
  AND sr_customer_sk = cs_bill_customer_sk
  AND sr_item_sk = cs_item_sk
  AND cs_sold_date_sk = d3.d_date_sk
  AND d3.d_year IN (1999,
                    1999+1,
                    1999+2)
GROUP BY i_item_id,
         i_item_desc,
         s_store_id,
         s_store_name
ORDER BY i_item_id,
         i_item_desc,
         s_store_id,
         s_store_name
LIMIT 100;
----
AAAAAAAAACAAAAAA Ce AAAAAAAABAAAAAAA ought 57 44 71
AAAAAAAACLAAAAAA Eyes appreciate political yards. Constant, awful eyes could c AAAAAAAABAAAAAAA ought 64 32 29
AAAAAAAAOGAAAAAA Single, possible causes cut more strange, british things; forms create other, loyal thousands. As real scheme AAAAAAAABAAAAAAA ought 47 15 7


# Q30

query I
WITH customer_total_return AS
  (SELECT wr_returning_customer_sk AS ctr_customer_sk,
          ca_state AS ctr_state,
          sum(wr_return_amt) AS ctr_total_return
   FROM web_returns,
        date_dim,
        customer_address
   WHERE wr_returned_date_sk = d_date_sk
     AND d_year = 2002
     AND wr_returning_addr_sk = ca_address_sk
   GROUP BY wr_returning_customer_sk,
            ca_state)
SELECT c_customer_id,
       c_salutation,
       c_first_name,
       c_last_name,
       c_preferred_cust_flag,
       c_birth_day,
       c_birth_month,
       c_birth_year,
       c_birth_country,
       c_login,
       c_email_address,
       c_last_review_date_sk,
       ctr_total_return
FROM customer_total_return ctr1,
     customer_address,
     customer
WHERE ctr1.ctr_total_return >
    (SELECT avg(ctr_total_return)*1.2
     FROM customer_total_return ctr2
     WHERE ctr1.ctr_state = ctr2.ctr_state)
  AND ca_address_sk = c_current_addr_sk
  AND ca_state = 'GA'
  AND ctr1.ctr_customer_sk = c_customer_sk
ORDER BY c_customer_id NULLS FIRST,
         c_salutation NULLS FIRST,
         c_first_name NULLS FIRST,
         c_last_name NULLS FIRST,
         c_preferred_cust_flag NULLS FIRST,
         c_birth_day NULLS FIRST,
         c_birth_month NULLS FIRST,
         c_birth_year NULLS FIRST,
         c_birth_country NULLS FIRST,
         c_login NULLS FIRST,
         c_email_address NULLS FIRST,
         c_last_review_date_sk NULLS FIRST,
         ctr_total_return NULLS FIRST
LIMIT 100;
----

# Q31

query I
WITH ss AS
  (SELECT ca_county,
          d_qoy,
          d_year,
          sum(ss_ext_sales_price) AS store_sales
   FROM store_sales,
        date_dim,
        customer_address
   WHERE ss_sold_date_sk = d_date_sk
     AND ss_addr_sk=ca_address_sk
   GROUP BY ca_county,
            d_qoy,
            d_year),
     ws AS
  (SELECT ca_county,
          d_qoy,
          d_year,
          sum(ws_ext_sales_price) AS web_sales
   FROM web_sales,
        date_dim,
        customer_address
   WHERE ws_sold_date_sk = d_date_sk
     AND ws_bill_addr_sk=ca_address_sk
   GROUP BY ca_county,
            d_qoy,
            d_year)
SELECT ss1.ca_county ,
       ss1.d_year ,
       (ws2.web_sales*1.0000)/ws1.web_sales web_q1_q2_increase ,
       (ss2.store_sales*1.0000)/ss1.store_sales store_q1_q2_increase ,
       (ws3.web_sales*1.0000)/ws2.web_sales web_q2_q3_increase ,
       (ss3.store_sales*1.0000)/ss2.store_sales store_q2_q3_increase
FROM ss ss1 ,
     ss ss2 ,
     ss ss3 ,
     ws ws1 ,
     ws ws2 ,
     ws ws3
WHERE ss1.d_qoy = 1
  AND ss1.d_year = 2000
  AND ss1.ca_county = ss2.ca_county
  AND ss2.d_qoy = 2
  AND ss2.d_year = 2000
  AND ss2.ca_county = ss3.ca_county
  AND ss3.d_qoy = 3
  AND ss3.d_year = 2000
  AND ss1.ca_county = ws1.ca_county
  AND ws1.d_qoy = 1
  AND ws1.d_year = 2000
  AND ws1.ca_county = ws2.ca_county
  AND ws2.d_qoy = 2
  AND ws2.d_year = 2000
  AND ws1.ca_county = ws3.ca_county
  AND ws3.d_qoy = 3
  AND ws3.d_year = 2000
  AND CASE
          WHEN ws1.web_sales > 0 THEN (ws2.web_sales*1.0000)/ws1.web_sales
          ELSE NULL
      END > CASE
                WHEN ss1.store_sales > 0 THEN (ss2.store_sales*1.0000)/ss1.store_sales
                ELSE NULL
            END
  AND CASE
          WHEN ws2.web_sales > 0 THEN (ws3.web_sales*1.0000)/ws2.web_sales
          ELSE NULL
      END > CASE
                WHEN ss2.store_sales > 0 THEN (ss3.store_sales*1.0000)/ss2.store_sales
                ELSE NULL
            END
ORDER BY ss1.ca_county;
----

# Q32

query I
SELECT sum(cs_ext_discount_amt) AS "excess discount amount"
FROM catalog_sales ,
     item ,
     date_dim
WHERE i_manufact_id = 977
  AND i_item_sk = cs_item_sk
  AND d_date BETWEEN '2000-01-27' AND cast('2000-04-26' AS date)
  AND d_date_sk = cs_sold_date_sk
  AND cs_ext_discount_amt >
    ( SELECT 1.3 * avg(cs_ext_discount_amt)
     FROM catalog_sales ,
          date_dim
     WHERE cs_item_sk = i_item_sk
       AND d_date BETWEEN '2000-01-27' AND cast('2000-04-26' AS date)
       AND d_date_sk = cs_sold_date_sk )
LIMIT 100;
----
NULL

# Q33

query I
WITH ss AS
  ( SELECT i_manufact_id,
           sum(ss_ext_sales_price) total_sales
   FROM store_sales,
        date_dim,
        customer_address,
        item
   WHERE i_manufact_id IN
       (SELECT i_manufact_id
        FROM item
        WHERE i_category IN ('Electronics'))
     AND ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND d_year = 1998
     AND d_moy = 5
     AND ss_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_manufact_id),
     cs AS
  ( SELECT i_manufact_id,
           sum(cs_ext_sales_price) total_sales
   FROM catalog_sales,
        date_dim,
        customer_address,
        item
   WHERE i_manufact_id IN
       (SELECT i_manufact_id
        FROM item
        WHERE i_category IN ('Electronics'))
     AND cs_item_sk = i_item_sk
     AND cs_sold_date_sk = d_date_sk
     AND d_year = 1998
     AND d_moy = 5
     AND cs_bill_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_manufact_id),
     ws AS
  ( SELECT i_manufact_id,
           sum(ws_ext_sales_price) total_sales
   FROM web_sales,
        date_dim,
        customer_address,
        item
   WHERE i_manufact_id IN
       (SELECT i_manufact_id
        FROM item
        WHERE i_category IN ('Electronics'))
     AND ws_item_sk = i_item_sk
     AND ws_sold_date_sk = d_date_sk
     AND d_year = 1998
     AND d_moy = 5
     AND ws_bill_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_manufact_id)
SELECT i_manufact_id,
       sum(total_sales) total_sales
FROM
  (SELECT *
   FROM ss
   UNION ALL SELECT *
   FROM cs
   UNION ALL SELECT *
   FROM ws) tmp1
GROUP BY i_manufact_id
ORDER BY total_sales
LIMIT 100;
----

# Q34

query I
SELECT c_last_name ,
       c_first_name ,
       c_salutation ,
       c_preferred_cust_flag ,
       ss_ticket_number ,
       cnt
FROM
  (SELECT ss_ticket_number ,
          ss_customer_sk ,
          count(*) cnt
   FROM store_sales,
        date_dim,
        store,
        household_demographics
   WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk
     AND store_sales.ss_store_sk = store.s_store_sk
     AND store_sales.ss_hdemo_sk = household_demographics.hd_demo_sk
     AND (date_dim.d_dom BETWEEN 1 AND 3
          OR date_dim.d_dom BETWEEN 25 AND 28)
     AND (household_demographics.hd_buy_potential = '>10000'
          OR household_demographics.hd_buy_potential = 'Unknown')
     AND household_demographics.hd_vehicle_count > 0
     AND (CASE
              WHEN household_demographics.hd_vehicle_count > 0 THEN (household_demographics.hd_dep_count*1.000)/ household_demographics.hd_vehicle_count
              ELSE NULL
          END) > 1.2
     AND date_dim.d_year IN (1999,
                             1999+1,
                             1999+2)
     AND store.s_county = 'Williamson County'
   GROUP BY ss_ticket_number,
            ss_customer_sk) dn,
     customer
WHERE ss_customer_sk = c_customer_sk
  AND cnt BETWEEN 15 AND 20
ORDER BY c_last_name NULLS FIRST,
         c_first_name NULLS FIRST,
         c_salutation NULLS FIRST,
         c_preferred_cust_flag DESC NULLS FIRST,
         ss_ticket_number NULLS FIRST;
----
Cole Ruby Dr. N 932 16
Garza Carlos Mr. Y 1894 16
Harding Ernestina Miss Y 224 16
Martinez Bernard Sir N 1281 16
Robbins Ruth Ms. N 60 16
Simpson Kevin Dr. N 1369 15

# Q35
onlyif todo
query I
SELECT ca_state,
       cd_gender,
       cd_marital_status,
       cd_dep_count,
       count(*) cnt1,
       min(cd_dep_count) min1,
       max(cd_dep_count) max1,
       avg(cd_dep_count) avg1,
       cd_dep_employed_count,
       count(*) cnt2,
       min(cd_dep_employed_count) min2,
       max(cd_dep_employed_count) max2,
       avg(cd_dep_employed_count) avg2,
       cd_dep_college_count,
       count(*) cnt3,
       min(cd_dep_college_count),
       max(cd_dep_college_count),
       avg(cd_dep_college_count)
FROM customer c,
     customer_address ca,
     customer_demographics
WHERE c.c_current_addr_sk = ca.ca_address_sk
  AND cd_demo_sk = c.c_current_cdemo_sk
  AND EXISTS
    (SELECT *
     FROM store_sales,
          date_dim
     WHERE c.c_customer_sk = ss_customer_sk
       AND ss_sold_date_sk = d_date_sk
       AND d_year = 2002
       AND d_qoy < 4)
  AND (EXISTS
         (SELECT *
          FROM web_sales,
               date_dim
          WHERE c.c_customer_sk = ws_bill_customer_sk
            AND ws_sold_date_sk = d_date_sk
            AND d_year = 2002
            AND d_qoy < 4)
       OR EXISTS
         (SELECT *
          FROM catalog_sales,
               date_dim
          WHERE c.c_customer_sk = cs_ship_customer_sk
            AND cs_sold_date_sk = d_date_sk
            AND d_year = 2002
            AND d_qoy < 4))
GROUP BY ca_state,
         cd_gender,
         cd_marital_status,
         cd_dep_count,
         cd_dep_employed_count,
         cd_dep_college_count
ORDER BY ca_state NULLS FIRST,
         cd_gender NULLS FIRST,
         cd_marital_status NULLS FIRST,
         cd_dep_count NULLS FIRST,
         cd_dep_employed_count NULLS FIRST,
         cd_dep_college_count NULLS FIRST
LIMIT 100;
----
GA F M 2 1 2 2 2.0 0 1 0 0 0.0 0 1 0 0 0.0
GA F U 0 1 0 0 0.0 0 1 0 0 0.0 0 1 0 0 0.0
GA M D 0 1 0 0 0.0 0 1 0 0 0.0 0 1 0 0 0.0
IN F D 3 1 3 3 3.0 0 1 0 0 0.0 0 1 0 0 0.0
IN F S 2 1 2 2 2.0 0 1 0 0 0.0 0 1 0 0 0.0
IN F W 3 1 3 3 3.0 0 1 0 0 0.0 0 1 0 0 0.0
KS F M 1 1 1 1 1.0 0 1 0 0 0.0 0 1 0 0 0.0
MI M S 3 1 3 3 3.0 0 1 0 0 0.0 0 1 0 0 0.0
NV F S 0 1 0 0 0.0 0 1 0 0 0.0 0 1 0 0 0.0
TX F D 1 1 1 1 1.0 0 1 0 0 0.0 0 1 0 0 0.0
WI F U 1 1 1 1 1.0 0 1 0 0 0.0 0 1 0 0 0.0
WV M M 2 1 2 2 2.0 0 1 0 0 0.0 0 1 0 0 0.0

# Q36

query I
WITH results AS
  (SELECT sum(ss_net_profit) AS ss_net_profit,
          sum(ss_ext_sales_price) AS ss_ext_sales_price,
          (sum(ss_net_profit)*1.0000)/sum(ss_ext_sales_price) AS gross_margin ,
          i_category ,
          i_class ,
          0 AS g_category,
          0 AS g_class
   FROM store_sales ,
        date_dim d1 ,
        item ,
        store
   WHERE d1.d_year = 2001
     AND d1.d_date_sk = ss_sold_date_sk
     AND i_item_sk = ss_item_sk
     AND s_store_sk = ss_store_sk
     AND s_state ='TN'
   GROUP BY i_category,
            i_class) ,
     results_rollup AS
  (SELECT gross_margin,
          i_category,
          i_class,
          0 AS t_category,
          0 AS t_class,
          0 AS lochierarchy
   FROM results
   UNION SELECT (sum(ss_net_profit)*1.0000)/sum(ss_ext_sales_price) AS gross_margin,
                i_category,
                NULL AS i_class,
                0 AS t_category,
                1 AS t_class,
                1 AS lochierarchy
   FROM results
   GROUP BY i_category
   UNION SELECT (sum(ss_net_profit)*1.0000)/sum(ss_ext_sales_price) AS gross_margin,
                NULL AS i_category,
                NULL AS i_class,
                1 AS t_category,
                1 AS t_class,
                2 AS lochierarchy
   FROM results)
SELECT gross_margin,
       i_category,
       i_class,
       lochierarchy,
       rank() OVER ( PARTITION BY lochierarchy,
                                  CASE
                                      WHEN t_class = 0 THEN i_category
                                  END
                    ORDER BY gross_margin ASC) AS rank_within_parent
FROM results_rollup
ORDER BY lochierarchy DESC NULLS FIRST,
         CASE
             WHEN lochierarchy = 0 THEN i_category
         END NULLS FIRST,
         rank_within_parent NULLS FIRST
LIMIT 100;
----
-0.430613524573 NULL NULL 2 1
-0.539846955888 Electronics NULL 1 1
-0.535121056890 Sports NULL 1 2
-0.474252822435 Men NULL 1 3
-0.435320469694 Music NULL 1 4
-0.422314561478 Books NULL 1 5
-0.420998277520 Women NULL 1 6
-0.403514360940 Jewelry NULL 1 7
-0.356821428448 Children NULL 1 8
-0.314648142539 Home NULL 1 9
-0.289802639400 Shoes NULL 1 10
-0.513324910569 Books sports 0 1
-0.485395658723 Books fiction 0 2
-0.456069178992 Books self-help 0 3
-0.390536207987 Books reference 0 4
-0.361388375025 Books arts 0 5
-0.294644974838 Books travel 0 6
-0.271740556572 Books business 0 7
-0.451483367528 Children newborn 0 1
-0.395579858269 Children school-uniforms 0 2
-0.283308037489 Children toddlers 0 3
-0.818900225495 Electronics monitors 0 1
-0.803203772642 Electronics memory 0 2
-0.601671839290 Electronics audio 0 3
-0.561754670184 Electronics stereo 0 4
-0.539295360266 Electronics musical 0 5
-0.500535076467 Electronics televisions 0 6
-0.485984869243 Electronics karoke 0 7
-0.427238663642 Electronics dvd/vcr players 0 8
-0.373938894451 Electronics scanners 0 9
-0.453441805345 Home rugs 0 1
-0.426861349508 Home kids 0 2
-0.327256787408 Home decor 0 3
-0.231456207457 Home furniture 0 4
-0.223144558697 Home bedding 0 5
-0.552936914048 Jewelry costume 0 1
-0.479340075046 Jewelry jewelry boxes 0 2
-0.477787939030 Jewelry consignment 0 3
-0.466880015534 Jewelry pendants 0 4
-0.453849812674 Jewelry estate 0 5
-0.409295229944 Jewelry diamonds 0 6
-0.395230036306 Jewelry semi-precious 0 7
-0.355619262239 Jewelry custom 0 8
-0.297142264334 Jewelry gold 0 9
-0.177338006086 Jewelry mens watch 0 10
-0.560892409081 Men sports-apparel 0 1
-0.455523452563 Men shirts 0 2
-0.449096601845 Men pants 0 3
-0.445111999490 Men accessories 0 4
-0.500281860803 Music pop 0 1
-0.430407608267 Music country 0 2
-0.359006402586 Music classical 0 3
-0.387787805905 Shoes mens 0 1
-0.261783565849 Shoes womens 0 2
-0.740280536700 Sports fishing 0 1
-0.456764107705 Sports sailing 0 2
-0.325190591878 Sports guns 0 3
-0.466266877787 Women swimwear 0 1
-0.398132007627 Women fragrances 0 2
-0.355443373145 Women maternity 0 3

# Q37

query I
SELECT i_item_id,
       i_item_desc,
       i_current_price
FROM item,
     inventory,
     date_dim,
     catalog_sales
WHERE i_current_price BETWEEN 68 AND 68 + 30
  AND inv_item_sk = i_item_sk
  AND d_date_sk=inv_date_sk
  AND d_date BETWEEN cast('2000-02-01' AS date) AND cast('2000-04-01' AS date)
  AND i_manufact_id IN (677,
                        940,
                        694,
                        808)
  AND inv_quantity_on_hand BETWEEN 100 AND 500
  AND cs_item_sk = i_item_sk
GROUP BY i_item_id,
         i_item_desc,
         i_current_price
ORDER BY i_item_id
LIMIT 100;
----

# Q38

query I
SELECT count(*)
FROM
  (SELECT DISTINCT c_last_name,
                   c_first_name,
                   d_date
   FROM store_sales,
        date_dim,
        customer
   WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk
     AND store_sales.ss_customer_sk = customer.c_customer_sk
     AND d_month_seq BETWEEN 1200 AND 1200 + 11 INTERSECT
     SELECT DISTINCT c_last_name,
                     c_first_name,
                     d_date
     FROM catalog_sales,
          date_dim,
          customer WHERE catalog_sales.cs_sold_date_sk = date_dim.d_date_sk
     AND catalog_sales.cs_bill_customer_sk = customer.c_customer_sk
     AND d_month_seq BETWEEN 1200 AND 1200 + 11 INTERSECT
     SELECT DISTINCT c_last_name,
                     c_first_name,
                     d_date
     FROM web_sales,
          date_dim,
          customer WHERE web_sales.ws_sold_date_sk = date_dim.d_date_sk
     AND web_sales.ws_bill_customer_sk = customer.c_customer_sk
     AND d_month_seq BETWEEN 1200 AND 1200 + 11 ) hot_cust
LIMIT 100;
----
0

# Q39

query I
WITH inv AS
  (SELECT w_warehouse_name,
          w_warehouse_sk,
          i_item_sk,
          d_moy,
          stdev,
          mean,
          CASE mean
              WHEN 0 THEN NULL
              ELSE stdev/mean
          END cov
   FROM
     (SELECT w_warehouse_name,
             w_warehouse_sk,
             i_item_sk,
             d_moy,
             stddev_samp(inv_quantity_on_hand)*1.000 stdev,
             avg(inv_quantity_on_hand) mean
      FROM inventory,
           item,
           warehouse,
           date_dim
      WHERE inv_item_sk = i_item_sk
        AND inv_warehouse_sk = w_warehouse_sk
        AND inv_date_sk = d_date_sk
        AND d_year =2001
      GROUP BY w_warehouse_name,
               w_warehouse_sk,
               i_item_sk,
               d_moy) foo
   WHERE CASE mean
             WHEN 0 THEN 0
             ELSE stdev/mean
         END > 1)
SELECT inv1.w_warehouse_sk wsk1,
       inv1.i_item_sk isk1,
       inv1.d_moy dmoy1,
       inv1.mean mean1,
       truncate(inv1.cov, 15) as cov1,
       inv2.w_warehouse_sk,
       inv2.i_item_sk,
       inv2.d_moy,
       inv2.mean,
       inv2.cov
FROM inv inv1,
     inv inv2
WHERE inv1.i_item_sk = inv2.i_item_sk
  AND inv1.w_warehouse_sk = inv2.w_warehouse_sk
  AND inv1.d_moy=1
  AND inv2.d_moy=1+1
ORDER BY inv1.w_warehouse_sk NULLS FIRST,
         inv1.i_item_sk NULLS FIRST,
         inv1.d_moy NULLS FIRST,
         inv1.mean NULLS FIRST,
         inv1.cov NULLS FIRST,
         inv2.d_moy NULLS FIRST,
         inv2.mean NULLS FIRST,
         inv2.cov NULLS FIRST;
----
1 45 1 304.25 1.081490342970898 1 45 2 171.0 1.2269093185996713

# Q40

query I
SELECT w_state,
       i_item_id,
       sum(CASE
               WHEN (cast(d_date AS date) < CAST ('2000-03-11' AS date)) THEN cs_sales_price - coalesce(cr_refunded_cash,0)
               ELSE 0
           END) AS sales_before,
       sum(CASE
               WHEN (cast(d_date AS date) >= CAST ('2000-03-11' AS date)) THEN cs_sales_price - coalesce(cr_refunded_cash,0)
               ELSE 0
           END) AS sales_after
FROM catalog_sales
LEFT OUTER JOIN catalog_returns ON (cs_order_number = cr_order_number
                                    AND cs_item_sk = cr_item_sk) ,warehouse,
                                                                  item,
                                                                  date_dim
WHERE i_current_price BETWEEN 0.99 AND 1.49
  AND i_item_sk = cs_item_sk
  AND cs_warehouse_sk = w_warehouse_sk
  AND cs_sold_date_sk = d_date_sk
  AND d_date BETWEEN CAST ('2000-02-10' AS date) AND CAST ('2000-04-10' AS date)
GROUP BY w_state,
         i_item_id
ORDER BY w_state,
         i_item_id
LIMIT 100;
----
TN AAAAAAAACAAAAAAA 0.00 95.81
TN AAAAAAAADEAAAAAA -71.90 173.00
TN AAAAAAAAHDAAAAAA 102.18 581.24
TN AAAAAAAAKJAAAAAA -16.18 179.92
TN AAAAAAAAMBAAAAAA 264.10 144.88
TN AAAAAAAAOGAAAAAA -1163.62 -496.31
TN AAAAAAAAPKAAAAAA 0.00 238.91

# Q41

query I
SELECT distinct(i_product_name)
FROM item i1
WHERE i_manufact_id BETWEEN 738 AND 738+40
  AND
    (SELECT count(*) AS item_cnt
     FROM item
     WHERE (i_manufact = i1.i_manufact
            AND ((i_category = 'Women'
                  AND (i_color = 'powder'
                       OR i_color = 'khaki')
                  AND (i_units = 'Ounce'
                       OR i_units = 'Oz')
                  AND (i_size = 'medium'
                       OR i_size = 'extra large'))
                 OR (i_category = 'Women'
                     AND (i_color = 'brown'
                          OR i_color = 'honeydew')
                     AND (i_units = 'Bunch'
                          OR i_units = 'Ton')
                     AND (i_size = 'N/A'
                          OR i_size = 'small'))
                 OR (i_category = 'Men'
                     AND (i_color = 'floral'
                          OR i_color = 'deep')
                     AND (i_units = 'N/A'
                          OR i_units = 'Dozen')
                     AND (i_size = 'petite'
                          OR i_size = 'petite'))
                 OR (i_category = 'Men'
                     AND (i_color = 'light'
                          OR i_color = 'cornflower')
                     AND (i_units = 'Box'
                          OR i_units = 'Pound')
                     AND (i_size = 'medium'
                          OR i_size = 'extra large'))))
       OR (i_manufact = i1.i_manufact
           AND ((i_category = 'Women'
                 AND (i_color = 'midnight'
                      OR i_color = 'snow')
                 AND (i_units = 'Pallet'
                      OR i_units = 'Gross')
                 AND (i_size = 'medium'
                      OR i_size = 'extra large'))
                OR (i_category = 'Women'
                    AND (i_color = 'cyan'
                         OR i_color = 'papaya')
                    AND (i_units = 'Cup'
                         OR i_units = 'Dram')
                    AND (i_size = 'N/A'
                         OR i_size = 'small'))
                OR (i_category = 'Men'
                    AND (i_color = 'orange'
                         OR i_color = 'frosted')
                    AND (i_units = 'Each'
                         OR i_units = 'Tbl')
                    AND (i_size = 'petite'
                         OR i_size = 'petite'))
                OR (i_category = 'Men'
                    AND (i_color = 'forest'
                         OR i_color = 'ghost')
                    AND (i_units = 'Lb'
                         OR i_units = 'Bundle')
                    AND (i_size = 'medium'
                         OR i_size = 'extra large'))))) > 0
ORDER BY i_product_name
LIMIT 100;
----

# Q42

query I
SELECT dt.d_year,
       item.i_category_id,
       item.i_category,
       sum(ss_ext_sales_price)
FROM date_dim dt,
     store_sales,
     item
WHERE dt.d_date_sk = store_sales.ss_sold_date_sk
  AND store_sales.ss_item_sk = item.i_item_sk
  AND item.i_manager_id = 1
  AND dt.d_moy=11
  AND dt.d_year=2000
GROUP BY dt.d_year,
         item.i_category_id,
         item.i_category
ORDER BY sum(ss_ext_sales_price) DESC,dt.d_year,
                                      item.i_category_id,
                                      item.i_category
LIMIT 100 ;
----
2000 7 Home 47342.39

# Q43

query I
SELECT s_store_name,
       s_store_id,
       sum(CASE
               WHEN (d_day_name='Sunday') THEN ss_sales_price
               ELSE NULL
           END) sun_sales,
       sum(CASE
               WHEN (d_day_name='Monday') THEN ss_sales_price
               ELSE NULL
           END) mon_sales,
       sum(CASE
               WHEN (d_day_name='Tuesday') THEN ss_sales_price
               ELSE NULL
           END) tue_sales,
       sum(CASE
               WHEN (d_day_name='Wednesday') THEN ss_sales_price
               ELSE NULL
           END) wed_sales,
       sum(CASE
               WHEN (d_day_name='Thursday') THEN ss_sales_price
               ELSE NULL
           END) thu_sales,
       sum(CASE
               WHEN (d_day_name='Friday') THEN ss_sales_price
               ELSE NULL
           END) fri_sales,
       sum(CASE
               WHEN (d_day_name='Saturday') THEN ss_sales_price
               ELSE NULL
           END) sat_sales
FROM date_dim,
     store_sales,
     store
WHERE d_date_sk = ss_sold_date_sk
  AND s_store_sk = ss_store_sk
  AND s_gmt_offset = -5
  AND d_year = 2000
GROUP BY s_store_name,
         s_store_id
ORDER BY s_store_name,
         s_store_id,
         sun_sales,
         mon_sales,
         tue_sales,
         wed_sales,
         thu_sales,
         fri_sales,
         sat_sales
LIMIT 100;
----

# Q44

query I
SELECT asceding.rnk,
       i1.i_product_name best_performing,
       i2.i_product_name worst_performing
FROM
  (SELECT *
   FROM
     (SELECT item_sk,
             rank() OVER (
                          ORDER BY rank_col ASC) rnk
      FROM
        (SELECT ss_item_sk item_sk,
                avg(ss_net_profit) rank_col
         FROM store_sales ss1
         WHERE ss_store_sk = 4
         GROUP BY ss_item_sk
         HAVING avg(ss_net_profit) > 0.9*
           (SELECT avg(ss_net_profit) rank_col
            FROM store_sales
            WHERE ss_store_sk = 4
              AND ss_addr_sk IS NULL
            GROUP BY ss_store_sk))V1)V11
   WHERE rnk < 11) asceding,
  (SELECT *
   FROM
     (SELECT item_sk,
             rank() OVER (
                          ORDER BY rank_col DESC) rnk
      FROM
        (SELECT ss_item_sk item_sk,
                avg(ss_net_profit) rank_col
         FROM store_sales ss1
         WHERE ss_store_sk = 4
         GROUP BY ss_item_sk
         HAVING avg(ss_net_profit) > 0.9*
           (SELECT avg(ss_net_profit) rank_col
            FROM store_sales
            WHERE ss_store_sk = 4
              AND ss_addr_sk IS NULL
            GROUP BY ss_store_sk))V2)V21
   WHERE rnk < 11) descending,
     item i1,
     item i2
WHERE asceding.rnk = descending.rnk
  AND i1.i_item_sk=asceding.item_sk
  AND i2.i_item_sk=descending.item_sk
ORDER BY asceding.rnk
LIMIT 100;
----

# Q45

query I
SELECT ca_zip,
       ca_city,
       sum(ws_sales_price)
FROM web_sales,
     customer,
     customer_address,
     date_dim,
     item
WHERE ws_bill_customer_sk = c_customer_sk
  AND c_current_addr_sk = ca_address_sk
  AND ws_item_sk = i_item_sk
  AND (SUBSTRING(ca_zip,1,5) IN ('85669',
                              '86197',
                              '88274',
                              '83405',
                              '86475',
                              '85392',
                              '85460',
                              '80348',
                              '81792')
       OR i_item_id IN
         (SELECT i_item_id
          FROM item
          WHERE i_item_sk IN (2,
                              3,
                              5,
                              7,
                              11,
                              13,
                              17,
                              19,
                              23,
                              29) ))
  AND ws_sold_date_sk = d_date_sk
  AND d_qoy = 2
  AND d_year = 2001
GROUP BY ca_zip,
         ca_city
ORDER BY ca_zip,
         ca_city
LIMIT 100;
----
25281 Bethel 24.58
30059 Centerville 22.34
33604 Pleasant Hill 188.50
46614 Providence 84.59
46867 Jamestown 61.73
50162 Stringtown 44.37
58222 Clinton 7.52
59303 Springfield 220.27
59843 Oakland 128.99
64489 Woodbury 111.15
69127 Mount Vernon 39.69
71904 Midway 262.75
71952 Sunnyside 145.52
83003 Hillcrest 29.14
89101 Franklin 64.96
89431 New Hope 68.06
98014 Clifton 130.03

# Q46

query I
SELECT c_last_name,
       c_first_name,
       ca_city,
       bought_city,
       ss_ticket_number,
       amt,
       profit
FROM
  (SELECT ss_ticket_number,
          ss_customer_sk,
          ca_city bought_city,
          sum(ss_coupon_amt) amt,
          sum(ss_net_profit) profit
   FROM store_sales,
        date_dim,
        store,
        household_demographics,
        customer_address
   WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk
     AND store_sales.ss_store_sk = store.s_store_sk
     AND store_sales.ss_hdemo_sk = household_demographics.hd_demo_sk
     AND store_sales.ss_addr_sk = customer_address.ca_address_sk
     AND (household_demographics.hd_dep_count = 4
          OR household_demographics.hd_vehicle_count= 3)
     AND date_dim.d_dow IN (6,
                            0)
     AND date_dim.d_year IN (1999,
                             1999+1,
                             1999+2)
     AND store.s_city IN ('Fairview',
                          'Midway')
   GROUP BY ss_ticket_number,
            ss_customer_sk,
            ss_addr_sk,
            ca_city) dn,
     customer,
     customer_address current_addr
WHERE ss_customer_sk = c_customer_sk
  AND customer.c_current_addr_sk = current_addr.ca_address_sk
  AND current_addr.ca_city <> bought_city
ORDER BY c_last_name NULLS FIRST,
         c_first_name NULLS FIRST,
         ca_city NULLS FIRST,
         bought_city NULLS FIRST,
         ss_ticket_number NULLS FIRST
LIMIT 100;
----
Adams Chris Spring Hill Lakeview 114 428.59 -2260.63
Alexander Tara Proctor Mount Pleasant 1880 45.14 -11183.18
Allen Richard Oak Ridge Greenwood 259 2431.92 -19280.56
Andrews Catherine Lincoln Deerfield 1846 6471.59 -8070.90
Archie Geneva Enterprise Lakeview 89 2578.22 -13859.38
Berry Nancy Pleasant Valley Mount Vernon 2352 2322.97 -11554.09
Blair John Spring Valley Valley View 654 899.69 -9066.75
Bond Larry Jackson Newtown 324 392.93 -1058.32
Bravo Paul Mount Zion Maple Grove 671 1995.34 -1564.30
Britt Inez Edgewood Plainview 61 0.00 687.08
Brown Heather Riverdale Wilson 2393 123.85 -6022.89
Buchanan Alvin Walnut Grove Clifton 537 701.93 -18891.29
Burns Kevin Midway Glenwood 1069 3930.91 -14558.48
Burns Kevin Midway Mount Zion 1585 1289.04 -25477.36
Butler Claudia Five Points Forest Hills 205 2017.72 -9117.74
Butler Rebecca Union Harmony 2035 591.02 -6337.32
Caldwell Joseph Providence Wilson 2069 1866.90 -6056.38
Campbell Sheila Union Bethel 1589 4165.20 -16731.01
Carl Natasha Frogtown Newport 302 407.49 -3284.30
Carroll Bryan Centerville Jamestown 1346 0.00 -2555.03
Chambers Adam Stringtown Red Hill 2 4916.73 -28346.06
Cowan Shawn Green Acres Woodville 1780 1256.07 -6667.96
Daniels Brandi Oakdale Highland 1242 3510.53 -12169.74
Dawkins Steven Lakeview Macedonia 1081 135.10 -7184.66
Dawkins Steven Lakeview Salem 2054 314.97 -8809.77
Dudley Tonia Greenwood Newport 142 1055.09 -18655.68
Dunbar Ronald Mount Zion Proctor 995 2751.72 -4890.87
Evans Eleanor Midway Lewisburg 1656 3406.37 -27973.81
Foster Florence Sulphur Springs Woodland 199 24.81 1272.19
Fuller Jean Union Highland Park 1791 1260.50 -3811.61
Garrison Kevin Union Hopewell 784 3084.73 -3287.39
Gilbert Karl Unionville Hartland 1158 1135.91 -1479.70
Glaze Michael Greenwood New Hope 2056 33.28 -9211.07
Greene Jennifer Oakdale Oakland 1804 0.00 1383.44
Greene Jennifer Oakdale Riverview 1030 1444.78 -1633.26
Grider James Franklin Greenwood 2232 11869.79 -26811.60
Grogan Timothy Mount Vernon Pomona 1519 539.81 -4908.75
Harrison Bonnie Marion Newtown 316 525.42 -2477.98
Harry Paul Centerville Woodland 1882 17.63 -7693.96
Hermann Rebecca Harmony Newtown 570 3036.52 -4815.17
Hernandez Michael Salem Harmony 1338 4174.10 -16379.93
Hernandez Rachel Greenwood Harmony 1864 6791.14 -11294.62
Holloway Monica Edgewood Oakdale 1933 1476.46 -13005.54
Hutchins Rudolph Five Forks Spring Hill 1623 4414.53 -10891.60
Jackson John Valley View Union Hill 820 570.84 -11833.63
Johnson Benjamin Bethel Crossroads 533 983.56 -16491.21
Johnson Marilyn Walnut Grove Bunker Hill 752 2089.47 -13435.58
Jones Renee Crossroads Salem 113 851.20 -13800.31
Katz Anderson Oak Ridge Lakewood 1459 2905.56 -610.21
Katz Anderson Oak Ridge Waterloo 1294 995.10 -4080.69
Kuhn Annie Glendale Friendship 1040 1757.54 -8840.65
Lanier David Mountain View Edgewood 1213 1500.63 -7518.84
Leake Matthew Midway Enterprise 1771 84.52 225.24
Levi Leroy Riverdale Union 1328 1587.93 -15462.21
Lewis Brian Riverview Lakewood 623 721.19 -2584.54
Lewis Brian Riverview Union Hill 85 1035.02 -3490.24
Lloyd Douglas Springfield Concord 265 5762.93 -21807.69
Lloyd Douglas Springfield Mount Olive 1209 2327.21 -11677.36
Long Samantha Antioch Union Hill 1388 161.06 684.47
Lowry Craig Oakwood Newport 57 138.61 -10694.10
Malloy Penelope Oakland Pleasant Grove 39 2846.77 -6886.04
Marlow Polly Pine Grove Providence 491 831.42 6462.24
Mayes Archie Forest Hills Harmony 1139 4469.46 -4074.42
Mays Sean Union Hill Royal 214 1950.49 -11418.38
Mcclellan Steven Riverside Marion 977 1153.54 3432.80
Miller Christine Clinton Five Points 44 3136.33 -5980.81
Moore Steven Ashland Centerville 2050 3618.24 -6879.65
Moore Steven Ashland Lakewood 2072 782.13 -16537.78
Munoz Leonard Waterloo Bunker Hill 1690 1626.23 -11189.98
Norris Joseph Red Hill Union Hill 2116 2411.64 -8725.21
Numbers Michael Union Hill Oak Hill 2239 376.16 -7512.84
Olvera Bruce Shore Acres Pleasant Valley 1023 2010.20 -16389.06
Orr Jeffrey Clifton Oakdale 435 3097.21 -10995.97
Ortiz Terry Wright Liberty 1663 326.54 -8050.03
Perry Dustin Waterloo Lakewood 815 3834.72 -12402.70
Peterson Marie Deerfield Highland 1251 9192.69 -24606.05
Phillips Julia Glenwood Liberty 2151 5131.79 -7431.33
Ramos Aline Newport Enterprise 1776 2247.16 -15606.78
Ritchey Evelyn Plainview Clifton 371 2276.26 -1248.97
Rutherford Adela Crossroads Belmont 1849 5064.59 -7525.50
Schneider Dwight Walnut Grove Pleasant Valley 776 473.94 1251.51
Simpson Kevin Valley View Red Hill 2207 10089.03 -15994.53
Smith Daisy Stringtown Five Points 124 758.97 -1955.99
Smith Marjorie Providence Blue Springs 104 2270.72 -17277.06
Smith Rochel Enterprise New Hope 1921 0.00 -13085.27
Thompson Samuel Forest Hills Marion 1911 607.52 -8326.91
Travers Shawn Mount Olive Franklin 540 4824.64 -22373.02
Valdez Charles Maple Grove Five Forks 1399 1078.25 -9558.03
Villanueva Paul Mechanicsburg Farmington 1077 954.29 -8281.06
Walton Cedric Hamilton Mount Olive 164 1978.62 -3569.70
Ward Scott Riverside Enterprise 1689 9046.85 -14860.55
Watson Alfred Jamestown Union 1186 2852.45 -6438.45
Whitaker Richard Oak Ridge Glendale 2158 2811.09 -9782.20
Wiles Jeffrey Cedar Grove Bethel 489 109.44 -8395.15
Wilson Joseph Warwick Bunker Hill 2083 128.66 -6901.74
Woods Brandon Fairfield Ashland 1572 1490.43 -1443.79
Wynne Joanne Sugar Hill Pleasant Grove 1004 1490.33 -8000.14
Young Althea Jamestown Lakeview 634 2760.16 -23436.25
Young Althea Jamestown Riverside 1289 0.00 -543.36

# Q47

query I
WITH v1 AS
  (SELECT i_category,
          i_brand,
          s_store_name,
          s_company_name,
          d_year,
          d_moy,
          sum(ss_sales_price) sum_sales,
          avg(sum(ss_sales_price)) OVER (PARTITION BY i_category,
                                                      i_brand,
                                                      s_store_name,
                                                      s_company_name,
                                                      d_year) avg_monthly_sales,
                                        rank() OVER (PARTITION BY i_category,
                                                                  i_brand,
                                                                  s_store_name,
                                                                  s_company_name
                                                     ORDER BY d_year,
                                                              d_moy) rn
   FROM item,
        store_sales,
        date_dim,
        store
   WHERE ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND ss_store_sk = s_store_sk
     AND (d_year = 1999
          OR (d_year = 1999-1
              AND d_moy =12)
          OR (d_year = 1999+1
              AND d_moy =1))
   GROUP BY i_category,
            i_brand,
            s_store_name,
            s_company_name,
            d_year,
            d_moy),
     v2 AS
  (SELECT v1.i_category,
          v1.i_brand,
          v1.s_store_name,
          v1.s_company_name,
          v1.d_year,
          v1.d_moy,
          v1.avg_monthly_sales,
          v1.sum_sales,
          v1_lag.sum_sales psum,
          v1_lead.sum_sales nsum
   FROM v1,
        v1 v1_lag,
        v1 v1_lead
   WHERE v1.i_category = v1_lag.i_category
     AND v1.i_category = v1_lead.i_category
     AND v1.i_brand = v1_lag.i_brand
     AND v1.i_brand = v1_lead.i_brand
     AND v1.s_store_name = v1_lag.s_store_name
     AND v1.s_store_name = v1_lead.s_store_name
     AND v1.s_company_name = v1_lag.s_company_name
     AND v1.s_company_name = v1_lead.s_company_name
     AND v1.rn = v1_lag.rn + 1
     AND v1.rn = v1_lead.rn - 1)
SELECT *
FROM v2
WHERE d_year = 1999
  AND avg_monthly_sales > 0
  AND CASE
          WHEN avg_monthly_sales > 0 THEN abs(sum_sales - avg_monthly_sales) / avg_monthly_sales
          ELSE NULL
      END > 0.1
ORDER BY sum_sales - avg_monthly_sales, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
LIMIT 100;
----
Men edu packimporto #1 ought Unknown 1999 5 947.2416 224.73 374.13 562.90
Men edu packimporto #1 ought Unknown 1999 4 947.2416 374.13 613.07 224.73
Shoes exportiedu pack #1 ought Unknown 1999 5 839.3366 269.23 823.83 301.06
Shoes edu packedu pack #1 ought Unknown 1999 5 621.8783 54.02 199.22 646.45
Shoes exportiedu pack #1 ought Unknown 1999 6 839.3366 301.06 269.23 612.27
Children amalgexporti #1 ought Unknown 1999 2 584.5758 68.95 387.26 310.73
Women importoamalg #1 ought Unknown 1999 3 481.3833 43.68 466.04 277.08
Shoes edu packedu pack #1 ought Unknown 1999 4 621.8783 199.22 472.58 54.02
Children amalgexporti #1 ought Unknown 1999 6 584.5758 162.80 331.25 296.04
Women amalgamalg #1 ought Unknown 1999 6 421.9750 7.23 191.09 236.55
Men edu packimporto #1 ought Unknown 1999 2 947.2416 536.94 1028.26 613.07
Children exportiexporti #1 ought Unknown 1999 4 443.0208 35.71 331.53 247.41
Children exportiexporti #1 ought Unknown 1999 6 443.0208 47.16 247.41 417.50
Men edu packimporto #1 ought Unknown 1999 6 947.2416 562.90 224.73 643.72
Shoes exportiedu pack #1 ought Unknown 1999 2 839.3366 457.69 649.87 542.63
Books scholarunivamalg #8 ought Unknown 1999 5 404.0616 37.73 190.87 232.19
Men amalgimporto #2 ought Unknown 1999 4 486.2308 124.33 190.98 150.52
Women edu packamalg #2 ought Unknown 1999 5 392.4991 31.70 218.42 134.80
Children exportiexporti #1 ought Unknown 1999 2 443.0208 100.95 394.65 331.53
Men amalgimporto #2 ought Unknown 1999 5 486.2308 150.52 124.33 375.70
Men edu packimporto #1 ought Unknown 1999 3 947.2416 613.07 536.94 374.13
Men edu packimporto #2 ought Unknown 1999 6 386.7833 53.76 231.37 82.19
Men edu packimporto #2 ought Unknown 1999 2 386.7833 60.25 247.49 259.94
Books exportiunivamalg #2 ought Unknown 1999 2 372.2108 54.65 341.83 195.37
Music amalgscholar #1 ought Unknown 1999 2 385.4775 79.13 320.78 154.66
Men edu packimporto #2 ought Unknown 1999 7 386.7833 82.19 53.76 755.46
Men edu packimporto #1 ought Unknown 1999 7 947.2416 643.72 562.90 1204.43
Shoes exportiedu pack #1 ought Unknown 1999 3 839.3366 542.63 457.69 823.83
Men amalgimporto #2 ought Unknown 1999 3 486.2308 190.98 263.18 124.33
Children importoexporti #1 ought Unknown 1999 7 354.5558 61.74 65.76 402.97
Children importoexporti #1 ought Unknown 1999 6 354.5558 65.76 170.03 61.74
Children amalgexporti #1 ought Unknown 1999 7 584.5758 296.04 162.80 892.86
Children edu packexporti #2 ought Unknown 1999 4 424.1318 136.78 249.07 248.54
Children edu packexporti #2 ought Unknown 1999 7 424.1318 144.07 248.54 185.09
Books exportiunivamalg #2 ought Unknown 1999 6 372.2108 93.29 107.07 229.95
Children amalgexporti #1 ought Unknown 1999 3 584.5758 310.73 68.95 592.14
Books exportiunivamalg #2 ought Unknown 1999 5 372.2108 107.07 388.34 93.29
Jewelry importocorp #7 ought Unknown 1999 5 313.3427 50.14 288.32 242.33
Books scholarunivamalg #8 ought Unknown 1999 2 404.0616 140.99 562.95 160.05
Women edu packamalg #2 ought Unknown 1999 6 392.4991 134.80 31.70 426.42
Children amalgexporti #1 ought Unknown 1999 5 584.5758 331.25 592.14 162.80
Women edu packamalg #2 ought Unknown 1999 3 392.4991 144.23 245.45 218.42
Music exportischolar #2 ought Unknown 1999 4 431.8383 185.68 279.95 188.36
Women amalgamalg #1 ought Unknown 1999 1 421.9750 176.88 758.20 263.85
Books scholarunivamalg #8 ought Unknown 1999 3 404.0616 160.05 140.99 190.87
Home corpbrand #10 ought Unknown 1999 1 254.4890 10.77 233.18 380.65
Music exportischolar #2 ought Unknown 1999 5 431.8383 188.36 185.68 218.44
Women edu packamalg #1 ought Unknown 1999 2 243.0927 1.66 271.87 19.52
Children edu packexporti #2 ought Unknown 1999 8 424.1318 185.09 144.07 482.17
Jewelry importobrand #6 ought Unknown 1999 4 242.1566 5.60 100.34 9.71
Jewelry importobrand #6 ought Unknown 1999 5 242.1566 9.71 5.60 79.70
Women amalgamalg #1 ought Unknown 1999 5 421.9750 191.09 386.48 7.23
Music amalgscholar #1 ought Unknown 1999 3 385.4775 154.66 79.13 221.41
Shoes exportiedu pack #1 ought Unknown 1999 7 839.3366 612.27 301.06 1263.05
Electronics brandunivamalg #1 ought Unknown 1999 5 281.3100 55.86 97.39 207.20
Women edu packamalg #1 ought Unknown 1999 3 243.0927 19.52 1.66 176.10
Men amalgimporto #2 ought Unknown 1999 2 486.2308 263.18 279.58 190.98
Books univunivamalg #8 ought Unknown 1999 2 225.3490 4.78 266.47 201.85
Music exportischolar #2 ought Unknown 1999 6 431.8383 218.44 188.36 248.30
Books scholarunivamalg #8 ought Unknown 1999 4 404.0616 190.87 160.05 37.73
Jewelry importobrand #6 ought Unknown 1999 9 242.1566 29.97 61.84 435.44
Sports exportimaxi #1 ought Unknown 1999 3 250.9818 39.32 135.81 196.27
Music amalgscholar #1 ought Unknown 1999 5 385.4775 174.54 221.41 201.42
Sports exportimaxi #1 ought Unknown 1999 6 250.9818 42.46 196.27 103.28
Electronics corpamalgamalg #12 ought Unknown 1999 2 212.8633 4.69 129.91 127.90
Women importoamalg #1 ought Unknown 1999 1 481.3833 274.07 1026.66 466.04
Shoes edu packedu pack #1 ought Unknown 1999 7 621.8783 415.05 646.45 681.98
Men amalgimporto #2 ought Unknown 1999 1 486.2308 279.58 611.58 263.18
Sports scholarmaxi #1 ought Unknown 1999 5 205.5691 0.19 160.15 155.47
Women importoamalg #1 ought Unknown 1999 4 481.3833 277.08 43.68 304.78
Jewelry brandcorp #5 ought Unknown 1999 4 207.9045 4.33 139.85 90.70
Sports maxinameless #3 ought Unknown 1999 7 238.1033 34.68 122.01 217.50
Jewelry edu packcorp #7 ought Unknown 1999 4 201.7491 0.53 63.03 183.70
Jewelry amalgbrand #2 ought Unknown 1999 2 197.7710 0.20 220.72 28.93
Children amalgexporti #1 ought Unknown 1999 1 584.5758 387.26 1344.95 68.95
Shoes importoedu pack #1 ought Unknown 1999 2 201.2433 4.51 216.44 118.74
Books corpunivamalg #9 ought Unknown 1999 6 204.7466 8.02 127.28 131.03
Children exportiexporti #1 ought Unknown 1999 5 443.0208 247.41 35.71 47.16
Home corpnameless #6 ought Unknown 1999 6 208.4950 13.16 198.16 270.35
Sports scholarmaxi #2 ought Unknown 1999 7 211.9954 18.07 22.69 209.49
Electronics corpunivamalg #7 ought Unknown 1999 5 214.6145 22.66 235.97 276.55
Children importoexporti #1 ought Unknown 1999 2 354.5558 163.57 189.20 166.74
Books scholarunivamalg #8 ought Unknown 1999 7 404.0616 213.62 232.19 256.80
Shoes exportiedu pack #1 ought Unknown 1999 1 839.3366 649.87 1407.63 457.69
Sports scholarmaxi #2 ought Unknown 1999 6 211.9954 22.69 30.41 18.07
Shoes edu packedu pack #1 ought Unknown 1999 1 621.8783 433.14 1401.73 475.95
Sports scholarmaxi #2 ought Unknown 1999 1 211.9954 23.63 274.85 63.11
Jewelry amalgbrand #2 ought Unknown 1999 6 197.7710 9.45 9.64 227.31
Jewelry amalgbrand #2 ought Unknown 1999 5 197.7710 9.64 14.03 9.45
Children importoexporti #1 ought Unknown 1999 3 354.5558 166.74 163.57 274.51
Men importoimporto #1 ought Unknown 1999 2 214.0218 27.33 266.32 211.70
Books corpunivamalg #9 ought Unknown 1999 4 204.7466 18.61 229.14 127.28
Women amalgamalg #1 ought Unknown 1999 7 421.9750 236.55 7.23 704.26
Home edu packbrand #3 ought Unknown 1999 1 205.5225 20.83 792.86 65.73
Children importoexporti #1 ought Unknown 1999 5 354.5558 170.03 274.51 65.76
Home edu packbrand #9 ought Unknown 1999 6 195.5375 11.10 41.04 234.84
Music amalgscholar #1 ought Unknown 1999 6 385.4775 201.42 174.54 241.10
Electronics brandunivamalg #1 ought Unknown 1999 4 281.3100 97.39 244.21 55.86
Jewelry amalgbrand #2 ought Unknown 1999 4 197.7710 14.03 28.93 9.64
Music exportischolar #2 ought Unknown 1999 7 431.8383 248.30 218.44 363.14

# Q48

query I
SELECT SUM (ss_quantity)
FROM store_sales,
     store,
     customer_demographics,
     customer_address,
     date_dim
WHERE s_store_sk = ss_store_sk
  AND ss_sold_date_sk = d_date_sk
  AND d_year = 2000
  AND ((cd_demo_sk = ss_cdemo_sk
        AND cd_marital_status = 'M'
        AND cd_education_status = '4 yr Degree'
        AND ss_sales_price BETWEEN 100.00 AND 150.00)
       OR (cd_demo_sk = ss_cdemo_sk
           AND cd_marital_status = 'D'
           AND cd_education_status = '2 yr Degree'
           AND ss_sales_price BETWEEN 50.00 AND 100.00)
       OR (cd_demo_sk = ss_cdemo_sk
           AND cd_marital_status = 'S'
           AND cd_education_status = 'College'
           AND ss_sales_price BETWEEN 150.00 AND 200.00))
  AND ((ss_addr_sk = ca_address_sk
        AND ca_country = 'United States'
        AND ca_state IN ('CO',
                         'OH',
                         'TX')
        AND ss_net_profit BETWEEN 0 AND 2000)
       OR (ss_addr_sk = ca_address_sk
           AND ca_country = 'United States'
           AND ca_state IN ('OR',
                            'MN',
                            'KY')
           AND ss_net_profit BETWEEN 150 AND 3000)
       OR (ss_addr_sk = ca_address_sk
           AND ca_country = 'United States'
           AND ca_state IN ('VA',
                            'CA',
                            'MS')
           AND ss_net_profit BETWEEN 50 AND 25000)) ;
----
181

# Q49

query I
SELECT channel,
       item,
       return_ratio,
       return_rank,
       currency_rank
FROM
  (SELECT 'web' AS channel,
          web.item,
          web.return_ratio,
          web.return_rank,
          web.currency_rank
   FROM
     (SELECT item,
             return_ratio,
             currency_ratio,
             rank() OVER (
                          ORDER BY return_ratio) AS return_rank,
                         rank() OVER (
                                      ORDER BY currency_ratio) AS currency_rank
      FROM
        (SELECT ws.ws_item_sk AS item,
                (cast(sum(coalesce(wr.wr_return_quantity,0)) AS decimal(15,4))/ cast(sum(coalesce(ws.ws_quantity,0)) AS decimal(15,4))) AS return_ratio,
                (cast(sum(coalesce(wr.wr_return_amt,0)) AS decimal(15,4))/ cast(sum(coalesce(ws.ws_net_paid,0)) AS decimal(15,4))) AS currency_ratio
         FROM web_sales ws
         LEFT OUTER JOIN web_returns wr ON (ws.ws_order_number = wr.wr_order_number
                                            AND ws.ws_item_sk = wr.wr_item_sk) ,date_dim
         WHERE wr.wr_return_amt > 10000
           AND ws.ws_net_profit > 1
           AND ws.ws_net_paid > 0
           AND ws.ws_quantity > 0
           AND ws_sold_date_sk = d_date_sk
           AND d_year = 2001
           AND d_moy = 12
         GROUP BY ws.ws_item_sk) in_web) web
   WHERE (web.return_rank <= 10
          OR web.currency_rank <= 10)
   UNION SELECT 'catalog' AS channel,
                catalog.item,
                catalog.return_ratio,
                catalog.return_rank,
                catalog.currency_rank
   FROM
     (SELECT item,
             return_ratio,
             currency_ratio,
             rank() OVER (
                          ORDER BY return_ratio) AS return_rank,
                         rank() OVER (
                                      ORDER BY currency_ratio) AS currency_rank
      FROM
        (SELECT cs.cs_item_sk AS item,
                (cast(sum(coalesce(cr.cr_return_quantity,0)) AS decimal(15,4))/ cast(sum(coalesce(cs.cs_quantity,0)) AS decimal(15,4))) AS return_ratio,
                (cast(sum(coalesce(cr.cr_return_amount,0)) AS decimal(15,4))/ cast(sum(coalesce(cs.cs_net_paid,0)) AS decimal(15,4))) AS currency_ratio
         FROM catalog_sales cs
         LEFT OUTER JOIN catalog_returns cr ON (cs.cs_order_number = cr.cr_order_number
                                                AND cs.cs_item_sk = cr.cr_item_sk) ,date_dim
         WHERE cr.cr_return_amount > 10000
           AND cs.cs_net_profit > 1
           AND cs.cs_net_paid > 0
           AND cs.cs_quantity > 0
           AND cs_sold_date_sk = d_date_sk
           AND d_year = 2001
           AND d_moy = 12
         GROUP BY cs.cs_item_sk) in_cat) CATALOG
   WHERE (catalog.return_rank <= 10
          OR catalog.currency_rank <=10)
   UNION SELECT 'store' AS channel,
                store.item,
                store.return_ratio,
                store.return_rank,
                store.currency_rank
   FROM
     (SELECT item,
             return_ratio,
             currency_ratio,
             rank() OVER (
                          ORDER BY return_ratio) AS return_rank,
                         rank() OVER (
                                      ORDER BY currency_ratio) AS currency_rank
      FROM
        (SELECT sts.ss_item_sk AS item,
                (cast(sum(coalesce(sr.sr_return_quantity,0)) AS decimal(15,4))/cast(sum(coalesce(sts.ss_quantity,0)) AS decimal(15,4))) AS return_ratio,
                (cast(sum(coalesce(sr.sr_return_amt,0)) AS decimal(15,4))/cast(sum(coalesce(sts.ss_net_paid,0)) AS decimal(15,4))) AS currency_ratio
         FROM store_sales sts
         LEFT OUTER JOIN store_returns sr ON (sts.ss_ticket_number = sr.sr_ticket_number
                                              AND sts.ss_item_sk = sr.sr_item_sk) ,date_dim
         WHERE sr.sr_return_amt > 10000
           AND sts.ss_net_profit > 1
           AND sts.ss_net_paid > 0
           AND sts.ss_quantity > 0
           AND ss_sold_date_sk = d_date_sk
           AND d_year = 2001
           AND d_moy = 12
         GROUP BY sts.ss_item_sk) in_store) store
   WHERE (store.return_rank <= 10
          OR store.currency_rank <= 10) ) sq1
ORDER BY 1 NULLS FIRST,
         4 NULLS FIRST,
         5 NULLS FIRST,
         2 NULLS FIRST
LIMIT 100;
----

# Q50

query I
SELECT s_store_name,
       s_company_id,
       s_street_number,
       s_street_name,
       s_street_type,
       s_suite_number,
       s_city,
       s_county,
       s_state,
       s_zip,
       sum(CASE
               WHEN (sr_returned_date_sk - ss_sold_date_sk <= 30) THEN 1
               ELSE 0
           END) AS "30 days",
       sum(CASE
               WHEN (sr_returned_date_sk - ss_sold_date_sk > 30)
                    AND (sr_returned_date_sk - ss_sold_date_sk <= 60) THEN 1
               ELSE 0
           END) AS "31-60 days",
       sum(CASE
               WHEN (sr_returned_date_sk - ss_sold_date_sk > 60)
                    AND (sr_returned_date_sk - ss_sold_date_sk <= 90) THEN 1
               ELSE 0
           END) AS "61-90 days",
       sum(CASE
               WHEN (sr_returned_date_sk - ss_sold_date_sk > 90)
                    AND (sr_returned_date_sk - ss_sold_date_sk <= 120) THEN 1
               ELSE 0
           END) AS "91-120 days",
       sum(CASE
               WHEN (sr_returned_date_sk - ss_sold_date_sk > 120) THEN 1
               ELSE 0
           END) AS ">120 days"
FROM store_sales,
     store_returns,
     store,
     date_dim d1,
     date_dim d2
WHERE d2.d_year = 2001
  AND d2.d_moy = 8
  AND ss_ticket_number = sr_ticket_number
  AND ss_item_sk = sr_item_sk
  AND ss_sold_date_sk = d1.d_date_sk
  AND sr_returned_date_sk = d2.d_date_sk
  AND ss_customer_sk = sr_customer_sk
  AND ss_store_sk = s_store_sk
GROUP BY s_store_name,
         s_company_id,
         s_street_number,
         s_street_name,
         s_street_type,
         s_suite_number,
         s_city,
         s_county,
         s_state,
         s_zip
ORDER BY s_store_name,
         s_company_id,
         s_street_number,
         s_street_name,
         s_street_type,
         s_suite_number,
         s_city,
         s_county,
         s_state,
         s_zip
LIMIT 100;
----
ought 1 767 Spring  Wy Suite 250 Midway Williamson County TN 31904 7 2 2 4 10

# Q51

query I
WITH web_v1 AS
  (SELECT ws_item_sk item_sk,
          d_date,
          sum(sum(ws_sales_price)) OVER (PARTITION BY ws_item_sk
                                         ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) cume_sales
   FROM web_sales,
        date_dim
   WHERE ws_sold_date_sk=d_date_sk
     AND d_month_seq BETWEEN 1200 AND 1200+11
     AND ws_item_sk IS NOT NULL
   GROUP BY ws_item_sk,
            d_date),
     store_v1 AS
  (SELECT ss_item_sk item_sk,
          d_date,
          sum(sum(ss_sales_price)) OVER (PARTITION BY ss_item_sk
                                         ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) cume_sales
   FROM store_sales,
        date_dim
   WHERE ss_sold_date_sk=d_date_sk
     AND d_month_seq BETWEEN 1200 AND 1200+11
     AND ss_item_sk IS NOT NULL
   GROUP BY ss_item_sk,
            d_date)
SELECT *
FROM
  (SELECT item_sk,
          d_date,
          web_sales,
          store_sales,
          max(web_sales) OVER (PARTITION BY item_sk
                               ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) web_cumulative,
                              max(store_sales) OVER (PARTITION BY item_sk
                                                     ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) store_cumulative
   FROM
     (SELECT CASE
                 WHEN web.item_sk IS NOT NULL THEN web.item_sk
                 ELSE store.item_sk
             END item_sk,
             CASE
                 WHEN web.d_date IS NOT NULL THEN web.d_date
                 ELSE store.d_date
             END d_date,
             web.cume_sales web_sales,
             store.cume_sales store_sales
      FROM web_v1 web
      FULL OUTER JOIN store_v1 store ON (web.item_sk = store.item_sk
                                         AND web.d_date = store.d_date))x)y
WHERE web_cumulative > store_cumulative
ORDER BY item_sk NULLS FIRST,
         d_date NULLS FIRST
LIMIT 100;
----
1 2000-01-03 49.67 0.20 49.67 0.20
7 2000-01-23 181.88 NULL 181.88 146.39
7 2000-02-04 239.65 NULL 239.65 230.60
8 2000-01-23 74.99 NULL 74.99 63.42
11 2000-01-23 223.53 NULL 223.53 100.29
11 2000-01-28 NULL 170.80 223.53 170.80
11 2000-02-04 278.55 NULL 278.55 170.80
11 2000-02-07 NULL 250.35 278.55 250.35
11 2000-02-27 NULL 263.55 278.55 263.55
11 2000-05-25 457.11 NULL 457.11 451.20
11 2000-05-30 516.04 NULL 516.04 451.20
11 2000-06-13 NULL 455.49 516.04 455.49
13 2000-01-06 NULL 38.27 215.37 38.27
13 2000-01-08 NULL 110.91 215.37 110.91
13 2000-01-12 NULL 153.25 215.37 153.25
13 2000-02-28 273.82 NULL 273.82 246.46
13 2000-03-01 NULL 256.92 273.82 256.92
19 2000-01-06 NULL 0.00 97.20 0.00
19 2000-01-13 NULL 45.54 97.20 45.54
19 2000-01-28 NULL 45.54 97.20 45.54
19 2000-02-07 NULL 55.97 97.20 55.97
19 2000-02-28 113.06 NULL 113.06 55.97
20 2000-01-23 77.39 NULL 77.39 29.75
20 2000-05-30 399.35 NULL 399.35 373.70
23 2000-02-02 14.07 NULL 14.07 3.21
23 2000-02-20 NULL 13.96 14.07 13.96
32 2000-02-04 126.47 NULL 126.47 52.95
38 2000-01-07 NULL 27.58 34.37 27.58
38 2000-01-17 NULL 30.75 34.37 30.75
38 2000-02-28 147.32 NULL 147.32 82.84
38 2000-03-11 NULL 107.74 147.32 107.74
44 2000-02-01 105.14 NULL 105.14 95.40
47 2000-01-03 204.35 NULL 204.35 122.62
47 2000-01-06 NULL 124.16 204.35 124.16
47 2000-01-13 NULL 124.98 204.35 124.98
47 2000-01-20 NULL 133.97 204.35 133.97
50 2000-01-06 NULL 97.72 148.98 97.72
50 2000-01-19 NULL 104.26 148.98 104.26
50 2000-01-29 169.86 NULL 169.86 104.26
50 2000-02-08 NULL 149.80 169.86 149.80
50 2000-02-16 NULL 151.55 169.86 151.55
50 2000-02-28 234.42 NULL 234.42 192.02
50 2000-03-01 NULL 193.26 234.42 193.26
50 2000-03-10 NULL 194.62 234.42 194.62
50 2000-04-19 NULL 216.06 234.42 216.06
50 2000-04-25 273.25 NULL 273.25 216.06
50 2000-04-29 NULL 217.00 273.25 217.00
50 2000-05-02 278.87 NULL 278.87 217.00
50 2000-05-15 433.18 NULL 433.18 291.83
50 2000-05-22 NULL 312.96 433.18 312.96
50 2000-06-10 NULL 321.30 433.18 321.30
50 2000-06-26 NULL 377.76 433.18 377.76
50 2000-06-30 NULL 404.21 433.18 404.21
53 2000-02-02 62.47 NULL 62.47 59.57
56 2000-01-06 NULL 11.41 110.40 11.41
62 2000-01-28 NULL 2.29 86.61 2.29
62 2000-01-29 177.44 NULL 177.44 2.29
62 2000-02-05 NULL 15.60 177.44 15.60
62 2000-02-07 NULL 28.81 177.44 28.81
62 2000-02-21 NULL 54.49 177.44 54.49
62 2000-02-24 NULL 58.26 177.44 58.26
62 2000-02-28 189.05 NULL 189.05 58.26
62 2000-03-05 NULL 63.19 189.05 63.19
62 2000-03-26 NULL 72.24 189.05 72.24
62 2000-04-22 NULL 76.07 189.05 76.07
62 2000-04-25 356.03 NULL 356.03 76.07
62 2000-04-28 NULL 159.79 356.03 159.79
62 2000-05-01 NULL 161.04 356.03 161.04
62 2000-05-02 365.24 NULL 365.24 161.04
62 2000-05-11 NULL 212.80 365.24 212.80
62 2000-05-15 393.79 NULL 393.79 212.80
62 2000-05-22 NULL 253.38 393.79 253.38
62 2000-06-19 NULL 355.16 393.79 355.16
62 2000-06-26 NULL 369.20 393.79 369.20
89 2000-01-03 156.24 NULL 156.24 47.35
89 2000-01-06 NULL 72.24 156.24 72.24
89 2000-01-13 NULL 142.00 156.24 142.00
91 2000-01-02 99.10 66.50 99.10 66.50
91 2000-01-06 NULL 96.22 99.10 96.22
92 2000-02-02 80.98 NULL 80.98 55.60
98 2000-02-28 180.36 NULL 180.36 166.58
103 2000-01-23 97.30 NULL 97.30 83.02
104 2000-02-01 52.42 NULL 52.42 19.47
107 2000-01-06 NULL 42.56 129.74 42.56
107 2000-01-08 NULL 68.81 129.74 68.81
107 2000-01-14 NULL 71.85 129.74 71.85
107 2000-03-02 148.85 77.43 148.85 77.43
107 2000-03-05 NULL 108.23 148.85 108.23
113 2000-01-06 NULL 29.89 86.14 29.89
113 2000-01-28 NULL 33.94 86.14 33.94
113 2000-02-05 NULL 38.93 86.14 38.93
113 2000-02-07 NULL 75.32 86.14 75.32
113 2000-02-28 122.39 NULL 122.39 103.94
113 2000-03-05 NULL 106.61 122.39 106.61
113 2000-03-26 NULL 108.17 122.39 108.17
121 2000-01-06 NULL 1.52 151.03 1.52
121 2000-01-12 NULL 23.71 151.03 23.71
121 2000-01-13 NULL 24.59 151.03 24.59
121 2000-01-21 NULL 104.74 151.03 104.74
121 2000-01-29 261.33 NULL 261.33 104.74

# Q52

query I
SELECT dt.d_year,
       item.i_brand_id brand_id,
       item.i_brand brand,
       sum(ss_ext_sales_price) ext_price
FROM date_dim dt,
     store_sales,
     item
WHERE dt.d_date_sk = store_sales.ss_sold_date_sk
  AND store_sales.ss_item_sk = item.i_item_sk
  AND item.i_manager_id = 1
  AND dt.d_moy=11
  AND dt.d_year=2000
GROUP BY dt.d_year,
         item.i_brand,
         item.i_brand_id
ORDER BY dt.d_year,
         ext_price DESC,
         brand_id
LIMIT 100 ;
----
2000 7008009 namelessbrand #9 47342.39

# Q53

query I
SELECT *
FROM
  (SELECT i_manufact_id,
          sum(ss_sales_price) sum_sales,
          avg(sum(ss_sales_price)) OVER (PARTITION BY i_manufact_id) avg_quarterly_sales
   FROM item,
        store_sales,
        date_dim,
        store
   WHERE ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND ss_store_sk = s_store_sk
     AND d_month_seq IN (1200,
                         1200+1,
                         1200+2,
                         1200+3,
                         1200+4,
                         1200+5,
                         1200+6,
                         1200+7,
                         1200+8,
                         1200+9,
                         1200+10,
                         1200+11)
     AND ((i_category IN ('Books',
                          'Children',
                          'Electronics')
           AND i_class IN ('personal',
                           'portable',
                           'reference',
                           'self-help')
           AND i_brand IN ('scholaramalgamalg #14',
                           'scholaramalgamalg #7',
                           'exportiunivamalg #9',
                           'scholaramalgamalg #9')) or(i_category IN ('Women','Music','Men')
                                                       AND i_class IN ('accessories','classical','fragrances','pants')
                                                       AND i_brand IN ('amalgimporto #1','edu packscholar #1','exportiimporto #1', 'importoamalg #1')))
   GROUP BY i_manufact_id,
            d_qoy) tmp1
WHERE CASE
          WHEN avg_quarterly_sales > 0 THEN ABS (sum_sales - avg_quarterly_sales)/ avg_quarterly_sales
          ELSE NULL
      END > 0.1
ORDER BY avg_quarterly_sales,
         sum_sales,
         i_manufact_id
LIMIT 100;
----
93 92.96 485.7950
93 432.51 485.7950
93 552.05 485.7950
93 865.66 485.7950

# Q54

query I
WITH my_customers AS
  (SELECT DISTINCT c_customer_sk,
                   c_current_addr_sk
   FROM
     (SELECT cs_sold_date_sk sold_date_sk,
             cs_bill_customer_sk customer_sk,
             cs_item_sk item_sk
      FROM catalog_sales
      UNION ALL SELECT ws_sold_date_sk sold_date_sk,
                       ws_bill_customer_sk customer_sk,
                       ws_item_sk item_sk
      FROM web_sales) cs_or_ws_sales,
        item,
        date_dim,
        customer
   WHERE sold_date_sk = d_date_sk
     AND item_sk = i_item_sk
     AND i_category = 'Women'
     AND i_class = 'maternity'
     AND c_customer_sk = cs_or_ws_sales.customer_sk
     AND d_moy = 12
     AND d_year = 1998 ),
     my_revenue AS
  (SELECT c_customer_sk,
          sum(ss_ext_sales_price) AS revenue
   FROM my_customers,
        store_sales,
        customer_address,
        store,
        date_dim
   WHERE c_current_addr_sk = ca_address_sk
     AND ca_county = s_county
     AND ca_state = s_state
     AND ss_sold_date_sk = d_date_sk
     AND c_customer_sk = ss_customer_sk
     AND d_month_seq BETWEEN
       (SELECT DISTINCT d_month_seq+1
        FROM date_dim
        WHERE d_year = 1998
          AND d_moy = 12) AND
       (SELECT DISTINCT d_month_seq+3
        FROM date_dim
        WHERE d_year = 1998
          AND d_moy = 12)
   GROUP BY c_customer_sk),
     segments AS
  (SELECT cast(round(revenue/50) AS int) AS SEGMENT
   FROM my_revenue)
SELECT SEGMENT,
       count(*) AS num_customers,
       SEGMENT*50 AS segment_base
FROM segments
GROUP BY SEGMENT
ORDER BY SEGMENT NULLS FIRST,
         num_customers NULLS FIRST,
         segment_base
LIMIT 100;
----

# Q55

query I
SELECT i_brand_id brand_id,
       i_brand brand,
       sum(ss_ext_sales_price) ext_price
FROM date_dim,
     store_sales,
     item
WHERE d_date_sk = ss_sold_date_sk
  AND ss_item_sk = i_item_sk
  AND i_manager_id=28
  AND d_moy=11
  AND d_year=1999
GROUP BY i_brand,
         i_brand_id
ORDER BY ext_price DESC,
         i_brand_id
LIMIT 100 ;
----
2001002 amalgimporto #2 33509.81

# Q56

query I
WITH ss AS
  (SELECT i_item_id,
          sum(ss_ext_sales_price) total_sales
   FROM store_sales,
        date_dim,
        customer_address,
        item
   WHERE i_item_id IN
       (SELECT i_item_id
        FROM item
        WHERE i_color IN ('slate',
                          'blanched',
                          'burnished'))
     AND ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND d_year = 2001
     AND d_moy = 2
     AND ss_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_item_id),
     cs AS
  (SELECT i_item_id,
          sum(cs_ext_sales_price) total_sales
   FROM catalog_sales,
        date_dim,
        customer_address,
        item
   WHERE i_item_id IN
       (SELECT i_item_id
        FROM item
        WHERE i_color IN ('slate',
                          'blanched',
                          'burnished'))
     AND cs_item_sk = i_item_sk
     AND cs_sold_date_sk = d_date_sk
     AND d_year = 2001
     AND d_moy = 2
     AND cs_bill_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_item_id),
     ws AS
  (SELECT i_item_id,
          sum(ws_ext_sales_price) total_sales
   FROM web_sales,
        date_dim,
        customer_address,
        item
   WHERE i_item_id IN
       (SELECT i_item_id
        FROM item
        WHERE i_color IN ('slate',
                          'blanched',
                          'burnished'))
     AND ws_item_sk = i_item_sk
     AND ws_sold_date_sk = d_date_sk
     AND d_year = 2001
     AND d_moy = 2
     AND ws_bill_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_item_id)
SELECT i_item_id,
       sum(total_sales) total_sales
FROM
  (SELECT *
   FROM ss
   UNION ALL SELECT *
   FROM cs
   UNION ALL SELECT *
   FROM ws) tmp1
GROUP BY i_item_id
ORDER BY total_sales  NULLS FIRST,
         i_item_id NULLS FIRST
LIMIT 100;
----

# Q57

query I
WITH v1 AS
  (SELECT i_category,
          i_brand,
          cc_name,
          d_year,
          d_moy,
          sum(cs_sales_price) sum_sales,
          avg(sum(cs_sales_price)) OVER (PARTITION BY i_category,
                                                      i_brand,
                                                      cc_name,
                                                      d_year) avg_monthly_sales,
                                        rank() OVER (PARTITION BY i_category,
                                                                  i_brand,
                                                                  cc_name
                                                     ORDER BY d_year,
                                                              d_moy) rn
   FROM item,
        catalog_sales,
        date_dim,
        call_center
   WHERE cs_item_sk = i_item_sk
     AND cs_sold_date_sk = d_date_sk
     AND cc_call_center_sk= cs_call_center_sk
     AND (d_year = 1999
          OR (d_year = 1999-1
              AND d_moy =12)
          OR (d_year = 1999+1
              AND d_moy =1))
   GROUP BY i_category,
            i_brand,
            cc_name,
            d_year,
            d_moy),
     v2 AS
  (SELECT v1.i_category,
          v1.i_brand,
          v1.cc_name,
          v1.d_year,
          v1.d_moy,
          v1.avg_monthly_sales,
          v1.sum_sales,
          v1_lag.sum_sales psum,
          v1_lead.sum_sales nsum
   FROM v1,
        v1 v1_lag,
        v1 v1_lead
   WHERE v1.i_category = v1_lag.i_category
     AND v1.i_category = v1_lead.i_category
     AND v1.i_brand = v1_lag.i_brand
     AND v1.i_brand = v1_lead.i_brand
     AND v1. cc_name = v1_lag. cc_name
     AND v1. cc_name = v1_lead. cc_name
     AND v1.rn = v1_lag.rn + 1
     AND v1.rn = v1_lead.rn - 1)
SELECT *
FROM v2
WHERE d_year = 1999
  AND avg_monthly_sales > 0
  AND CASE
          WHEN avg_monthly_sales > 0 THEN abs(sum_sales - avg_monthly_sales) / avg_monthly_sales
          ELSE NULL
      END > 0.1
ORDER BY sum_sales - avg_monthly_sales NULLS FIRST, 1, 2, 3, 4, 5, 6, 7, 8, 9
LIMIT 100;
----
Shoes exportiedu pack #1 NY Metro 1999 4 728.8900 315.26 553.82 787.84
Men amalgimporto #2 NY Metro 1999 1 408.0958 29.35 737.27 158.45
Children edu packexporti #2 NY Metro 1999 1 405.8316 30.01 418.46 141.80
Men edu packimporto #1 NY Metro 1999 7 966.5591 625.60 776.23 1018.94
Music amalgscholar #1 NY Metro 1999 1 352.8691 18.53 918.61 496.83
Shoes edu packedu pack #1 NY Metro 1999 9 664.0391 332.60 579.24 416.10
Children amalgexporti #1 NY Metro 1999 8 521.6425 193.69 498.30 555.58
Shoes exportiedu pack #1 NY Metro 1999 2 728.8900 405.80 806.09 553.82
Men edu packimporto #1 NY Metro 1999 5 966.5591 656.29 773.85 776.23
Shoes exportiedu pack #1 NY Metro 1999 6 728.8900 429.27 787.84 654.37
Women amalgamalg #1 NY Metro 1999 1 347.6875 49.38 790.57 473.52
Women importoamalg #1 NY Metro 1999 7 557.5125 260.91 417.86 552.20
Men amalgimporto #2 NY Metro 1999 3 408.0958 115.29 158.45 491.05
Men edu packimporto #1 NY Metro 1999 1 966.5591 679.43 2144.82 967.28
Children edu packexporti #2 NY Metro 1999 9 405.8316 123.41 508.54 451.37
Music exportischolar #2 NY Metro 1999 4 500.1391 229.83 670.81 407.31
Music amalgscholar #1 NY Metro 1999 10 352.8691 82.86 209.87 739.40
Children edu packexporti #2 NY Metro 1999 2 405.8316 141.80 30.01 187.39
Men amalgimporto #2 NY Metro 1999 6 408.0958 144.33 294.86 363.35
Children edu packexporti #2 NY Metro 1999 5 405.8316 147.54 473.87 400.44
Women importoamalg #1 NY Metro 1999 1 557.5125 306.32 848.92 490.89
Men amalgimporto #2 NY Metro 1999 2 408.0958 158.45 29.35 115.29
Shoes edu packedu pack #1 NY Metro 1999 10 664.0391 416.10 332.60 1063.05
Shoes importoedu pack #1 NY Metro 1999 6 284.3660 39.64 341.59 384.23
Books scholarunivamalg #8 NY Metro 1999 6 284.9845 49.74 367.46 64.26
Children amalgexporti #1 NY Metro 1999 4 521.6425 291.57 432.57 784.04
Children importoexporti #1 NY Metro 1999 10 384.4316 154.98 525.58 465.68
Shoes edu packedu pack #1 NY Metro 1999 2 664.0391 441.17 617.45 1155.31
Books scholarunivamalg #8 NY Metro 1999 7 284.9845 64.26 49.74 179.27
Women edu packamalg #2 NY Metro 1999 10 343.7283 125.04 212.41 512.73
Men edu packimporto #2 NY Metro 1999 3 407.7608 189.24 211.04 232.91
Children edu packexporti #2 NY Metro 1999 3 405.8316 187.39 141.80 473.87
Books exportiunivamalg #2 NY Metro 1999 7 394.6058 179.71 190.28 416.14
Electronics maxiunivamalg #12 NY Metro 1999 10 222.7008 7.92 205.98 403.60
Women amalgamalg #1 NY Metro 1999 4 347.6875 134.37 322.21 157.27
Sports maxinameless #5 NY Metro 1999 6 264.7010 53.15 431.58 271.80
Children exportiexporti #1 NY Metro 1999 5 292.9716 81.80 106.34 340.82
Children amalgexporti #1 NY Metro 1999 10 521.6425 311.58 555.58 602.01
Books brandmaxi #2 NY Metro 1999 4 216.5016 10.72 344.14 197.30
Books brandmaxi #2 NY Metro 1999 10 216.5016 11.25 81.10 425.39
Books exportiunivamalg #2 NY Metro 1999 6 394.6058 190.28 391.46 179.71
Electronics corpamalgamalg #12 NY Metro 1999 6 201.4345 4.50 40.21 166.06
Men edu packimporto #2 NY Metro 1999 2 407.7608 211.04 396.74 189.24
Books brandmaxi #2 NY Metro 1999 2 216.5016 20.46 358.21 344.14
Music exportischolar #2 NY Metro 1999 1 500.1391 304.58 1333.47 369.44
Sports maxinameless #5 NY Metro 1999 1 264.7010 71.81 538.44 157.68
Men edu packimporto #1 NY Metro 1999 4 966.5591 773.85 1006.53 656.29
Women edu packamalg #2 NY Metro 1999 12 343.7283 151.24 512.73 940.66
Electronics corpunivamalg #7 NY Metro 1999 9 192.2433 0.96 184.13 119.60
Children amalgexporti #1 NY Metro 1999 6 521.6425 330.43 784.04 498.30
Women amalgamalg #1 NY Metro 1999 5 347.6875 157.27 134.37 225.97
Men edu packimporto #1 NY Metro 1999 6 966.5591 776.23 656.29 625.60
Jewelry importobrand #6 NY Metro 1999 10 224.9550 34.97 316.41 427.82
Sports scholarmaxi #2 NY Metro 1999 1 211.7200 23.15 626.64 261.10
Shoes edu packedu pack #1 NY Metro 1999 6 664.0391 475.55 600.92 635.35
Music amalgscholar #1 NY Metro 1999 4 352.8691 164.75 519.80 194.77
Children exportiexporti #1 NY Metro 1999 4 292.9716 106.34 307.84 81.80
Home namelessbrand #9 NY Metro 1999 6 188.2836 2.47 91.40 136.19
Women edu packamalg #2 NY Metro 1999 4 343.7283 158.42 602.19 239.43
Books univunivamalg #8 NY Metro 1999 1 184.7341 1.94 356.41 117.94
Sports edu packnameless #1 NY Metro 1999 6 250.2618 69.86 302.74 273.64
Music importoscholar #1 NY Metro 1999 7 206.5591 27.37 259.06 123.67
Books scholarunivamalg #8 NY Metro 1999 2 284.9845 106.43 428.19 169.06
Sports maxinameless #3 NY Metro 1999 8 203.1581 25.64 39.54 44.69
Shoes exportiedu pack #1 NY Metro 1999 3 728.8900 553.82 405.80 315.26
Men edu packimporto #2 NY Metro 1999 4 407.7608 232.91 189.24 429.69
Jewelry importobrand #6 NY Metro 1999 8 224.9550 50.79 136.03 316.41
Jewelry edu packcorp #7 NY Metro 1999 7 190.9075 16.99 431.58 23.77
Home corpnameless #6 NY Metro 1999 4 184.9441 12.95 168.28 129.11
Electronics corpunivamalg #7 NY Metro 1999 6 192.2433 20.87 21.76 224.37
Electronics corpunivamalg #7 NY Metro 1999 5 192.2433 21.76 449.19 20.87
Home exportibrand #8 NY Metro 1999 3 222.0525 52.23 242.45 178.29
Jewelry importobrand #7 NY Metro 1999 4 173.5558 5.67 183.44 43.91
Home exportibrand #8 NY Metro 1999 1 222.0525 54.35 509.06 242.45
Books scholarunivamalg #2 NY Metro 1999 11 188.3991 21.21 131.01 380.11
Jewelry edu packcorp #7 NY Metro 1999 8 190.9075 23.77 16.99 70.48
Electronics maxiunivamalg #12 NY Metro 1999 7 222.7008 55.84 331.05 114.48
Women exportiamalg #2 NY Metro 1999 8 167.7891 2.38 274.94 175.62
Jewelry amalgbrand #3 NY Metro 1999 4 178.1350 13.71 234.51 724.54
Sports maxinameless #3 NY Metro 1999 7 203.1581 39.54 171.25 25.64
Sports namelessnameless #9 NY Metro 1999 9 172.8172 9.37 81.39 246.32
Jewelry amalgbrand #2 NY Metro 1999 1 179.1530 15.85 262.43 171.97
Books univunivamalg #8 NY Metro 1999 5 184.7341 22.40 37.96 324.75
Music amalgscholar #1 NY Metro 1999 7 352.8691 191.00 496.04 427.98
Electronics corpamalgamalg #12 NY Metro 1999 5 201.4345 40.21 49.83 4.50
Books corpmaxi #3 NY Metro 1999 9 192.9391 31.95 208.56 265.88
Home exportibrand #8 NY Metro 1999 8 222.0525 61.90 231.04 394.26
Jewelry importobrand #7 NY Metro 1999 10 173.5558 13.63 298.07 386.13
Home edu packbrand #9 NY Metro 1999 4 187.9760 29.41 56.16 310.27
Sports maxinameless #3 NY Metro 1999 10 203.1581 44.69 25.64 464.65
Women exportiamalg #2 NY Metro 1999 3 167.7891 9.39 12.59 124.17
Music amalgscholar #1 NY Metro 1999 5 352.8691 194.77 164.75 496.04
Electronics amalgamalgamalg #6 NY Metro 1999 5 222.2600 64.46 142.85 196.81
Women importoamalg #1 NY Metro 1999 3 557.5125 402.04 490.89 496.28
Books exportiunivamalg #2 NY Metro 1999 3 394.6058 239.39 495.80 293.81
Women exportiamalg #2 NY Metro 1999 2 167.7891 12.59 341.56 9.39
Jewelry amalgbrand #3 NY Metro 1999 1 178.1350 23.48 392.61 37.22
Children exportiexporti #1 NY Metro 1999 10 292.9716 138.38 153.96 281.68
Sports brandnameless #5 NY Metro 1999 1 155.7718 1.32 200.71 25.42
Music exportischolar #1 NY Metro 1999 1 172.8054 18.74 260.89 20.25

# Q58

query I
WITH ss_items AS
  (SELECT i_item_id item_id,
          sum(ss_ext_sales_price) ss_item_rev
   FROM store_sales,
        item,
        date_dim
   WHERE ss_item_sk = i_item_sk
     AND d_date IN
       (SELECT d_date
        FROM date_dim
        WHERE d_week_seq =
            (SELECT d_week_seq
             FROM date_dim
             WHERE d_date = '2000-01-03'))
     AND ss_sold_date_sk = d_date_sk
   GROUP BY i_item_id),
     cs_items AS
  (SELECT i_item_id item_id,
          sum(cs_ext_sales_price) cs_item_rev
   FROM catalog_sales,
        item,
        date_dim
   WHERE cs_item_sk = i_item_sk
     AND d_date IN
       (SELECT d_date
        FROM date_dim
        WHERE d_week_seq =
            (SELECT d_week_seq
             FROM date_dim
             WHERE d_date = '2000-01-03'))
     AND cs_sold_date_sk = d_date_sk
   GROUP BY i_item_id),
     ws_items AS
  (SELECT i_item_id item_id,
          sum(ws_ext_sales_price) ws_item_rev
   FROM web_sales,
        item,
        date_dim
   WHERE ws_item_sk = i_item_sk
     AND d_date IN
       (SELECT d_date
        FROM date_dim
        WHERE d_week_seq =
            (SELECT d_week_seq
             FROM date_dim
             WHERE d_date = '2000-01-03'))
     AND ws_sold_date_sk = d_date_sk
   GROUP BY i_item_id)
SELECT ss_items.item_id,
       ss_item_rev,
       ss_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 ss_dev,
       cs_item_rev,
       cs_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 cs_dev,
       ws_item_rev,
       ws_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 ws_dev,
       (ss_item_rev+cs_item_rev+ws_item_rev)/3 average
FROM ss_items,
     cs_items,
     ws_items
WHERE ss_items.item_id=cs_items.item_id
  AND ss_items.item_id=ws_items.item_id
  AND ss_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev
  AND ss_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev
  AND cs_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev
  AND cs_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev
  AND ws_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev
  AND ws_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev
ORDER BY ss_items.item_id NULLS FIRST,
         ss_item_rev NULLS FIRST
LIMIT 100;
----

# Q59

query I
WITH wss AS
  (SELECT d_week_seq,
          ss_store_sk,
          sum(CASE
                  WHEN (d_day_name='Sunday') THEN ss_sales_price
                  ELSE NULL
              END) sun_sales,
          sum(CASE
                  WHEN (d_day_name='Monday') THEN ss_sales_price
                  ELSE NULL
              END) mon_sales,
          sum(CASE
                  WHEN (d_day_name='Tuesday') THEN ss_sales_price
                  ELSE NULL
              END) tue_sales,
          sum(CASE
                  WHEN (d_day_name='Wednesday') THEN ss_sales_price
                  ELSE NULL
              END) wed_sales,
          sum(CASE
                  WHEN (d_day_name='Thursday') THEN ss_sales_price
                  ELSE NULL
              END) thu_sales,
          sum(CASE
                  WHEN (d_day_name='Friday') THEN ss_sales_price
                  ELSE NULL
              END) fri_sales,
          sum(CASE
                  WHEN (d_day_name='Saturday') THEN ss_sales_price
                  ELSE NULL
              END) sat_sales
   FROM store_sales,
        date_dim
   WHERE d_date_sk = ss_sold_date_sk
   GROUP BY d_week_seq,
            ss_store_sk)
SELECT s_store_name1,
       s_store_id1,
       d_week_seq1,
       sun_sales1/sun_sales2 AS sun_sales_ratio,
       mon_sales1/mon_sales2 AS mon_sales_ratio,
       tue_sales1/tue_sales2 AS tue_sales_ratio,
       wed_sales1/wed_sales2 AS wed_sales_ratio,
       thu_sales1/thu_sales2 AS thu_sales_ratio,
       fri_sales1/fri_sales2 AS fri_sales_ratio,
       sat_sales1/sat_sales2 AS sat_sales_ratio
FROM
  (SELECT s_store_name s_store_name1,
          wss.d_week_seq d_week_seq1,
          s_store_id s_store_id1,
          sun_sales sun_sales1,
          mon_sales mon_sales1,
          tue_sales tue_sales1,
          wed_sales wed_sales1,
          thu_sales thu_sales1,
          fri_sales fri_sales1,
          sat_sales sat_sales1
   FROM wss,
        store,
        date_dim d
   WHERE d.d_week_seq = wss.d_week_seq
     AND ss_store_sk = s_store_sk
     AND d_month_seq BETWEEN 1212 AND 1212 + 11) y,
  (SELECT s_store_name s_store_name2,
          wss.d_week_seq d_week_seq2,
          s_store_id s_store_id2,
          sun_sales sun_sales2,
          mon_sales mon_sales2,
          tue_sales tue_sales2,
          wed_sales wed_sales2,
          thu_sales thu_sales2,
          fri_sales fri_sales2,
          sat_sales sat_sales2
   FROM wss,
        store,
        date_dim d
   WHERE d.d_week_seq = wss.d_week_seq
     AND ss_store_sk = s_store_sk
     AND d_month_seq BETWEEN 1212 + 12 AND 1212 + 23) x
WHERE s_store_id1=s_store_id2
  AND d_week_seq1=d_week_seq2-52
ORDER BY s_store_name1 NULLS FIRST,
         s_store_id1 NULLS FIRST,
         d_week_seq1 NULLS FIRST
LIMIT 100;
----
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5271 1.77344503 NULL NULL 0.35756974 NULL NULL 0.49289879
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5272 NULL NULL NULL 3.21788682 NULL NULL NULL
ought AAAAAAAABAAAAAAA 5273 NULL NULL 3.33398397 NULL NULL NULL NULL
ought AAAAAAAABAAAAAAA 5273 NULL NULL 3.33398397 NULL NULL NULL NULL

# Q60

query I
WITH ss AS
  (SELECT i_item_id,
          sum(ss_ext_sales_price) total_sales
   FROM store_sales,
        date_dim,
        customer_address,
        item
   WHERE i_item_id IN
       (SELECT i_item_id
        FROM item
        WHERE i_category ='Music')
     AND ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND d_year = 1998
     AND d_moy = 9
     AND ss_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_item_id),
     cs AS
  (SELECT i_item_id,
          sum(cs_ext_sales_price) total_sales
   FROM catalog_sales,
        date_dim,
        customer_address,
        item
   WHERE i_item_id IN
       (SELECT i_item_id
        FROM item
        WHERE i_category ='Music')
     AND cs_item_sk = i_item_sk
     AND cs_sold_date_sk = d_date_sk
     AND d_year = 1998
     AND d_moy = 9
     AND cs_bill_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_item_id),
     ws AS
  (SELECT i_item_id,
          sum(ws_ext_sales_price) total_sales
   FROM web_sales,
        date_dim,
        customer_address,
        item
   WHERE i_item_id IN
       (SELECT i_item_id
        FROM item
        WHERE i_category = 'Music')
     AND ws_item_sk = i_item_sk
     AND ws_sold_date_sk = d_date_sk
     AND d_year = 1998
     AND d_moy = 9
     AND ws_bill_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_item_id)
SELECT i_item_id,
       sum(total_sales) total_sales
FROM
  (SELECT *
   FROM ss
   UNION ALL SELECT *
   FROM cs
   UNION ALL SELECT *
   FROM ws) tmp1
GROUP BY i_item_id
ORDER BY i_item_id,
         total_sales
LIMIT 100;
----

# Q61

query I
SELECT promotions,
       total,
       cast(promotions AS decimal(15,4) NULL)/cast(total AS decimal(15,4) NULL)*100
FROM
  (SELECT sum(ss_ext_sales_price) promotions
   FROM store_sales,
        store,
        promotion,
        date_dim,
        customer,
        customer_address,
        item
   WHERE ss_sold_date_sk = d_date_sk
     AND ss_store_sk = s_store_sk
     AND ss_promo_sk = p_promo_sk
     AND ss_customer_sk= c_customer_sk
     AND ca_address_sk = c_current_addr_sk
     AND ss_item_sk = i_item_sk
     AND ca_gmt_offset = -5
     AND i_category = 'Jewelry'
     AND (p_channel_dmail = 'Y'
          OR p_channel_email = 'Y'
          OR p_channel_tv = 'Y')
     AND s_gmt_offset = -5
     AND d_year = 1998
     AND d_moy = 11) promotional_sales,
  (SELECT sum(ss_ext_sales_price) total
   FROM store_sales,
        store,
        date_dim,
        customer,
        customer_address,
        item
   WHERE ss_sold_date_sk = d_date_sk
     AND ss_store_sk = s_store_sk
     AND ss_customer_sk= c_customer_sk
     AND ca_address_sk = c_current_addr_sk
     AND ss_item_sk = i_item_sk
     AND ca_gmt_offset = -5
     AND i_category = 'Jewelry'
     AND s_gmt_offset = -5
     AND d_year = 1998
     AND d_moy = 11) all_sales
ORDER BY promotions,
         total
LIMIT 100;
----
NULL NULL NULL

# Q62

query I
SELECT w_substr,
       sm_type,
       web_name,
       sum(CASE
               WHEN (ws_ship_date_sk - ws_sold_date_sk <= 30) THEN 1
               ELSE 0
           END) AS "30 days",
       sum(CASE
               WHEN (ws_ship_date_sk - ws_sold_date_sk > 30)
                    AND (ws_ship_date_sk - ws_sold_date_sk <= 60) THEN 1
               ELSE 0
           END) AS "31-60 days",
       sum(CASE
               WHEN (ws_ship_date_sk - ws_sold_date_sk > 60)
                    AND (ws_ship_date_sk - ws_sold_date_sk <= 90) THEN 1
               ELSE 0
           END) AS "61-90 days",
       sum(CASE
               WHEN (ws_ship_date_sk - ws_sold_date_sk > 90)
                    AND (ws_ship_date_sk - ws_sold_date_sk <= 120) THEN 1
               ELSE 0
           END) AS "91-120 days",
       sum(CASE
               WHEN (ws_ship_date_sk - ws_sold_date_sk > 120) THEN 1
               ELSE 0
           END) AS ">120 days"
FROM web_sales,
  (SELECT SUBSTRING(w_warehouse_name,1,20) w_substr,
          *
   FROM warehouse) sq1,
     ship_mode,
     web_site,
     date_dim
WHERE d_month_seq BETWEEN 1200 AND 1200 + 11
  AND ws_ship_date_sk = d_date_sk
  AND ws_warehouse_sk = w_warehouse_sk
  AND ws_ship_mode_sk = sm_ship_mode_sk
  AND ws_web_site_sk = web_site_sk
GROUP BY w_substr,
         sm_type,
         web_name
ORDER BY 1 NULLS FIRST,
         2 NULLS FIRST,
         3 NULLS FIRST
LIMIT 100;
----
Conventional childr EXPRESS site_0 85 64 59 59 0
Conventional childr LIBRARY site_0 59 39 57 44 0
Conventional childr NEXT DAY site_0 61 67 65 67 0
Conventional childr OVERNIGHT site_0 39 50 57 44 0
Conventional childr REGULAR site_0 49 55 38 65 0
Conventional childr TWO DAY site_0 60 46 44 45 0

# Q63

query I
SELECT *
FROM
  (SELECT i_manager_id,
          sum(ss_sales_price) sum_sales,
          avg(sum(ss_sales_price)) OVER (PARTITION BY i_manager_id) avg_monthly_sales
   FROM item,
        store_sales,
        date_dim,
        store
   WHERE ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND ss_store_sk = s_store_sk
     AND d_month_seq IN (1200,
                         1200+1,
                         1200+2,
                         1200+3,
                         1200+4,
                         1200+5,
                         1200+6,
                         1200+7,
                         1200+8,
                         1200+9,
                         1200+10,
                         1200+11)
     AND ((i_category IN ('Books',
                          'Children',
                          'Electronics')
           AND i_class IN ('personal',
                           'portable',
                           'reference',
                           'self-help')
           AND i_brand IN ('scholaramalgamalg #14',
                           'scholaramalgamalg #7',
                           'exportiunivamalg #9',
                           'scholaramalgamalg #9')) or(i_category IN ('Women','Music','Men')
                                                       AND i_class IN ('accessories','classical','fragrances','pants')
                                                       AND i_brand IN ('amalgimporto #1','edu packscholar #1','exportiimporto #1', 'importoamalg #1')))
   GROUP BY i_manager_id,
            d_moy) tmp1
WHERE CASE
          WHEN avg_monthly_sales > 0 THEN ABS (sum_sales - avg_monthly_sales) / avg_monthly_sales
          ELSE NULL
      END > 0.1
ORDER BY i_manager_id,
         avg_monthly_sales,
         sum_sales
LIMIT 100;
----
11 40.16 176.6527
11 52.80 176.6527
11 65.63 176.6527
11 82.46 176.6527
11 97.37 176.6527
11 99.53 176.6527
11 110.27 176.6527
11 259.22 176.6527
11 269.51 176.6527
11 370.06 176.6527
11 496.17 176.6527

# Q64

query I
WITH cs_ui AS
  (SELECT cs_item_sk,
          sum(cs_ext_list_price) AS sale,
          sum(cr_refunded_cash+cr_reversed_charge+cr_store_credit) AS refund
   FROM catalog_sales,
        catalog_returns
   WHERE cs_item_sk = cr_item_sk
     AND cs_order_number = cr_order_number
   GROUP BY cs_item_sk
   HAVING sum(cs_ext_list_price)>2*sum(cr_refunded_cash+cr_reversed_charge+cr_store_credit)),
     cross_sales AS
  (SELECT i_product_name product_name,
          i_item_sk item_sk,
          s_store_name store_name,
          s_zip store_zip,
          ad1.ca_street_number b_street_number,
          ad1.ca_street_name b_street_name,
          ad1.ca_city b_city,
          ad1.ca_zip b_zip,
          ad2.ca_street_number c_street_number,
          ad2.ca_street_name c_street_name,
          ad2.ca_city c_city,
          ad2.ca_zip c_zip,
          d1.d_year AS syear,
          d2.d_year AS fsyear,
          d3.d_year s2year,
          count(*) cnt,
          sum(ss_wholesale_cost) s1,
          sum(ss_list_price) s2,
          sum(ss_coupon_amt) s3
   FROM store_sales,
        store_returns,
        cs_ui,
        date_dim d1,
        date_dim d2,
        date_dim d3,
        store,
        customer,
        customer_demographics cd1,
        customer_demographics cd2,
        promotion,
        household_demographics hd1,
        household_demographics hd2,
        customer_address ad1,
        customer_address ad2,
        income_band ib1,
        income_band ib2,
        item
   WHERE ss_store_sk = s_store_sk
     AND ss_sold_date_sk = d1.d_date_sk
     AND ss_customer_sk = c_customer_sk
     AND ss_cdemo_sk= cd1.cd_demo_sk
     AND ss_hdemo_sk = hd1.hd_demo_sk
     AND ss_addr_sk = ad1.ca_address_sk
     AND ss_item_sk = i_item_sk
     AND ss_item_sk = sr_item_sk
     AND ss_ticket_number = sr_ticket_number
     AND ss_item_sk = cs_ui.cs_item_sk
     AND c_current_cdemo_sk = cd2.cd_demo_sk
     AND c_current_hdemo_sk = hd2.hd_demo_sk
     AND c_current_addr_sk = ad2.ca_address_sk
     AND c_first_sales_date_sk = d2.d_date_sk
     AND c_first_shipto_date_sk = d3.d_date_sk
     AND ss_promo_sk = p_promo_sk
     AND hd1.hd_income_band_sk = ib1.ib_income_band_sk
     AND hd2.hd_income_band_sk = ib2.ib_income_band_sk
     AND cd1.cd_marital_status <> cd2.cd_marital_status
     AND i_color IN ('purple',
                     'burlywood',
                     'indian',
                     'spring',
                     'floral',
                     'medium')
     AND i_current_price BETWEEN 64 AND 64 + 10
     AND i_current_price BETWEEN 64 + 1 AND 64 + 15
   GROUP BY i_product_name,
            i_item_sk,
            s_store_name,
            s_zip,
            ad1.ca_street_number,
            ad1.ca_street_name,
            ad1.ca_city,
            ad1.ca_zip,
            ad2.ca_street_number,
            ad2.ca_street_name,
            ad2.ca_city,
            ad2.ca_zip,
            d1.d_year,
            d2.d_year,
            d3.d_year)
SELECT cs1.product_name,
       cs1.store_name,
       cs1.store_zip,
       cs1.b_street_number,
       cs1.b_street_name,
       cs1.b_city,
       cs1.b_zip,
       cs1.c_street_number,
       cs1.c_street_name,
       cs1.c_city,
       cs1.c_zip,
       cs1.syear cs1syear,
       cs1.cnt cs1cnt,
       cs1.s1 AS s11,
       cs1.s2 AS s21,
       cs1.s3 AS s31,
       cs2.s1 AS s12,
       cs2.s2 AS s22,
       cs2.s3 AS s32,
       cs2.syear,
       cs2.cnt
FROM cross_sales cs1,
     cross_sales cs2
WHERE cs1.item_sk=cs2.item_sk
  AND cs1.syear = 1999
  AND cs2.syear = 1999 + 1
  AND cs2.cnt <= cs1.cnt
  AND cs1.store_name = cs2.store_name
  AND cs1.store_zip = cs2.store_zip
ORDER BY cs1.product_name,
         cs1.store_name,
         cs2.cnt,
         cs1.s1,
         cs2.s1;
----

# Q65

query I
SELECT s_store_name,
       i_item_desc,
       sc.revenue,
       i_current_price,
       i_wholesale_cost,
       i_brand
FROM store,
     item,
  (SELECT ss_store_sk,
          avg(revenue) AS ave
   FROM
     (SELECT ss_store_sk,
             ss_item_sk,
             sum(ss_sales_price) AS revenue
      FROM store_sales,
           date_dim
      WHERE ss_sold_date_sk = d_date_sk
        AND d_month_seq BETWEEN 1176 AND 1176+11
      GROUP BY ss_store_sk,
               ss_item_sk) sa
   GROUP BY ss_store_sk) sb,
  (SELECT ss_store_sk,
          ss_item_sk,
          sum(ss_sales_price) AS revenue
   FROM store_sales,
        date_dim
   WHERE ss_sold_date_sk = d_date_sk
     AND d_month_seq BETWEEN 1176 AND 1176+11
   GROUP BY ss_store_sk,
            ss_item_sk) sc
WHERE sb.ss_store_sk = sc.ss_store_sk
  AND sc.revenue <= 0.1 * sb.ave
  AND s_store_sk = sc.ss_store_sk
  AND i_item_sk = sc.ss_item_sk
ORDER BY s_store_name NULLS FIRST,
         i_item_desc NULLS FIRST
LIMIT 100;
----


# Q66

query I
select
         w_warehouse_name
  ,w_warehouse_sq_ft
  ,w_city
  ,w_county
  ,w_state
  ,w_country
        ,ship_carriers
        ,year_
  ,sum(jan_sales) as jan_sales
  ,sum(feb_sales) as feb_sales
  ,sum(mar_sales) as mar_sales
  ,sum(apr_sales) as apr_sales
  ,sum(may_sales) as may_sales
  ,sum(jun_sales) as jun_sales
  ,sum(jul_sales) as jul_sales
  ,sum(aug_sales) as aug_sales
  ,sum(sep_sales) as sep_sales
  ,sum(oct_sales) as oct_sales
  ,sum(nov_sales) as nov_sales
  ,sum(dec_sales) as dec_sales
  ,sum(jan_sales/w_warehouse_sq_ft) as jan_sales_per_sq_foot
  ,sum(feb_sales/w_warehouse_sq_ft) as feb_sales_per_sq_foot
  ,sum(mar_sales/w_warehouse_sq_ft) as mar_sales_per_sq_foot
  ,sum(apr_sales/w_warehouse_sq_ft) as apr_sales_per_sq_foot
  ,sum(may_sales/w_warehouse_sq_ft) as may_sales_per_sq_foot
  ,sum(jun_sales/w_warehouse_sq_ft) as jun_sales_per_sq_foot
  ,sum(jul_sales/w_warehouse_sq_ft) as jul_sales_per_sq_foot
  ,sum(aug_sales/w_warehouse_sq_ft) as aug_sales_per_sq_foot
  ,sum(sep_sales/w_warehouse_sq_ft) as sep_sales_per_sq_foot
  ,sum(oct_sales/w_warehouse_sq_ft) as oct_sales_per_sq_foot
  ,sum(nov_sales/w_warehouse_sq_ft) as nov_sales_per_sq_foot
  ,sum(dec_sales/w_warehouse_sq_ft) as dec_sales_per_sq_foot
  ,sum(jan_net) as jan_net
  ,sum(feb_net) as feb_net
  ,sum(mar_net) as mar_net
  ,sum(apr_net) as apr_net
  ,sum(may_net) as may_net
  ,sum(jun_net) as jun_net
  ,sum(jul_net) as jul_net
  ,sum(aug_net) as aug_net
  ,sum(sep_net) as sep_net
  ,sum(oct_net) as oct_net
  ,sum(nov_net) as nov_net
  ,sum(dec_net) as dec_net
 from (
     select
  w_warehouse_name
  ,w_warehouse_sq_ft
  ,w_city
  ,w_county
  ,w_state
  ,w_country
  ,'DHL,BARIAN' as ship_carriers
       ,d_year as year_
  ,sum(case when d_moy = 1
    then ws_ext_sales_price* ws_quantity else 0 end) as jan_sales
  ,sum(case when d_moy = 2
    then ws_ext_sales_price* ws_quantity else 0 end) as feb_sales
  ,sum(case when d_moy = 3
    then ws_ext_sales_price* ws_quantity else 0 end) as mar_sales
  ,sum(case when d_moy = 4
    then ws_ext_sales_price* ws_quantity else 0 end) as apr_sales
  ,sum(case when d_moy = 5
    then ws_ext_sales_price* ws_quantity else 0 end) as may_sales
  ,sum(case when d_moy = 6
    then ws_ext_sales_price* ws_quantity else 0 end) as jun_sales
  ,sum(case when d_moy = 7
    then ws_ext_sales_price* ws_quantity else 0 end) as jul_sales
  ,sum(case when d_moy = 8
    then ws_ext_sales_price* ws_quantity else 0 end) as aug_sales
  ,sum(case when d_moy = 9
    then ws_ext_sales_price* ws_quantity else 0 end) as sep_sales
  ,sum(case when d_moy = 10
    then ws_ext_sales_price* ws_quantity else 0 end) as oct_sales
  ,sum(case when d_moy = 11
    then ws_ext_sales_price* ws_quantity else 0 end) as nov_sales
  ,sum(case when d_moy = 12
    then ws_ext_sales_price* ws_quantity else 0 end) as dec_sales
  ,sum(case when d_moy = 1
    then ws_net_paid * ws_quantity else 0 end) as jan_net
  ,sum(case when d_moy = 2
    then ws_net_paid * ws_quantity else 0 end) as feb_net
  ,sum(case when d_moy = 3
    then ws_net_paid * ws_quantity else 0 end) as mar_net
  ,sum(case when d_moy = 4
    then ws_net_paid * ws_quantity else 0 end) as apr_net
  ,sum(case when d_moy = 5
    then ws_net_paid * ws_quantity else 0 end) as may_net
  ,sum(case when d_moy = 6
    then ws_net_paid * ws_quantity else 0 end) as jun_net
  ,sum(case when d_moy = 7
    then ws_net_paid * ws_quantity else 0 end) as jul_net
  ,sum(case when d_moy = 8
    then ws_net_paid * ws_quantity else 0 end) as aug_net
  ,sum(case when d_moy = 9
    then ws_net_paid * ws_quantity else 0 end) as sep_net
  ,sum(case when d_moy = 10
    then ws_net_paid * ws_quantity else 0 end) as oct_net
  ,sum(case when d_moy = 11
    then ws_net_paid * ws_quantity else 0 end) as nov_net
  ,sum(case when d_moy = 12
    then ws_net_paid * ws_quantity else 0 end) as dec_net
     from
          web_sales
         ,warehouse
         ,date_dim
         ,time_dim
    ,ship_mode
     where
            ws_warehouse_sk =  w_warehouse_sk
        and ws_sold_date_sk = d_date_sk
        and ws_sold_time_sk = t_time_sk
  and ws_ship_mode_sk = sm_ship_mode_sk
        and d_year = 2001
  and t_time between 30838 and 30838+28800
  and sm_carrier in ('DHL','BARIAN')
     group by
        w_warehouse_name
  ,w_warehouse_sq_ft
  ,w_city
  ,w_county
  ,w_state
  ,w_country
       ,d_year
 union all
     select
  w_warehouse_name
  ,w_warehouse_sq_ft
  ,w_city
  ,w_county
  ,w_state
  ,w_country
  ,'DHL,BARIAN' as ship_carriers
       ,d_year as year_
  ,sum(case when d_moy = 1
    then cs_sales_price* cs_quantity else 0 end) as jan_sales
  ,sum(case when d_moy = 2
    then cs_sales_price* cs_quantity else 0 end) as feb_sales
  ,sum(case when d_moy = 3
    then cs_sales_price* cs_quantity else 0 end) as mar_sales
  ,sum(case when d_moy = 4
    then cs_sales_price* cs_quantity else 0 end) as apr_sales
  ,sum(case when d_moy = 5
    then cs_sales_price* cs_quantity else 0 end) as may_sales
  ,sum(case when d_moy = 6
    then cs_sales_price* cs_quantity else 0 end) as jun_sales
  ,sum(case when d_moy = 7
    then cs_sales_price* cs_quantity else 0 end) as jul_sales
  ,sum(case when d_moy = 8
    then cs_sales_price* cs_quantity else 0 end) as aug_sales
  ,sum(case when d_moy = 9
    then cs_sales_price* cs_quantity else 0 end) as sep_sales
  ,sum(case when d_moy = 10
    then cs_sales_price* cs_quantity else 0 end) as oct_sales
  ,sum(case when d_moy = 11
    then cs_sales_price* cs_quantity else 0 end) as nov_sales
  ,sum(case when d_moy = 12
    then cs_sales_price* cs_quantity else 0 end) as dec_sales
  ,sum(case when d_moy = 1
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as jan_net
  ,sum(case when d_moy = 2
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as feb_net
  ,sum(case when d_moy = 3
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as mar_net
  ,sum(case when d_moy = 4
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as apr_net
  ,sum(case when d_moy = 5
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as may_net
  ,sum(case when d_moy = 6
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as jun_net
  ,sum(case when d_moy = 7
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as jul_net
  ,sum(case when d_moy = 8
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as aug_net
  ,sum(case when d_moy = 9
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as sep_net
  ,sum(case when d_moy = 10
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as oct_net
  ,sum(case when d_moy = 11
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as nov_net
  ,sum(case when d_moy = 12
    then cs_net_paid_inc_tax * cs_quantity else 0 end) as dec_net
     from
          catalog_sales
         ,warehouse
         ,date_dim
         ,time_dim
   ,ship_mode
     where
            cs_warehouse_sk =  w_warehouse_sk
        and cs_sold_date_sk = d_date_sk
        and cs_sold_time_sk = t_time_sk
  and cs_ship_mode_sk = sm_ship_mode_sk
        and d_year = 2001
  and t_time between 30838 AND 30838+28800
  and sm_carrier in ('DHL','BARIAN')
     group by
        w_warehouse_name
  ,w_warehouse_sq_ft
  ,w_city
  ,w_county
  ,w_state
  ,w_country
       ,d_year
 ) x
 group by
        w_warehouse_name
  ,w_warehouse_sq_ft
  ,w_city
  ,w_county
  ,w_state
  ,w_country
  ,ship_carriers
       ,year_
 order by w_warehouse_name NULLS FIRST
LIMIT 100;
----
Conventional childr 977787 Midway Williamson County TN United States DHL,BARIAN 2001 79417.27 770435.85 2869.73 1006705.22 383807.45 29521.55 46131.30 637320.73 1147028.95 1273316.78 352755.71 2947754.57 0.08122144 0.78793833 0.00293492 1.02957517 0.39252665 0.03019221 0.04717929 0.65179914 1.17308673 1.30224351 0.36076948 3.01472056 2173511.19 1582382.26 95844.19 3529601.58 1341204.58 2040444.28 1674369.49 828824.82 3481140.63 1899141.62 1455888.96 2688024.29


# Q67

query I
SELECT *
FROM
  (SELECT i_category,
          i_class,
          i_brand,
          i_product_name,
          d_year,
          d_qoy,
          d_moy,
          s_store_id,
          sumsales,
          rank() OVER (PARTITION BY i_category
                       ORDER BY sumsales DESC) rk
   FROM
     (SELECT i_category,
             i_class,
             i_brand,
             i_product_name,
             d_year,
             d_qoy,
             d_moy,
             s_store_id,
             sum(coalesce(ss_sales_price*ss_quantity,0)) sumsales
      FROM store_sales,
           date_dim,
           store,
           item
      WHERE ss_sold_date_sk=d_date_sk
        AND ss_item_sk=i_item_sk
        AND ss_store_sk = s_store_sk
        AND d_month_seq BETWEEN 1200 AND 1200+11
      GROUP BY rollup(i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy,s_store_id))dw1) dw2
WHERE rk <= 100
ORDER BY i_category NULLS FIRST,
         i_class NULLS FIRST,
         i_brand NULLS FIRST,
         i_product_name NULLS FIRST,
         d_year NULLS FIRST,
         d_qoy NULLS FIRST,
         d_moy NULLS FIRST,
         s_store_id NULLS FIRST,
         sumsales NULLS FIRST,
         rk NULLS FIRST
LIMIT 100;
----
NULL NULL NULL NULL NULL NULL NULL NULL 11332462.26 1
Books NULL NULL NULL NULL NULL NULL NULL 1480754.12 1
Books arts NULL NULL NULL NULL NULL NULL 191751.70 6
Books arts amalgmaxi #12 NULL NULL NULL NULL NULL 191751.70 6
Books arts amalgmaxi #12 antipri NULL NULL NULL NULL 108042.70 25
Books arts amalgmaxi #12 antipri 2000 NULL NULL NULL 108042.70 25
Books arts amalgmaxi #12 antipri 2000 3 NULL NULL 48527.83 53
Books arts amalgmaxi #12 antipri 2000 3 9 NULL 30406.69 73
Books arts amalgmaxi #12 antipri 2000 3 9 AAAAAAAABAAAAAAA 30406.69 73
Books arts amalgmaxi #12 antipri 2000 4 NULL NULL 40372.63 61
Books arts amalgmaxi #12 ationbarought NULL NULL NULL NULL 83709.00 45
Books arts amalgmaxi #12 ationbarought 2000 NULL NULL NULL 83709.00 45
Books arts amalgmaxi #12 ationbarought 2000 4 NULL NULL 37897.88 65
Books fiction NULL NULL NULL NULL NULL NULL 356542.34 2
Books fiction scholarunivamalg #2 NULL NULL NULL NULL NULL 87317.15 41
Books fiction scholarunivamalg #2 ationn st NULL NULL NULL NULL 87317.15 41
Books fiction scholarunivamalg #2 ationn st 2000 NULL NULL NULL 87317.15 41
Books fiction scholarunivamalg #2 ationn st 2000 3 NULL NULL 26518.96 83
Books fiction scholarunivamalg #2 ationn st 2000 4 NULL NULL 39207.88 63
Books fiction scholarunivamalg #8 NULL NULL NULL NULL NULL 269225.19 4
Books fiction scholarunivamalg #8 ationcally NULL NULL NULL NULL 160803.21 8
Books fiction scholarunivamalg #8 ationcally 2000 NULL NULL NULL 160803.21 8
Books fiction scholarunivamalg #8 ationcally 2000 3 NULL NULL 59977.46 49
Books fiction scholarunivamalg #8 ationcally 2000 3 8 NULL 28848.49 77
Books fiction scholarunivamalg #8 ationcally 2000 3 8 AAAAAAAABAAAAAAA 28848.49 77
Books fiction scholarunivamalg #8 ationcally 2000 3 9 NULL 24342.28 91
Books fiction scholarunivamalg #8 ationcally 2000 3 9 AAAAAAAABAAAAAAA 24342.28 91
Books fiction scholarunivamalg #8 ationcally 2000 4 NULL NULL 76843.72 47
Books fiction scholarunivamalg #8 ationcally 2000 4 11 NULL 23915.41 95
Books fiction scholarunivamalg #8 ationcally 2000 4 11 AAAAAAAABAAAAAAA 23915.41 95
Books fiction scholarunivamalg #8 ationcally 2000 4 12 NULL 36062.42 68
Books fiction scholarunivamalg #8 ationcally 2000 4 12 AAAAAAAABAAAAAAA 36062.42 68
Books fiction scholarunivamalg #8 n stpriought NULL NULL NULL NULL 108421.98 23
Books fiction scholarunivamalg #8 n stpriought 2000 NULL NULL NULL 108421.98 23
Books fiction scholarunivamalg #8 n stpriought 2000 4 NULL NULL 56209.79 50
Books fiction scholarunivamalg #8 n stpriought 2000 4 12 NULL 34656.30 70
Books fiction scholarunivamalg #8 n stpriought 2000 4 12 AAAAAAAABAAAAAAA 34656.30 70
Books mystery NULL NULL NULL NULL NULL NULL 140757.99 14
Books mystery corpunivamalg #9 NULL NULL NULL NULL NULL 140757.99 14
Books mystery corpunivamalg #9 esebarought NULL NULL NULL NULL 140757.99 14
Books mystery corpunivamalg #9 esebarought 2000 NULL NULL NULL 140757.99 14
Books mystery corpunivamalg #9 esebarought 2000 3 NULL NULL 36771.70 67
Books mystery corpunivamalg #9 esebarought 2000 3 9 NULL 24051.70 93
Books mystery corpunivamalg #9 esebarought 2000 3 9 AAAAAAAABAAAAAAA 24051.70 93
Books mystery corpunivamalg #9 esebarought 2000 4 NULL NULL 72375.86 48
Books mystery corpunivamalg #9 esebarought 2000 4 11 NULL 29458.37 75
Books mystery corpunivamalg #9 esebarought 2000 4 11 AAAAAAAABAAAAAAA 29458.37 75
Books mystery corpunivamalg #9 esebarought 2000 4 12 NULL 28733.97 79
Books mystery corpunivamalg #9 esebarought 2000 4 12 AAAAAAAABAAAAAAA 28733.97 79
Books parenting NULL NULL NULL NULL NULL NULL 150994.60 10
Books parenting corpmaxi #3 NULL NULL NULL NULL NULL 150994.60 10
Books parenting corpmaxi #3 ableableought NULL NULL NULL NULL 150994.60 10
Books parenting corpmaxi #3 ableableought 2000 NULL NULL NULL 150994.60 10
Books parenting corpmaxi #3 ableableought 2000 1 NULL NULL 24844.36 88
Books parenting corpmaxi #3 ableableought 2000 2 NULL NULL 25978.68 86
Books parenting corpmaxi #3 ableableought 2000 3 NULL NULL 53748.28 52
Books parenting corpmaxi #3 ableableought 2000 3 9 NULL 42534.99 59
Books parenting corpmaxi #3 ableableought 2000 3 9 AAAAAAAABAAAAAAA 42534.99 59
Books parenting corpmaxi #3 ableableought 2000 4 NULL NULL 46423.28 55
Books reference NULL NULL NULL NULL NULL NULL 94371.70 37
Books reference brandmaxi #2 NULL NULL NULL NULL NULL 94371.70 37
Books reference brandmaxi #2 ationantiought NULL NULL NULL NULL 94371.70 37
Books reference brandmaxi #2 ationantiought 2000 NULL NULL NULL 94371.70 37
Books reference brandmaxi #2 ationantiought 2000 3 NULL NULL 31974.69 72
Books reference brandmaxi #2 ationantiought 2000 3 9 NULL 24820.01 89
Books reference brandmaxi #2 ationantiought 2000 3 9 AAAAAAAABAAAAAAA 24820.01 89
Books reference brandmaxi #2 ationantiought 2000 4 NULL NULL 37284.09 66
Books reference brandmaxi #2 ationantiought 2000 4 11 NULL 22351.65 98
Books reference brandmaxi #2 ationantiought 2000 4 11 AAAAAAAABAAAAAAA 22351.65 98
Books self-help NULL NULL NULL NULL NULL NULL 345808.39 3
Books self-help exportiunivamalg #2 NULL NULL NULL NULL NULL 208057.43 5
Books self-help exportiunivamalg #2 antieseought NULL NULL NULL NULL 96511.47 35
Books self-help exportiunivamalg #2 antieseought 2000 NULL NULL NULL 96511.47 35
Books self-help exportiunivamalg #2 antieseought 2000 4 NULL NULL 47177.82 54
Books self-help exportiunivamalg #2 oughtableought NULL NULL NULL NULL 111545.96 21
Books self-help exportiunivamalg #2 oughtableought 2000 NULL NULL NULL 111545.96 21
Books self-help exportiunivamalg #2 oughtableought 2000 3 NULL NULL 40117.11 62
Books self-help exportiunivamalg #2 oughtableought 2000 4 NULL NULL 55820.56 51
Books self-help exportiunivamalg #2 oughtableought 2000 4 12 NULL 22230.93 100
Books self-help exportiunivamalg #2 oughtableought 2000 4 12 AAAAAAAABAAAAAAA 22230.93 100
Books self-help exportiunivamalg #6 NULL NULL NULL NULL NULL 137750.96 18
Books self-help exportiunivamalg #6 ationpriought NULL NULL NULL NULL 137750.96 18
Books self-help exportiunivamalg #6 ationpriought 2000 NULL NULL NULL 137750.96 18
Books self-help exportiunivamalg #6 ationpriought 2000 1 NULL NULL 25333.30 87
Books self-help exportiunivamalg #6 ationpriought 2000 4 NULL NULL 83792.67 44
Books self-help exportiunivamalg #6 ationpriought 2000 4 11 NULL 45533.83 57
Books self-help exportiunivamalg #6 ationpriought 2000 4 11 AAAAAAAABAAAAAAA 45533.83 57
Books self-help exportiunivamalg #6 ationpriought 2000 4 12 NULL 28333.80 81
Books self-help exportiunivamalg #6 ationpriought 2000 4 12 AAAAAAAABAAAAAAA 28333.80 81
Books sports NULL NULL NULL NULL NULL NULL 100852.47 27
Books sports edu packunivamalg #12 NULL NULL NULL NULL NULL 100852.47 27
Books sports edu packunivamalg #12 oughtation NULL NULL NULL NULL 100852.47 27
Books sports edu packunivamalg #12 oughtation 2000 NULL NULL NULL 100852.47 27
Books sports edu packunivamalg #12 oughtation 2000 2 NULL NULL 22998.13 97
Books sports edu packunivamalg #12 oughtation 2000 3 NULL NULL 37972.42 64
Books travel NULL NULL NULL NULL NULL NULL 99674.93 31
Books travel univunivamalg #8 NULL NULL NULL NULL NULL 99674.93 31
Books travel univunivamalg #8 priese NULL NULL NULL NULL 99674.93 31
Books travel univunivamalg #8 priese 2000 NULL NULL NULL 99674.93 31
Books travel univunivamalg #8 priese 2000 4 NULL NULL 46253.77 56

# Q68

query I
SELECT c_last_name,
       c_first_name,
       ca_city,
       bought_city,
       ss_ticket_number,
       extended_price,
       extended_tax,
       list_price
FROM
  (SELECT ss_ticket_number,
          ss_customer_sk,
          ca_city bought_city,
          sum(ss_ext_sales_price) extended_price,
          sum(ss_ext_list_price) list_price,
          sum(ss_ext_tax) extended_tax
   FROM store_sales,
        date_dim,
        store,
        household_demographics,
        customer_address
   WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk
     AND store_sales.ss_store_sk = store.s_store_sk
     AND store_sales.ss_hdemo_sk = household_demographics.hd_demo_sk
     AND store_sales.ss_addr_sk = customer_address.ca_address_sk
     AND date_dim.d_dom BETWEEN 1 AND 2
     AND (household_demographics.hd_dep_count = 4
          OR household_demographics.hd_vehicle_count= 3)
     AND date_dim.d_year IN (1999,
                             1999+1,
                             1999+2)
     AND store.s_city IN ('Fairview',
                          'Midway')
   GROUP BY ss_ticket_number,
            ss_customer_sk,
            ss_addr_sk,
            ca_city) dn,
     customer,
     customer_address current_addr
WHERE ss_customer_sk = c_customer_sk
  AND customer.c_current_addr_sk = current_addr.ca_address_sk
  AND current_addr.ca_city <> bought_city
ORDER BY c_last_name NULLS FIRST,
         ss_ticket_number NULLS FIRST
LIMIT 100;
----
Batson Gina Hopewell Rankin 1347 16088.73 493.53 34692.87
Berry Nancy Pleasant Valley Mount Vernon 2352 18409.74 861.56 36885.46
Britt Inez Edgewood Plainview 61 24732.38 1560.95 34918.37
Eller Christopher Flint Royal 1192 19199.10 591.47 33158.05
Foster Olive Oak Ridge Five Forks 1167 9997.57 440.34 23298.13
Guerra Shirlene Pleasant Valley Five Points 1463 19994.85 1284.27 44678.83
Hernandez Rachel Greenwood Harmony 1864 32529.65 1395.73 53606.11
Jackson Jill Bunker Hill Bridgeport 1605 39675.78 1585.03 67339.13
Marcum Issac Green Acres Enterprise 2102 22086.52 1291.67 48920.68
Orr Jeffrey Clifton Oakdale 435 8721.49 171.82 30368.34
Pierce Joshua Oakland Springfield 1300 26524.08 1039.72 74117.29
Prieto Victoria Belmont Stringtown 2013 18268.51 313.27 37617.80
Sanderson Sean Marion Spring Valley 2357 21997.18 603.59 35226.04
Sandlin Eduardo Pleasant Grove Waterloo 794 20979.10 900.99 48160.65
Spencer Stuart Centerville Highland 70 15617.02 1059.20 35200.10
Wilkins Jill Mount Vernon Woodland 1574 36221.69 1232.08 54438.42
Williams Betty Five Points Riverside 858 32645.01 952.68 61263.57
Young Althea Jamestown Riverside 1289 25546.95 1311.08 42936.52


# Q69

query I
SELECT cd_gender,
       cd_marital_status,
       cd_education_status,
       count(*) cnt1,
       cd_purchase_estimate,
       count(*) cnt2,
       cd_credit_rating,
       count(*) cnt3
FROM customer c,
     customer_address ca,
     customer_demographics
WHERE c.c_current_addr_sk = ca.ca_address_sk
  AND ca_state IN ('KY',
                   'GA',
                   'NM')
  AND cd_demo_sk = c.c_current_cdemo_sk
  AND EXISTS
    (SELECT *
     FROM store_sales,
          date_dim
     WHERE c.c_customer_sk = ss_customer_sk
       AND ss_sold_date_sk = d_date_sk
       AND d_year = 2001
       AND d_moy BETWEEN 4 AND 4+2)
  AND (NOT EXISTS
         (SELECT *
          FROM web_sales,
               date_dim
          WHERE c.c_customer_sk = ws_bill_customer_sk
            AND ws_sold_date_sk = d_date_sk
            AND d_year = 2001
            AND d_moy BETWEEN 4 AND 4+2)
       AND NOT EXISTS
         (SELECT *
          FROM catalog_sales,
               date_dim
          WHERE c.c_customer_sk = cs_ship_customer_sk
            AND cs_sold_date_sk = d_date_sk
            AND d_year = 2001
            AND d_moy BETWEEN 4 AND 4+2))
GROUP BY cd_gender,
         cd_marital_status,
         cd_education_status,
         cd_purchase_estimate,
         cd_credit_rating
ORDER BY cd_gender,
         cd_marital_status,
         cd_education_status,
         cd_purchase_estimate,
         cd_credit_rating
LIMIT 100;
----
F D Advanced Degree 1 4500 1 Unknown 1
F M Secondary 1 7000 1 High Risk 1
F M Unknown 1 4500 1 High Risk 1
F S Advanced Degree 1 6000 1 Unknown 1
F W Unknown 1 1000 1 Unknown 1
M M Unknown 1 9500 1 Unknown 1
M S Unknown 1 3500 1 High Risk 1
M U 4 yr Degree 1 500 1 Unknown 1


# Q70

query I
SELECT sum(ss_net_profit) AS total_sum,
       s_state,
       s_county,
       grouping(s_state)+grouping(s_county) AS lochierarchy,
       rank() OVER (PARTITION BY grouping(s_state)+grouping(s_county),
                                 CASE
                                     WHEN grouping(s_county) = 0 THEN s_state
                                 END
                    ORDER BY sum(ss_net_profit) DESC) AS rank_within_parent
FROM store_sales,
     date_dim d1,
     store
WHERE d1.d_month_seq BETWEEN 1200 AND 1200+11
  AND d1.d_date_sk = ss_sold_date_sk
  AND s_store_sk = ss_store_sk
  AND s_state IN
    (SELECT s_state
     FROM
       (SELECT s_state AS s_state,
               rank() OVER (PARTITION BY s_state
                            ORDER BY sum(ss_net_profit) DESC) AS ranking
        FROM store_sales,
             store,
             date_dim
        WHERE d_month_seq BETWEEN 1200 AND 1200+11
          AND d_date_sk = ss_sold_date_sk
          AND s_store_sk = ss_store_sk
        GROUP BY s_state) tmp1
     WHERE ranking <= 5 )
GROUP BY rollup(s_state,s_county)
ORDER BY lochierarchy DESC ,
         CASE
             WHEN lochierarchy = 0 THEN s_state
         END ,
         rank_within_parent
LIMIT 100;
----
-5077129.75 NULL NULL 2 1
-5077129.75 TN NULL 1 1
-5077129.75 TN Williamson County 0 1

# Q71

query I
SELECT i_brand_id brand_id,
       i_brand brand,
       t_hour,
       t_minute,
       sum(ext_price) ext_price
FROM item,
  (SELECT ws_ext_sales_price AS ext_price,
          ws_sold_date_sk AS sold_date_sk,
          ws_item_sk AS sold_item_sk,
          ws_sold_time_sk AS time_sk
   FROM web_sales,
        date_dim
   WHERE d_date_sk = ws_sold_date_sk
     AND d_moy=11
     AND d_year=1999
   UNION ALL SELECT cs_ext_sales_price AS ext_price,
                    cs_sold_date_sk AS sold_date_sk,
                    cs_item_sk AS sold_item_sk,
                    cs_sold_time_sk AS time_sk
   FROM catalog_sales,
        date_dim
   WHERE d_date_sk = cs_sold_date_sk
     AND d_moy=11
     AND d_year=1999
   UNION ALL SELECT ss_ext_sales_price AS ext_price,
                    ss_sold_date_sk AS sold_date_sk,
                    ss_item_sk AS sold_item_sk,
                    ss_sold_time_sk AS time_sk
   FROM store_sales,
        date_dim
   WHERE d_date_sk = ss_sold_date_sk
     AND d_moy=11
     AND d_year=1999 ) tmp,
     time_dim
WHERE sold_item_sk = i_item_sk
  AND i_manager_id=1
  AND time_sk = t_time_sk
  AND (t_meal_time = 'breakfast'
       OR t_meal_time = 'dinner')
GROUP BY i_brand,
         i_brand_id,
         t_hour,
         t_minute
ORDER BY ext_price DESC NULLS FIRST,
         i_brand_id NULLS FIRST,
         t_hour NULLS FIRST;
----
7008009 namelessbrand #9 9 19 11200.32
7008009 namelessbrand #9 18 3 5736.05
7008009 namelessbrand #9 18 44 3292.20
7008009 namelessbrand #9 6 45 1094.70
7008009 namelessbrand #9 8 40 769.00
7008009 namelessbrand #9 19 24 624.24
7008009 namelessbrand #9 18 30 187.85
7008009 namelessbrand #9 18 6 124.81
7008009 namelessbrand #9 19 44 0.00


# Q72

query I
SELECT i_item_desc,
       w_warehouse_name,
       d1.d_week_seq,
       sum(CASE
               WHEN p_promo_sk IS NULL THEN 1
               ELSE 0
           END) no_promo,
       sum(CASE
               WHEN p_promo_sk IS NOT NULL THEN 1
               ELSE 0
           END) promo,
       count(*) total_cnt
FROM catalog_sales
JOIN inventory ON (cs_item_sk = inv_item_sk)
JOIN warehouse ON (w_warehouse_sk=inv_warehouse_sk)
JOIN item ON (i_item_sk = cs_item_sk)
JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk)
JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk)
JOIN date_dim d1 ON (cs_sold_date_sk = d1.d_date_sk)
JOIN date_dim d2 ON (inv_date_sk = d2.d_date_sk)
JOIN date_dim d3 ON (cs_ship_date_sk = d3.d_date_sk)
LEFT OUTER JOIN promotion ON (cs_promo_sk=p_promo_sk)
LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk
                                    AND cr_order_number = cs_order_number)
WHERE d1.d_week_seq = d2.d_week_seq
  AND inv_quantity_on_hand < cs_quantity
  AND d3.d_date > d1.d_date + 5 -- SQL Server: DATEADD(day, 5, d1.d_date)
  AND hd_buy_potential = '>10000'
  AND d1.d_year = 1999
  AND cd_marital_status = 'D'
GROUP BY i_item_desc,
         w_warehouse_name,
         d1.d_week_seq
ORDER BY total_cnt DESC NULLS FIRST,
         i_item_desc NULLS FIRST,
         w_warehouse_name NULLS FIRST,
         d1.d_week_seq NULLS FIRST
LIMIT 100;
----
Already  Conventional childr 5202 0 1 1
British units must not leave quick in a questions. Tasks terminate supreme departments. So significant families will not Conventional childr 5205 0 1 1
British units must not leave quick in a questions. Tasks terminate supreme departments. So significant families will not Conventional childr 5217 0 1 1
Complete cases shall happen to a generations. Systems must tell sometimes main scenes. Tonnes make still main trees. Different, personal owners become often little important y Conventional childr 5199 0 1 1
Following, new prospects get almost available children. Terms can need very lucky days. Likely, sufficient persons prolong particularly words. Years might not organise also. Oth Conventional childr 5201 0 1 1
Normal things beat also general agents. Other patients must not restore mu Conventional childr 5199 0 1 1
Original interests see of course british, important terms. Yet appropriate principles conclude in a arrangements; good countries would get sometimes;  Conventional childr 5209 0 1 1
Public, annual h Conventional childr 5206 0 1 1
Then critical years could instruct true Conventional childr 5206 0 1 1
Tonnes alter. Towns get schools Conventional childr 5215 0 1 1


# Q73

query I
SELECT c_last_name,
       c_first_name,
       c_salutation,
       c_preferred_cust_flag,
       ss_ticket_number,
       cnt
FROM
  (SELECT ss_ticket_number,
          ss_customer_sk,
          count(*) cnt
   FROM store_sales,
        date_dim,
        store,
        household_demographics
   WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk
     AND store_sales.ss_store_sk = store.s_store_sk
     AND store_sales.ss_hdemo_sk = household_demographics.hd_demo_sk
     AND date_dim.d_dom BETWEEN 1 AND 2
     AND (household_demographics.hd_buy_potential = 'Unknown'
          OR household_demographics.hd_buy_potential = '>10000')
     AND household_demographics.hd_vehicle_count > 0
     AND CASE
             WHEN household_demographics.hd_vehicle_count > 0 THEN (household_demographics.hd_dep_count*1.000)/ household_demographics.hd_vehicle_count
             ELSE NULL
         END > 1
     AND date_dim.d_year IN (1999,
                             1999+1,
                             1999+2)
     AND store.s_county IN ('Orange County',
                            'Bronx County',
                            'Franklin Parish',
                            'Williamson County')
   GROUP BY ss_ticket_number,
            ss_customer_sk) dj,
     customer
WHERE ss_customer_sk = c_customer_sk
  AND cnt BETWEEN 1 AND 5
ORDER BY cnt DESC,
         c_last_name ASC;
----


# Q74

query I
WITH year_total AS
  (SELECT c_customer_id customer_id,
          c_first_name customer_first_name,
          c_last_name customer_last_name,
          d_year AS year_,
          sum(ss_net_paid) year_total,
          's' sale_type
   FROM customer,
        store_sales,
        date_dim
   WHERE c_customer_sk = ss_customer_sk
     AND ss_sold_date_sk = d_date_sk
     AND d_year IN (2001,
                    2001+1)
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            d_year
   UNION ALL SELECT c_customer_id customer_id,
                    c_first_name customer_first_name,
                    c_last_name customer_last_name,
                    d_year AS year_,
                    sum(ws_net_paid) year_total,
                    'w' sale_type
   FROM customer,
        web_sales,
        date_dim
   WHERE c_customer_sk = ws_bill_customer_sk
     AND ws_sold_date_sk = d_date_sk
     AND d_year IN (2001,
                    2001+1)
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            d_year)
SELECT t_s_secyear.customer_id,
       t_s_secyear.customer_first_name,
       t_s_secyear.customer_last_name
FROM year_total t_s_firstyear,
     year_total t_s_secyear,
     year_total t_w_firstyear,
     year_total t_w_secyear
WHERE t_s_secyear.customer_id = t_s_firstyear.customer_id
  AND t_s_firstyear.customer_id = t_w_secyear.customer_id
  AND t_s_firstyear.customer_id = t_w_firstyear.customer_id
  AND t_s_firstyear.sale_type = 's'
  AND t_w_firstyear.sale_type = 'w'
  AND t_s_secyear.sale_type = 's'
  AND t_w_secyear.sale_type = 'w'
  AND t_s_firstyear.year_ = 2001
  AND t_s_secyear.year_ = 2001+1
  AND t_w_firstyear.year_ = 2001
  AND t_w_secyear.year_ = 2001+1
  AND t_s_firstyear.year_total > 0
  AND t_w_firstyear.year_total > 0
  AND CASE
          WHEN t_w_firstyear.year_total > 0 THEN t_w_secyear.year_total / t_w_firstyear.year_total
          ELSE NULL
      END > CASE
                WHEN t_s_firstyear.year_total > 0 THEN t_s_secyear.year_total / t_s_firstyear.year_total
                ELSE NULL
            END
ORDER BY 1 NULLS FIRST
LIMIT 100;
----


# Q75

query I
WITH all_sales AS
  ( SELECT d_year ,
           i_brand_id ,
           i_class_id ,
           i_category_id ,
           i_manufact_id ,
           SUM(sales_cnt) AS sales_cnt ,
           SUM(sales_amt) AS sales_amt
   FROM
     (SELECT d_year ,
             i_brand_id ,
             i_class_id ,
             i_category_id ,
             i_manufact_id ,
             cs_quantity - COALESCE(cr_return_quantity,0) AS sales_cnt ,
             cs_ext_sales_price - COALESCE(cr_return_amount,0.0) AS sales_amt
      FROM catalog_sales
      JOIN item ON i_item_sk=cs_item_sk
      JOIN date_dim ON d_date_sk=cs_sold_date_sk
      LEFT JOIN catalog_returns ON (cs_order_number=cr_order_number
                                    AND cs_item_sk=cr_item_sk)
      WHERE i_category='Books'
      UNION SELECT d_year ,
                   i_brand_id ,
                   i_class_id ,
                   i_category_id ,
                   i_manufact_id ,
                   ss_quantity - COALESCE(sr_return_quantity,0) AS sales_cnt ,
                   ss_ext_sales_price - COALESCE(sr_return_amt,0.0) AS sales_amt
      FROM store_sales
      JOIN item ON i_item_sk=ss_item_sk
      JOIN date_dim ON d_date_sk=ss_sold_date_sk
      LEFT JOIN store_returns ON (ss_ticket_number=sr_ticket_number
                                  AND ss_item_sk=sr_item_sk)
      WHERE i_category='Books'
      UNION SELECT d_year ,
                   i_brand_id ,
                   i_class_id ,
                   i_category_id ,
                   i_manufact_id ,
                   ws_quantity - COALESCE(wr_return_quantity,0) AS sales_cnt ,
                   ws_ext_sales_price - COALESCE(wr_return_amt,0.0) AS sales_amt
      FROM web_sales
      JOIN item ON i_item_sk=ws_item_sk
      JOIN date_dim ON d_date_sk=ws_sold_date_sk
      LEFT JOIN web_returns ON (ws_order_number=wr_order_number
                                AND ws_item_sk=wr_item_sk)
      WHERE i_category='Books') sales_detail
   GROUP BY d_year,
            i_brand_id,
            i_class_id,
            i_category_id,
            i_manufact_id)
SELECT prev_yr.d_year AS prev_year ,
       curr_yr.d_year AS year_ ,
       curr_yr.i_brand_id ,
       curr_yr.i_class_id ,
       curr_yr.i_category_id ,
       curr_yr.i_manufact_id ,
       prev_yr.sales_cnt AS prev_yr_cnt ,
       curr_yr.sales_cnt AS curr_yr_cnt ,
       curr_yr.sales_cnt-prev_yr.sales_cnt AS sales_cnt_diff ,
       curr_yr.sales_amt-prev_yr.sales_amt AS sales_amt_diff
FROM all_sales curr_yr,
     all_sales prev_yr
WHERE curr_yr.i_brand_id=prev_yr.i_brand_id
  AND curr_yr.i_class_id=prev_yr.i_class_id
  AND curr_yr.i_category_id=prev_yr.i_category_id
  AND curr_yr.i_manufact_id=prev_yr.i_manufact_id
  AND curr_yr.d_year=2002
  AND prev_yr.d_year=2002-1
  AND CAST(curr_yr.sales_cnt AS DECIMAL(17,2))/CAST(prev_yr.sales_cnt AS DECIMAL(17,2))<0.9
ORDER BY sales_cnt_diff,
         sales_amt_diff
LIMIT 100;
----
2001 2002 9015008 15 9 384 6038 3171 -2867 -131936.09
2001 2002 2004001 2 9 368 6346 4106 -2240 -109026.62
2001 2002 9010008 10 9 301 6293 4084 -2209 -106062.06
2001 2002 9007002 7 9 301 6032 3973 -2059 -123568.70
2001 2002 9013002 13 9 296 5139 3513 -1626 -124577.98
2001 2002 9015008 15 9 285 5589 4245 -1344 -108167.16
2001 2002 9015002 15 9 275 5278 4006 -1272 -21309.32
2001 2002 9015010 2 9 286 5526 4305 -1221 -21411.30

# Q76

query I
SELECT channel,
       col_name,
       d_year,
       d_qoy,
       i_category,
       COUNT(*) sales_cnt,
       SUM(ext_sales_price) sales_amt
FROM
  ( SELECT 'store' AS channel,
           'ss_store_sk' col_name,
                         d_year,
                         d_qoy,
                         i_category,
                         ss_ext_sales_price ext_sales_price
   FROM store_sales,
        item,
        date_dim
   WHERE ss_store_sk IS NULL
     AND ss_sold_date_sk=d_date_sk
     AND ss_item_sk=i_item_sk
   UNION ALL SELECT 'web' AS channel,
                    'ws_ship_customer_sk' col_name,
                                          d_year,
                                          d_qoy,
                                          i_category,
                                          ws_ext_sales_price ext_sales_price
   FROM web_sales,
        item,
        date_dim
   WHERE ws_ship_customer_sk IS NULL
     AND ws_sold_date_sk=d_date_sk
     AND ws_item_sk=i_item_sk
   UNION ALL SELECT 'catalog' AS channel,
                    'cs_ship_addr_sk' col_name,
                                      d_year,
                                      d_qoy,
                                      i_category,
                                      cs_ext_sales_price ext_sales_price
   FROM catalog_sales,
        item,
        date_dim
   WHERE cs_ship_addr_sk IS NULL
     AND cs_sold_date_sk=d_date_sk
     AND cs_item_sk=i_item_sk) foo
GROUP BY channel,
         col_name,
         d_year,
         d_qoy,
         i_category
ORDER BY channel NULLS FIRST,
         col_name NULLS FIRST,
         d_year NULLS FIRST,
         d_qoy NULLS FIRST,
         i_category NULLS FIRST
LIMIT 100;
----

# Q77

query I
WITH ss AS
  (SELECT s_store_sk,
          sum(ss_ext_sales_price) AS sales,
          sum(ss_net_profit) AS profit
   FROM store_sales,
        date_dim,
        store
   WHERE ss_sold_date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-22' AS date)
     AND ss_store_sk = s_store_sk
   GROUP BY s_store_sk) ,
     sr AS
  (SELECT s_store_sk,
          sum(sr_return_amt) AS returns_,
          sum(sr_net_loss) AS profit_loss
   FROM store_returns,
        date_dim,
        store
   WHERE sr_returned_date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-22' AS date)
     AND sr_store_sk = s_store_sk
   GROUP BY s_store_sk),
     cs AS
  (SELECT cs_call_center_sk,
          sum(cs_ext_sales_price) AS sales,
          sum(cs_net_profit) AS profit
   FROM catalog_sales,
        date_dim
   WHERE cs_sold_date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-22' AS date)
   GROUP BY cs_call_center_sk),
     cr AS
  (SELECT cr_call_center_sk,
          sum(cr_return_amount) AS returns_,
          sum(cr_net_loss) AS profit_loss
   FROM catalog_returns,
        date_dim
   WHERE cr_returned_date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-22' AS date)
   GROUP BY cr_call_center_sk ),
     ws AS
  (SELECT wp_web_page_sk,
          sum(ws_ext_sales_price) AS sales,
          sum(ws_net_profit) AS profit
   FROM web_sales,
        date_dim,
        web_page
   WHERE ws_sold_date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-22' AS date)
     AND ws_web_page_sk = wp_web_page_sk
   GROUP BY wp_web_page_sk),
     wr AS
  (SELECT wp_web_page_sk,
          sum(wr_return_amt) AS returns_,
          sum(wr_net_loss) AS profit_loss
   FROM web_returns,
        date_dim,
        web_page
   WHERE wr_returned_date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-22' AS date)
     AND wr_web_page_sk = wp_web_page_sk
   GROUP BY wp_web_page_sk)
SELECT channel ,
       id ,
       sum(sales) AS sales ,
       sum(returns_) AS returns_ ,
       sum(profit) AS profit
FROM
  (SELECT 'store channel' AS channel ,
          ss.s_store_sk AS id ,
          sales ,
          coalesce(returns_, 0) AS returns_ ,
          (profit - coalesce(profit_loss,0)) AS profit
   FROM ss
   LEFT JOIN sr ON ss.s_store_sk = sr.s_store_sk
   UNION ALL SELECT 'catalog channel' AS channel ,
                    cs_call_center_sk AS id ,
                    sales ,
                    returns_ ,
                    (profit - profit_loss) AS profit
   FROM cs ,
        cr
   UNION ALL SELECT 'web channel' AS channel ,
                    ws.wp_web_page_sk AS id ,
                    sales ,
                    coalesce(returns_, 0) returns_ ,
                    (profit - coalesce(profit_loss,0)) AS profit
   FROM ws
   LEFT JOIN wr ON ws.wp_web_page_sk = wr.wp_web_page_sk ) x
GROUP BY ROLLUP (channel,
                 id)
ORDER BY channel NULLS FIRST,
         id NULLS FIRST
LIMIT 100;
----
NULL NULL 2699723.65 80676.58 -789235.68
catalog channel NULL 726504.40 29196.62 -66386.61
catalog channel 1 726504.40 29196.62 -66386.61
store channel NULL 1515490.25 34162.80 -644746.65
store channel 1 1515490.25 34162.80 -644746.65
web channel NULL 457729.00 17317.16 -78102.42
web channel 1 457729.00 17317.16 -78102.42

# Q78

query I
WITH ws AS
  (SELECT d_year AS ws_sold_year,
          ws_item_sk,
          ws_bill_customer_sk ws_customer_sk,
          sum(ws_quantity) ws_qty,
          sum(ws_wholesale_cost) ws_wc,
          sum(ws_sales_price) ws_sp
   FROM web_sales
   LEFT JOIN web_returns ON wr_order_number=ws_order_number
   AND ws_item_sk=wr_item_sk
   JOIN date_dim ON ws_sold_date_sk = d_date_sk
   WHERE wr_order_number IS NULL
   GROUP BY d_year,
            ws_item_sk,
            ws_bill_customer_sk ),
     cs AS
  (SELECT d_year AS cs_sold_year,
          cs_item_sk,
          cs_bill_customer_sk cs_customer_sk,
          sum(cs_quantity) cs_qty,
          sum(cs_wholesale_cost) cs_wc,
          sum(cs_sales_price) cs_sp
   FROM catalog_sales
   LEFT JOIN catalog_returns ON cr_order_number=cs_order_number
   AND cs_item_sk=cr_item_sk
   JOIN date_dim ON cs_sold_date_sk = d_date_sk
   WHERE cr_order_number IS NULL
   GROUP BY d_year,
            cs_item_sk,
            cs_bill_customer_sk ),
     ss AS
  (SELECT d_year AS ss_sold_year,
          ss_item_sk,
          ss_customer_sk,
          sum(ss_quantity) ss_qty,
          sum(ss_wholesale_cost) ss_wc,
          sum(ss_sales_price) ss_sp
   FROM store_sales
   LEFT JOIN store_returns ON sr_ticket_number=ss_ticket_number
   AND ss_item_sk=sr_item_sk
   JOIN date_dim ON ss_sold_date_sk = d_date_sk
   WHERE sr_ticket_number IS NULL
   GROUP BY d_year,
            ss_item_sk,
            ss_customer_sk )
SELECT ss_sold_year,
       ss_item_sk,
       ss_customer_sk,
       round((ss_qty*1.00)/(coalesce(ws_qty,0)+coalesce(cs_qty,0)),2) ratio,
       ss_qty store_qty,
       ss_wc store_wholesale_cost,
       ss_sp store_sales_price,
       coalesce(ws_qty,0)+coalesce(cs_qty,0) other_chan_qty,
       coalesce(ws_wc,0)+coalesce(cs_wc,0) other_chan_wholesale_cost,
       coalesce(ws_sp,0)+coalesce(cs_sp,0) other_chan_sales_price
FROM ss
LEFT JOIN ws ON (ws_sold_year=ss_sold_year
                 AND ws_item_sk=ss_item_sk
                 AND ws_customer_sk=ss_customer_sk)
LEFT JOIN cs ON (cs_sold_year=ss_sold_year
                 AND cs_item_sk=ss_item_sk
                 AND cs_customer_sk=ss_customer_sk)
WHERE (coalesce(ws_qty,0)>0
       OR coalesce(cs_qty, 0)>0)
  AND ss_sold_year=2000
ORDER BY ss_sold_year,
         ss_item_sk,
         ss_customer_sk,
         ss_qty DESC,
         ss_wc DESC,
         ss_sp DESC,
         other_chan_qty,
         other_chan_wholesale_cost,
         other_chan_sales_price,
         ratio
LIMIT 100;
----
2000 1 17 1.84 92 42.04 46.49 50 97.29 79.40
2000 1 102 0.95 52 92.54 80.61 55 10.35 2.90
2000 1 656 0.21 7 90.00 67.12 34 37.40 37.09
2000 2 256 0.12 6 10.36 12.48 50 14.32 8.23
2000 2 480 0.71 45 23.60 25.90 63 18.03 17.13
2000 5 99 0.09 8 49.55 32.85 92 134.71 163.29
2000 5 480 0.57 50 3.39 0.61 87 45.83 53.59
2000 7 912 0.68 66 41.64 63.70 97 59.16 130.04
2000 8 99 0.48 14 29.18 8.09 29 43.48 71.42
2000 8 325 0.86 54 83.44 44.68 63 37.87 50.55
2000 8 501 1.69 71 88.22 88.76 42 59.15 33.59
2000 8 568 5.69 91 106.86 72.31 16 88.70 22.13
2000 8 607 1.24 94 69.87 8.44 76 15.60 12.40
2000 8 937 4.00 32 28.49 43.91 8 35.73 79.14
2000 11 99 3.17 73 35.63 42.50 23 82.52 81.30
2000 11 344 0.98 79 55.29 9.50 81 60.39 6.55
2000 11 937 1.46 95 65.04 109.88 65 69.73 181.29
2000 14 107 0.56 56 14.00 3.35 100 88.42 44.86
2000 17 604 0.94 72 123.05 73.86 77 67.61 55.35
2000 17 665 0.34 10 54.29 71.17 29 29.05 6.83
2000 17 668 4.06 73 86.26 8.00 18 73.06 66.67
2000 17 710 0.23 15 58.10 48.10 65 96.14 100.82
2000 19 539 0.49 33 32.33 41.35 68 124.61 67.61
2000 19 566 0.61 53 80.97 85.69 87 80.36 84.40
2000 19 682 0.48 47 58.06 39.08 97 13.10 18.56
2000 19 922 26.50 53 32.46 10.43 2 36.78 51.51
2000 20 321 2.38 31 17.31 17.66 13 84.13 160.90
2000 20 501 0.30 10 4.27 1.33 33 12.91 0.30
2000 20 822 1.17 69 86.20 136.53 59 61.54 130.02
2000 25 665 0.11 7 31.24 17.68 65 85.15 143.04
2000 26 354 0.19 18 5.00 4.84 96 89.99 166.35
2000 26 498 0.40 24 57.11 26.55 60 85.59 76.73
2000 26 784 0.95 69 7.68 5.25 73 76.72 121.29
2000 26 878 2.07 58 7.20 4.41 28 53.28 28.79
2000 29 65 16.40 82 18.74 2.16 5 81.49 12.09
2000 29 335 0.35 32 76.21 8.09 91 2.15 1.16
2000 29 501 1.76 86 37.64 18.80 49 95.25 65.69
2000 29 843 1.04 73 59.61 61.15 70 23.06 20.37
2000 29 990 0.20 10 62.00 53.94 49 88.35 21.73
2000 29 994 0.53 16 94.38 60.13 30 1.47 1.36
2000 31 4 0.93 13 87.20 36.16 14 81.43 75.69
2000 31 182 0.38 29 66.79 45.75 77 51.10 66.77
2000 31 452 1.03 67 74.01 79.09 65 47.16 29.87
2000 31 797 1.17 68 54.67 16.40 58 83.23 74.15
2000 31 811 0.69 64 22.04 20.23 93 96.84 86.61
2000 31 847 0.85 39 5.06 2.09 46 39.69 11.38
2000 32 499 0.45 14 78.30 41.34 31 46.56 18.66
2000 32 526 3.38 98 73.01 12.70 29 37.96 72.46
2000 35 101 0.68 67 92.84 159.63 99 7.43 8.50
2000 35 849 1.37 52 42.05 44.12 38 37.80 1.44
2000 37 434 0.66 35 66.97 50.92 53 56.72 83.66
2000 37 480 0.85 64 7.91 4.43 75 78.16 115.85
2000 38 393 0.89 51 59.78 39.21 57 51.37 21.18
2000 38 596 6.15 80 56.53 3.30 13 19.19 8.28
2000 41 101 0.91 70 61.92 99.52 77 51.86 50.65
2000 41 481 0.88 7 96.16 60.71 8 29.52 59.77
2000 43 603 0.55 42 96.87 4.01 76 44.44 45.68
2000 43 942 0.58 26 58.68 46.94 45 98.64 84.33
2000 44 382 6.21 87 6.91 1.38 14 81.32 40.08
2000 47 526 1.72 74 65.42 57.48 43 8.90 8.68
2000 49 354 0.61 60 75.68 67.84 99 48.12 60.79
2000 49 445 1.17 91 79.33 2.74 78 49.74 9.40
2000 50 193 2.41 94 63.22 32.52 39 1.80 1.71
2000 50 194 0.23 22 97.27 177.37 94 25.46 54.04
2000 50 391 0.20 16 59.10 37.51 81 96.87 94.94
2000 50 393 1.05 67 82.86 21.75 64 82.54 154.31
2000 50 962 2.63 84 4.69 1.01 32 62.01 101.08
2000 50 985 0.26 24 17.04 8.34 93 20.29 33.41
2000 53 604 2.18 96 13.93 15.83 44 46.16 34.99
2000 53 797 0.69 44 69.41 114.93 64 77.27 33.49
2000 53 811 1.18 84 78.58 75.59 71 23.80 18.35
2000 55 238 1.63 70 46.93 64.19 43 44.72 42.14
2000 55 370 1.34 82 1.44 1.00 61 97.61 137.03
2000 55 512 0.48 24 13.58 14.69 50 95.12 49.91
2000 55 684 0.07 2 79.29 46.31 28 46.22 36.24
2000 56 388 0.03 3 44.25 14.77 90 15.81 25.52
2000 56 638 1.37 59 76.30 33.13 43 4.27 7.88
2000 59 539 0.19 16 84.54 82.24 85 62.07 66.90
2000 61 370 1.26 97 20.19 8.85 77 40.18 100.06
2000 61 495 1.44 49 84.29 47.34 34 56.10 52.30
2000 61 602 0.13 7 57.58 54.01 52 65.10 28.35
2000 61 684 0.53 51 5.35 1.50 97 63.81 16.25
2000 61 982 0.09 7 26.83 25.22 74 43.88 69.07
2000 62 498 0.30 27 55.17 36.57 89 2.42 2.17
2000 65 169 9.40 47 93.06 109.67 5 36.69 51.72
2000 65 182 4.67 56 19.06 12.63 12 98.17 137.55
2000 65 928 0.48 25 13.75 5.51 52 57.55 32.87
2000 65 933 0.86 79 86.28 132.10 92 94.69 187.89
2000 67 94 2.50 35 28.17 13.23 14 39.29 37.31
2000 67 761 12.20 61 20.72 9.13 5 27.61 25.35
2000 67 841 1.01 79 41.08 29.17 78 25.77 34.78
2000 67 878 0.83 76 22.82 14.77 92 82.50 100.75
2000 68 37 0.10 9 94.94 67.67 91 74.13 130.52
2000 68 65 2.76 69 15.89 4.09 25 25.80 22.95
2000 68 122 1.95 76 28.79 1.18 39 17.33 22.92
2000 68 375 2.88 95 30.91 20.69 33 84.01 46.92
2000 68 391 5.64 62 53.06 37.93 11 25.78 37.76
2000 68 808 2.28 41 25.44 0.45 18 89.72 117.53
2000 71 668 0.89 65 43.58 8.59 73 68.38 9.23
2000 73 596 3.70 74 69.38 6.32 20 88.71 1.33

# Q79

query I
SELECT c_last_name,
       c_first_name,
       SUBSTRING(s_city,1,30),
       ss_ticket_number,
       amt,
       profit
FROM
  (SELECT ss_ticket_number ,
          ss_customer_sk ,
          store.s_city ,
          sum(ss_coupon_amt) amt ,
          sum(ss_net_profit) profit
   FROM store_sales,
        date_dim,
        store,
        household_demographics
   WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk
     AND store_sales.ss_store_sk = store.s_store_sk
     AND store_sales.ss_hdemo_sk = household_demographics.hd_demo_sk
     AND (household_demographics.hd_dep_count = 6
          OR household_demographics.hd_vehicle_count > 2)
     AND date_dim.d_dow = 1
     AND date_dim.d_year IN (1999,
                             1999+1,
                             1999+2)
     AND store.s_number_employees BETWEEN 200 AND 295
   GROUP BY ss_ticket_number,
            ss_customer_sk,
            ss_addr_sk,
            store.s_city) ms,
     customer
WHERE ss_customer_sk = c_customer_sk
ORDER BY c_last_name  NULLS FIRST,
         c_first_name  NULLS FIRST,
         SUBSTRING(s_city,1,30)  NULLS FIRST,
         profit NULLS FIRST
LIMIT 100;
----
Adams Matilde Midway 1947 2820.78 -13325.80
Amos Ima Midway 1837 4783.62 -9250.08
Ball Steven Midway 2238 2096.18 -11667.07
Bass Valerie Midway 1411 7875.93 -20832.13
Benitez Michele Midway 2008 797.61 -6400.28
Black Margaret Midway 952 654.63 -11508.46
Bonilla Alice Midway 373 2346.98 -10679.40
Bonilla Alice Midway 471 56.60 -8916.63
Bryant Rosemary Midway 534 0.00 -2799.83
Buchanan Theresa Midway 1558 356.97 -792.80
Burch James Midway 234 4775.56 -13226.27
Butcher Bruno Midway 740 2866.76 -3689.02
Butler Claudia Midway 187 3551.31 -14566.39
Carlson Maxine Midway 1256 5521.89 -12209.95
Carlton Gloria Midway 362 9.01 -4600.82
Carter Debra Midway 62 22.45 -2127.31
Child Hellen Midway 2076 4353.64 -8110.18
Contreras Joni Midway 485 289.74 -14200.87
Crowley Francis Midway 221 2373.96 -12378.05
Cunningham Bonnie Midway 2267 0.00 -9495.11
Davis Chris Midway 519 0.00 -12537.31
Davis Wanda Midway 1152 5089.77 -9070.43
Dawkins Steven Midway 2029 5925.50 -13817.86
Delgado Brenda Midway 1891 748.51 -998.89
Derr Joanne Midway 1224 3231.27 -13976.20
Flores William Midway 576 4241.05 -25933.14
Foster Olive Midway 1167 250.90 -7007.19
Godfrey Cameron Midway 2128 2468.43 -9048.06
Holden Earl Midway 1140 89.50 -11961.37
Horn Elizabeth Midway 2388 289.62 -1196.14
Jackson John Midway 1057 5197.34 -16615.73
Johnson Douglas Midway 2394 213.23 -5947.75
Johnson Rebecca Midway 204 6323.82 -5679.89
Kelly Betty Midway 156 2342.68 -19323.90
Kuhn Annie Midway 1531 163.51 -6952.00
Labbe Aaron Midway 2326 2734.48 -996.24
Larson Kizzie Midway 2223 522.88 -9343.61
Lee James Midway 313 4236.50 -21448.40
Long Angela Midway 1127 372.06 -6675.73
Marsh Ronald Midway 2329 508.15 -15596.40
Mason Lance Midway 1278 664.35 -5897.87
Mcdowell Terry Midway 1017 2.63 -4478.96
Moran Robert Midway 467 5332.90 -14405.30
Muller Yolonda Midway 2375 0.00 -10400.44
Munoz Leonard Midway 1223 4196.61 -17780.76
Neeley David Midway 2340 2981.91 -27021.27
Nelson Eleanor Midway 1066 9356.85 -21759.26
Palmer Kevin Midway 1089 123.71 -5594.03
Patterson Robert Midway 2014 6786.34 -13093.12
Porter Joseph Midway 1019 91.18 -8699.05
Ramirez Salvador Midway 1889 1985.13 -5758.07
Robinson Charles Midway 979 4871.56 -15485.95
Rojas Ida Midway 380 4294.57 -12539.57
Rojas Ida Midway 1490 0.00 -6131.38
Roman Karen Midway 1666 1110.88 -11228.01
Ruffin Stewart Midway 2148 920.03 -11240.93
Ruiz Robert Midway 1335 3978.03 -10914.42
Rutherford Adela Midway 955 3246.38 -11170.31
Sandlin Eduardo Midway 383 4312.80 -4884.28
Saunders David Midway 2018 1840.49 -16009.20
Schneider Dwight Midway 1385 80.28 -5763.42
Shipley Fred Midway 2001 4536.98 -5661.10
Silva Anthony Midway 1410 0.00 -14775.29
Smith Marjorie Midway 872 9292.68 -7386.05
Solomon Sunshine Midway 2308 5313.58 -25366.84
Stephens Max Midway 830 0.00 -6933.92
Thames John Midway 1235 1537.77 -8966.57
Thompson Lan Midway 621 0.00 -1154.18
Tiller Noemi Midway 2144 60.77 -842.97
Tillery Cristy Midway 511 2454.06 -5703.69
Warren Amy Midway 821 2001.12 -7170.90
Warren Thomas Midway 661 1787.04 -1694.36
Welch Janet Midway 1563 75.46 -3136.54
Welsh Cherise Midway 1809 2181.90 -18013.78
White Alexander Midway 349 689.78 -18001.26
White Kevin Midway 2114 843.57 806.32
White Michael Midway 249 219.76 -4881.41
Wiles Fonda Midway 403 1930.56 -17344.75
Wilkins Jill Midway 1574 3218.36 -4107.42
Williams Steven Midway 798 2420.44 -14992.66
Wilson Edna Midway 1266 6225.71 -9169.74
Wilson Joseph Midway 1938 4751.58 -9729.36
Wright Evelyn Midway 361 1353.38 -13585.45

# Q80

query I
WITH ssr AS
  (SELECT s_store_id AS store_id,
          sum(ss_ext_sales_price) AS sales,
          sum(coalesce(sr_return_amt, 0)) AS returns_,
          sum(ss_net_profit - coalesce(sr_net_loss, 0)) AS profit
   FROM store_sales
   LEFT OUTER JOIN store_returns ON (ss_item_sk = sr_item_sk
                                     AND ss_ticket_number = sr_ticket_number), date_dim,
                                                                               store,
                                                                               item,
                                                                               promotion
   WHERE ss_sold_date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-22' AS date)
     AND ss_store_sk = s_store_sk
     AND ss_item_sk = i_item_sk
     AND i_current_price > 50
     AND ss_promo_sk = p_promo_sk
     AND p_channel_tv = 'N'
   GROUP BY s_store_id) ,
     csr AS
  (SELECT cp_catalog_page_id AS catalog_page_id,
          sum(cs_ext_sales_price) AS sales,
          sum(coalesce(cr_return_amount, 0)) AS returns_,
          sum(cs_net_profit - coalesce(cr_net_loss, 0)) AS profit
   FROM catalog_sales
   LEFT OUTER JOIN catalog_returns ON (cs_item_sk = cr_item_sk
                                       AND cs_order_number = cr_order_number), date_dim,
                                                                               catalog_page,
                                                                               item,
                                                                               promotion
   WHERE cs_sold_date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-22' AS date)
     AND cs_catalog_page_sk = cp_catalog_page_sk
     AND cs_item_sk = i_item_sk
     AND i_current_price > 50
     AND cs_promo_sk = p_promo_sk
     AND p_channel_tv = 'N'
   GROUP BY cp_catalog_page_id) ,
     wsr AS
  (SELECT web_site_id,
          sum(ws_ext_sales_price) AS sales,
          sum(coalesce(wr_return_amt, 0)) AS returns_,
          sum(ws_net_profit - coalesce(wr_net_loss, 0)) AS profit
   FROM web_sales
   LEFT OUTER JOIN web_returns ON (ws_item_sk = wr_item_sk
                                   AND ws_order_number = wr_order_number), date_dim,
                                                                           web_site,
                                                                           item,
                                                                           promotion
   WHERE ws_sold_date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-22' AS date)
     AND ws_web_site_sk = web_site_sk
     AND ws_item_sk = i_item_sk
     AND i_current_price > 50
     AND ws_promo_sk = p_promo_sk
     AND p_channel_tv = 'N'
   GROUP BY web_site_id)
SELECT channel ,
       id ,
       sum(sales) AS sales ,
       sum(returns_) AS returns_ ,
       sum(profit) AS profit
FROM
  (SELECT 'store channel' AS channel ,
          concat('store', store_id) AS id ,
          sales ,
          returns_ ,
          profit
   FROM ssr
   UNION ALL SELECT 'catalog channel' AS channel ,
                    concat('catalog_page', catalog_page_id) AS id ,
                    sales ,
                    returns_ ,
                    profit
   FROM csr
   UNION ALL SELECT 'web channel' AS channel ,
                    concat('web_site', web_site_id) AS id ,
                    sales ,
                    returns_ ,
                    profit
   FROM wsr ) x
GROUP BY ROLLUP (channel,
                 id)
ORDER BY channel NULLS FIRST,
         id NULLS FIRST
LIMIT 100;
----
NULL NULL 229240.98 25451.82 -73114.62
catalog channel NULL 76852.71 10074.36 6945.78
catalog channel catalog_pageAAAAAAAAAHCBAAAA 209.44 0.00 -5017.32
catalog channel catalog_pageAAAAAAAABHABAAAA 6152.40 0.00 972.90
catalog channel catalog_pageAAAAAAAABOPAAAAA 3207.47 537.44 -2547.01
catalog channel catalog_pageAAAAAAAACNPAAAAA 2220.63 449.10 -314.68
catalog channel catalog_pageAAAAAAAADMPAAAAA 2103.75 0.00 869.85
catalog channel catalog_pageAAAAAAAAEDABAAAA 3383.12 0.00 1440.92
catalog channel catalog_pageAAAAAAAAEFCBAAAA 145.53 0.00 -469.63
catalog channel catalog_pageAAAAAAAAFGABAAAA 643.20 0.00 62.10
catalog channel catalog_pageAAAAAAAAFMPAAAAA 6528.00 0.00 2559.36
catalog channel catalog_pageAAAAAAAAGPPAAAAA 991.12 0.00 551.98
catalog channel catalog_pageAAAAAAAAHCCBAAAA 162.11 0.00 -2316.41
catalog channel catalog_pageAAAAAAAAHLCBAAAA 1105.96 0.00 423.12
catalog channel catalog_pageAAAAAAAAJCABAAAA 4730.40 0.00 2270.16
catalog channel catalog_pageAAAAAAAAJPPAAAAA 859.86 0.00 -340.43
catalog channel catalog_pageAAAAAAAAKGABAAAA 132.86 0.00 -771.42
catalog channel catalog_pageAAAAAAAALAABAAAA 23607.20 0.00 7647.00
catalog channel catalog_pageAAAAAAAALNPAAAAA 1694.20 0.00 -842.54
catalog channel catalog_pageAAAAAAAAMCABAAAA 1377.36 0.00 -379.92
catalog channel catalog_pageAAAAAAAAMOCBAAAA 4168.42 0.00 1244.42
catalog channel catalog_pageAAAAAAAANAABAAAA 323.52 0.00 107.56
catalog channel catalog_pageAAAAAAAANDCBAAAA 749.74 591.90 -516.53
catalog channel catalog_pageAAAAAAAAOOPAAAAA 9870.26 8495.92 2139.86
catalog channel catalog_pageAAAAAAAAOPPAAAAA 2031.48 0.00 146.52
catalog channel catalog_pageAAAAAAAAPNCBAAAA 454.68 0.00 25.92
store channel NULL 126481.26 13753.88 -64974.84
store channel storeAAAAAAAABAAAAAAA 126481.26 13753.88 -64974.84
web channel NULL 25907.01 1623.58 -15085.56
web channel web_siteAAAAAAAABAAAAAAA 25907.01 1623.58 -15085.56

# Q81

query I
WITH customer_total_return AS
  (SELECT cr_returning_customer_sk AS ctr_customer_sk ,
          ca_state AS ctr_state,
          sum(cr_return_amt_inc_tax) AS ctr_total_return
   FROM catalog_returns ,
        date_dim ,
        customer_address
   WHERE cr_returned_date_sk = d_date_sk
     AND d_year = 2000
     AND cr_returning_addr_sk = ca_address_sk
   GROUP BY cr_returning_customer_sk ,
            ca_state)
SELECT c_customer_id,
       c_salutation,
       c_first_name,
       c_last_name,
       ca_street_number,
       ca_street_name ,
       ca_street_type,
       ca_suite_number,
       ca_city,
       ca_county,
       ca_state,
       ca_zip,
       ca_country,
       ca_gmt_offset ,
       ca_location_type,
       ctr_total_return
FROM customer_total_return ctr1 ,
     customer_address ,
     customer
WHERE ctr1.ctr_total_return >
    (SELECT avg(ctr_total_return)*1.2
     FROM customer_total_return ctr2
     WHERE ctr1.ctr_state = ctr2.ctr_state)
  AND ca_address_sk = c_current_addr_sk
  AND ca_state = 'GA'
  AND ctr1.ctr_customer_sk = c_customer_sk
ORDER BY c_customer_id,
         c_salutation,
         c_first_name,
         c_last_name,
         ca_street_number,
         ca_street_name ,
         ca_street_type,
         ca_suite_number,
         ca_city,
         ca_county,
         ca_state,
         ca_zip,
         ca_country,
         ca_gmt_offset ,
         ca_location_type,
         ctr_total_return
LIMIT 100;
----
AAAAAAAAFDAAAAAA Mr. Paul Higgins 828 2nd Miller ST Suite S Mechanicsburg Wheeler County GA 32219 United States -0.05 apartment 1510.68
AAAAAAAAFDDAAAAA Dr. Amy Joyce 640 4th Laurel Boulevard Suite 340 Enterprise Peach County GA 31757 United States -0.05 apartment 1141.36
AAAAAAAAHBCAAAAA Dr. Vera Prewitt 989 Hill 1st RD Suite E Lakeside Washington County GA 39532 United States -0.05 single family 607.00
AAAAAAAAHBDAAAAA Miss Ernestina Harding 939 Cedar  Court Suite A Mount Pleasant Marion County GA 32739 United States -0.05 single family 2412.24
AAAAAAAAJJCAAAAA Dr. Daniel Null 81 Lee 4th RD Suite 140 Centerville Coffee County GA 30059 United States -0.05 single family 2541.93
AAAAAAAALNDAAAAA Mr. Todd Norris 498 Lake  Way Suite 490 Spring Valley Habersham County GA 36060 United States -0.05 single family 4322.07
AAAAAAAAMEDAAAAA Ms. Michele Michael 986 West East Blvd Suite F Pleasant Grove Coweta County GA 34136 United States -0.05 apartment 3254.91
AAAAAAAANACAAAAA Miss Judith Winkler 52 6th Park Drive Suite E Farmington Johnson County GA 39145 United States -0.05 condo 4180.85
AAAAAAAANCAAAAAA Dr. Floy Hammonds 129 Valley  Circle Suite 410 Ashland Decatur County GA 34244 United States -0.05 single family 7302.22

# Q82

query I
SELECT i_item_id ,
       i_item_desc ,
       i_current_price
FROM item,
     inventory,
     date_dim,
     store_sales
WHERE i_current_price BETWEEN 62 AND 62+30
  AND inv_item_sk = i_item_sk
  AND d_date_sk=inv_date_sk
  AND d_date BETWEEN cast('2000-05-25' AS date) AND cast('2000-07-24' AS date)
  AND i_manufact_id IN (129,
                        270,
                        821,
                        423)
  AND inv_quantity_on_hand BETWEEN 100 AND 500
  AND ss_item_sk = i_item_sk
GROUP BY i_item_id,
         i_item_desc,
         i_current_price
ORDER BY i_item_id
LIMIT 100;
----

# Q83

query I
WITH sr_items AS
  (SELECT i_item_id item_id,
          sum(sr_return_quantity) sr_item_qty
   FROM store_returns,
        item,
        date_dim
   WHERE sr_item_sk = i_item_sk
     AND d_date IN
       (SELECT d_date
        FROM date_dim
        WHERE d_week_seq IN
            (SELECT d_week_seq
             FROM date_dim
             WHERE d_date IN ('2000-06-30',
                              '2000-09-27',
                              '2000-11-17')))
     AND sr_returned_date_sk = d_date_sk
   GROUP BY i_item_id),
     cr_items AS
  (SELECT i_item_id item_id,
          sum(cr_return_quantity) cr_item_qty
   FROM catalog_returns,
        item,
        date_dim
   WHERE cr_item_sk = i_item_sk
     AND d_date IN
       (SELECT d_date
        FROM date_dim
        WHERE d_week_seq IN
            (SELECT d_week_seq
             FROM date_dim
             WHERE d_date IN ('2000-06-30',
                              '2000-09-27',
                              '2000-11-17')))
     AND cr_returned_date_sk = d_date_sk
   GROUP BY i_item_id),
     wr_items AS
  (SELECT i_item_id item_id,
          sum(wr_return_quantity) wr_item_qty
   FROM web_returns,
        item,
        date_dim
   WHERE wr_item_sk = i_item_sk
     AND d_date IN
       (SELECT d_date
        FROM date_dim
        WHERE d_week_seq IN
            (SELECT d_week_seq
             FROM date_dim
             WHERE d_date IN ('2000-06-30',
                              '2000-09-27',
                              '2000-11-17')))
     AND wr_returned_date_sk = d_date_sk
   GROUP BY i_item_id)
SELECT sr_items.item_id ,
       sr_item_qty ,
       (sr_item_qty*1.0000)/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0000 * 100 sr_dev ,
       cr_item_qty ,
       (cr_item_qty*1.0000)/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0000 * 100 cr_dev ,
       wr_item_qty ,
       (wr_item_qty*1.0000)/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0000 * 100 wr_dev ,
       (sr_item_qty+cr_item_qty+wr_item_qty)/3.0 average
FROM sr_items ,
     cr_items ,
     wr_items
WHERE sr_items.item_id=cr_items.item_id
  AND sr_items.item_id=wr_items.item_id
ORDER BY sr_items.item_id NULLS FIRST,
         sr_item_qty NULLS FIRST
LIMIT 100;
----

# Q84

query I
SELECT c_customer_id AS customer_id ,
       concat(concat(coalesce(c_last_name, '') , ', '), coalesce(c_first_name, '')) AS customername
FROM customer ,
     customer_address ,
     customer_demographics ,
     household_demographics ,
     income_band ,
     store_returns
WHERE ca_city = 'Edgewood'
  AND c_current_addr_sk = ca_address_sk
  AND ib_lower_bound >= 38128
  AND ib_upper_bound <= 38128 + 50000
  AND ib_income_band_sk = hd_income_band_sk
  AND cd_demo_sk = c_current_cdemo_sk
  AND hd_demo_sk = c_current_hdemo_sk
  AND sr_cdemo_sk = cd_demo_sk
ORDER BY c_customer_id NULLS FIRST
LIMIT 100;
----
AAAAAAAAKOBAAAAA Alvarez, Cheri

# Q85

query I
SELECT SUBSTRING(r_reason_desc,1,20) ,
       avg(ws_quantity) avg1,
       avg(wr_refunded_cash) avg2,
       avg(wr_fee)
FROM web_sales,
     web_returns,
     web_page,
     customer_demographics cd1,
     customer_demographics cd2,
     customer_address,
     date_dim,
     reason
WHERE ws_web_page_sk = wp_web_page_sk
  AND ws_item_sk = wr_item_sk
  AND ws_order_number = wr_order_number
  AND ws_sold_date_sk = d_date_sk
  AND d_year = 2000
  AND cd1.cd_demo_sk = wr_refunded_cdemo_sk
  AND cd2.cd_demo_sk = wr_returning_cdemo_sk
  AND ca_address_sk = wr_refunded_addr_sk
  AND r_reason_sk = wr_reason_sk
  AND ( ( cd1.cd_marital_status = 'M'
         AND cd1.cd_marital_status = cd2.cd_marital_status
         AND cd1.cd_education_status = 'Advanced Degree'
         AND cd1.cd_education_status = cd2.cd_education_status
         AND ws_sales_price BETWEEN 100.00 AND 150.00 )
       OR ( cd1.cd_marital_status = 'S'
           AND cd1.cd_marital_status = cd2.cd_marital_status
           AND cd1.cd_education_status = 'College'
           AND cd1.cd_education_status = cd2.cd_education_status
           AND ws_sales_price BETWEEN 50.00 AND 100.00 )
       OR ( cd1.cd_marital_status = 'W'
           AND cd1.cd_marital_status = cd2.cd_marital_status
           AND cd1.cd_education_status = '2 yr Degree'
           AND cd1.cd_education_status = cd2.cd_education_status
           AND ws_sales_price BETWEEN 150.00 AND 200.00 ) )
  AND ( ( ca_country = 'United States'
         AND ca_state IN ('IN',
                          'OH',
                          'NJ')
         AND ws_net_profit BETWEEN 100 AND 200)
       OR ( ca_country = 'United States'
           AND ca_state IN ('WI',
                            'CT',
                            'KY')
           AND ws_net_profit BETWEEN 150 AND 300)
       OR ( ca_country = 'United States'
           AND ca_state IN ('LA',
                            'IA',
                            'AR')
           AND ws_net_profit BETWEEN 50 AND 250) )
GROUP BY r_reason_desc
ORDER BY SUBSTRING(r_reason_desc,1,20) ,
         avg(ws_quantity) ,
         avg(wr_refunded_cash) ,
         avg(wr_fee)
LIMIT 100;
----

# Q86

query I
SELECT sum(ws_net_paid) AS total_sum ,
       i_category ,
       i_class ,
       grouping(i_category)+grouping(i_class) AS lochierarchy ,
       rank() OVER ( PARTITION BY grouping(i_category)+grouping(i_class),
                                  CASE
                                      WHEN grouping(i_class) = 0 THEN i_category
                                  END
                    ORDER BY sum(ws_net_paid) DESC) AS rank_within_parent
FROM web_sales ,
     date_dim d1 ,
     item
WHERE d1.d_month_seq BETWEEN 1200 AND 1200+11
  AND d1.d_date_sk = ws_sold_date_sk
  AND i_item_sk = ws_item_sk
GROUP BY rollup(i_category,i_class)
ORDER BY lochierarchy DESC NULLS FIRST,
         CASE
             WHEN lochierarchy = 0 THEN i_category
         END NULLS FIRST,
         rank_within_parent NULLS FIRST
LIMIT 100;
----
2934539.37 NULL NULL 2 1
444246.68 Men NULL 1 1
436924.98 Women NULL 1 2
400734.88 Books NULL 1 3
309546.35 Music NULL 1 4
301445.05 Jewelry NULL 1 5
283621.50 Electronics NULL 1 6
217201.98 Children NULL 1 7
204045.87 Home NULL 1 8
185014.69 Sports NULL 1 9
151757.39 Shoes NULL 1 10
105458.38 Books self-help 0 1
98957.86 Books fiction 0 2
68225.15 Books arts 0 3
35418.56 Books parenting 0 4
31847.49 Books mystery 0 5
27867.06 Books reference 0 6
19902.81 Books travel 0 7
13057.57 Books sports 0 8
104879.37 Children toddlers 0 1
69251.78 Children school-uniforms 0 2
43070.83 Children newborn 0 3
85095.58 Electronics musical 0 1
36873.40 Electronics wireless 0 2
36853.24 Electronics scanners 0 3
33405.26 Electronics televisions 0 4
25019.03 Electronics disk drives 0 5
24659.18 Electronics karoke 0 6
21241.53 Electronics memory 0 7
20474.28 Electronics dvd/vcr players 0 8
52023.18 Home curtains/drapes 0 1
38567.89 Home kids 0 2
33778.05 Home lighting 0 3
31690.30 Home bedding 0 4
25171.01 Home rugs 0 5
22815.44 Home furniture 0 6
61364.01 Jewelry estate 0 1
46139.99 Jewelry pendants 0 2
41876.10 Jewelry gold 0 3
37463.22 Jewelry diamonds 0 4
31310.64 Jewelry bracelets 0 5
31291.85 Jewelry semi-precious 0 6
29366.31 Jewelry jewelry boxes 0 7
22632.93 Jewelry costume 0 8
231552.05 Men sports-apparel 0 1
163696.54 Men accessories 0 2
28832.29 Men pants 0 3
20165.80 Men shirts 0 4
139092.26 Music pop 0 1
76210.78 Music rock 0 2
53106.18 Music classical 0 3
41137.13 Music country 0 4
70259.60 Shoes womens 0 1
49655.40 Shoes kids 0 2
31842.39 Shoes athletic 0 3
53364.71 Sports hockey 0 1
45198.01 Sports outdoor 0 2
31378.52 Sports fishing 0 3
25002.75 Sports optics 0 4
18940.97 Sports guns 0 5
11129.73 Sports camping 0 6
168760.07 Women swimwear 0 1
111666.96 Women fragrances 0 2
97885.26 Women maternity 0 3
58612.69 Women dresses 0 4

# Q87

query I
SELECT count(*)
FROM ((SELECT DISTINCT c_last_name,
                         c_first_name,
                         d_date
         FROM store_sales,
              date_dim,
              customer
         WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk
           AND store_sales.ss_customer_sk = customer.c_customer_sk
           AND d_month_seq BETWEEN 1200 AND 1200+11)
      EXCEPT
        (SELECT DISTINCT c_last_name,
                         c_first_name,
                         d_date
         FROM catalog_sales,
              date_dim,
              customer
         WHERE catalog_sales.cs_sold_date_sk = date_dim.d_date_sk
           AND catalog_sales.cs_bill_customer_sk = customer.c_customer_sk
           AND d_month_seq BETWEEN 1200 AND 1200+11)
      EXCEPT
        (SELECT DISTINCT c_last_name,
                         c_first_name,
                         d_date
         FROM web_sales,
              date_dim,
              customer
         WHERE web_sales.ws_sold_date_sk = date_dim.d_date_sk
           AND web_sales.ws_bill_customer_sk = customer.c_customer_sk
           AND d_month_seq BETWEEN 1200 AND 1200+11)) cool_cust ;
----
494

# Q88

query I
SELECT *
FROM
  (SELECT count(*) h8_30_to_9
   FROM store_sales,
        household_demographics,
        time_dim,
        store
   WHERE ss_sold_time_sk = time_dim.t_time_sk
     AND ss_hdemo_sk = household_demographics.hd_demo_sk
     AND ss_store_sk = s_store_sk
     AND time_dim.t_hour = 8
     AND time_dim.t_minute >= 30
     AND ((household_demographics.hd_dep_count = 4
           AND household_demographics.hd_vehicle_count<=4+2)
          OR (household_demographics.hd_dep_count = 2
              AND household_demographics.hd_vehicle_count<=2+2)
          OR (household_demographics.hd_dep_count = 0
              AND household_demographics.hd_vehicle_count<=0+2))
     AND store.s_store_name = 'ese') s1,
  (SELECT count(*) h9_to_9_30
   FROM store_sales,
        household_demographics,
        time_dim,
        store
   WHERE ss_sold_time_sk = time_dim.t_time_sk
     AND ss_hdemo_sk = household_demographics.hd_demo_sk
     AND ss_store_sk = s_store_sk
     AND time_dim.t_hour = 9
     AND time_dim.t_minute < 30
     AND ((household_demographics.hd_dep_count = 4
           AND household_demographics.hd_vehicle_count<=4+2)
          OR (household_demographics.hd_dep_count = 2
              AND household_demographics.hd_vehicle_count<=2+2)
          OR (household_demographics.hd_dep_count = 0
              AND household_demographics.hd_vehicle_count<=0+2))
     AND store.s_store_name = 'ese') s2,
  (SELECT count(*) h9_30_to_10
   FROM store_sales,
        household_demographics,
        time_dim,
        store
   WHERE ss_sold_time_sk = time_dim.t_time_sk
     AND ss_hdemo_sk = household_demographics.hd_demo_sk
     AND ss_store_sk = s_store_sk
     AND time_dim.t_hour = 9
     AND time_dim.t_minute >= 30
     AND ((household_demographics.hd_dep_count = 4
           AND household_demographics.hd_vehicle_count<=4+2)
          OR (household_demographics.hd_dep_count = 2
              AND household_demographics.hd_vehicle_count<=2+2)
          OR (household_demographics.hd_dep_count = 0
              AND household_demographics.hd_vehicle_count<=0+2))
     AND store.s_store_name = 'ese') s3,
  (SELECT count(*) h10_to_10_30
   FROM store_sales,
        household_demographics,
        time_dim,
        store
   WHERE ss_sold_time_sk = time_dim.t_time_sk
     AND ss_hdemo_sk = household_demographics.hd_demo_sk
     AND ss_store_sk = s_store_sk
     AND time_dim.t_hour = 10
     AND time_dim.t_minute < 30
     AND ((household_demographics.hd_dep_count = 4
           AND household_demographics.hd_vehicle_count<=4+2)
          OR (household_demographics.hd_dep_count = 2
              AND household_demographics.hd_vehicle_count<=2+2)
          OR (household_demographics.hd_dep_count = 0
              AND household_demographics.hd_vehicle_count<=0+2))
     AND store.s_store_name = 'ese') s4,
  (SELECT count(*) h10_30_to_11
   FROM store_sales,
        household_demographics,
        time_dim,
        store
   WHERE ss_sold_time_sk = time_dim.t_time_sk
     AND ss_hdemo_sk = household_demographics.hd_demo_sk
     AND ss_store_sk = s_store_sk
     AND time_dim.t_hour = 10
     AND time_dim.t_minute >= 30
     AND ((household_demographics.hd_dep_count = 4
           AND household_demographics.hd_vehicle_count<=4+2)
          OR (household_demographics.hd_dep_count = 2
              AND household_demographics.hd_vehicle_count<=2+2)
          OR (household_demographics.hd_dep_count = 0
              AND household_demographics.hd_vehicle_count<=0+2))
     AND store.s_store_name = 'ese') s5,
  (SELECT count(*) h11_to_11_30
   FROM store_sales,
        household_demographics,
        time_dim,
        store
   WHERE ss_sold_time_sk = time_dim.t_time_sk
     AND ss_hdemo_sk = household_demographics.hd_demo_sk
     AND ss_store_sk = s_store_sk
     AND time_dim.t_hour = 11
     AND time_dim.t_minute < 30
     AND ((household_demographics.hd_dep_count = 4
           AND household_demographics.hd_vehicle_count<=4+2)
          OR (household_demographics.hd_dep_count = 2
              AND household_demographics.hd_vehicle_count<=2+2)
          OR (household_demographics.hd_dep_count = 0
              AND household_demographics.hd_vehicle_count<=0+2))
     AND store.s_store_name = 'ese') s6,
  (SELECT count(*) h11_30_to_12
   FROM store_sales,
        household_demographics,
        time_dim,
        store
   WHERE ss_sold_time_sk = time_dim.t_time_sk
     AND ss_hdemo_sk = household_demographics.hd_demo_sk
     AND ss_store_sk = s_store_sk
     AND time_dim.t_hour = 11
     AND time_dim.t_minute >= 30
     AND ((household_demographics.hd_dep_count = 4
           AND household_demographics.hd_vehicle_count<=4+2)
          OR (household_demographics.hd_dep_count = 2
              AND household_demographics.hd_vehicle_count<=2+2)
          OR (household_demographics.hd_dep_count = 0
              AND household_demographics.hd_vehicle_count<=0+2))
     AND store.s_store_name = 'ese') s7,
  (SELECT count(*) h12_to_12_30
   FROM store_sales,
        household_demographics,
        time_dim,
        store
   WHERE ss_sold_time_sk = time_dim.t_time_sk
     AND ss_hdemo_sk = household_demographics.hd_demo_sk
     AND ss_store_sk = s_store_sk
     AND time_dim.t_hour = 12
     AND time_dim.t_minute < 30
     AND ((household_demographics.hd_dep_count = 4
           AND household_demographics.hd_vehicle_count<=4+2)
          OR (household_demographics.hd_dep_count = 2
              AND household_demographics.hd_vehicle_count<=2+2)
          OR (household_demographics.hd_dep_count = 0
              AND household_demographics.hd_vehicle_count<=0+2))
     AND store.s_store_name = 'ese') s8 ;
----
0 0 0 0 0 0 0 0

# Q89

query I
SELECT * from
  (SELECT i_category, i_class, i_brand, s_store_name, s_company_name, d_moy, sum(ss_sales_price) sum_sales, avg(sum(ss_sales_price)) OVER (PARTITION BY i_category, i_brand, s_store_name, s_company_name) avg_monthly_sales
   FROM item, store_sales, date_dim, store
   WHERE ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND ss_store_sk = s_store_sk
     AND d_year = 1999
     AND ((i_category IN ('Books','Electronics','Sports')
           AND i_class IN ('computers','stereo','football') )
          OR (i_category IN ('Men','Jewelry','Women')
              AND i_class IN ('shirts','birdal','dresses')))
   GROUP BY i_category, i_class, i_brand, s_store_name, s_company_name, d_moy) tmp1
WHERE CASE
          WHEN (avg_monthly_sales <> 0) THEN (abs(sum_sales - avg_monthly_sales) / avg_monthly_sales)
          ELSE NULL
      END > 0.1
ORDER BY sum_sales - avg_monthly_sales,
         s_store_name, 1, 2, 3, 5, 6, 7, 8
LIMIT 100;
----
Women dresses amalgamalg #1 ought Unknown 6 7.23 421.9750
Women dresses amalgamalg #1 ought Unknown 1 176.88 421.9750
Women dresses amalgamalg #1 ought Unknown 5 191.09 421.9750
Men shirts importoimporto #1 ought Unknown 2 27.33 214.0218
Women dresses amalgamalg #1 ought Unknown 7 236.55 421.9750
Women dresses amalgamalg #1 ought Unknown 2 263.85 421.9750
Women dresses amalgamalg #1 ought Unknown 3 286.23 421.9750
Women dresses amalgamalg #1 ought Unknown 9 289.33 421.9750
Men shirts importoimporto #1 ought Unknown 10 88.76 214.0218
Men shirts importoimporto #1 ought Unknown 5 124.77 214.0218
Men shirts importoimporto #1 ought Unknown 1 266.32 214.0218
Men shirts importoimporto #1 ought Unknown 8 297.72 214.0218
Men shirts importoimporto #1 ought Unknown 9 328.95 214.0218
Men shirts importoimporto #1 ought Unknown 12 378.93 214.0218
Women dresses amalgamalg #1 ought Unknown 8 704.26 421.9750
Women dresses amalgamalg #1 ought Unknown 10 725.64 421.9750
Women dresses amalgamalg #1 ought Unknown 11 892.42 421.9750
Women dresses amalgamalg #1 ought Unknown 12 903.74 421.9750

# Q90

query I
SELECT case when pmc=0 then null else cast(amc AS decimal(15,4))/cast(pmc AS decimal(15,4)) end am_pm_ratio
FROM
  (SELECT count(*) amc
   FROM web_sales,
        household_demographics,
        time_dim,
        web_page
   WHERE ws_sold_time_sk = time_dim.t_time_sk
     AND ws_ship_hdemo_sk = household_demographics.hd_demo_sk
     AND ws_web_page_sk = web_page.wp_web_page_sk
     AND time_dim.t_hour BETWEEN 8 AND 8+1
     AND household_demographics.hd_dep_count = 6
     AND web_page.wp_char_count BETWEEN 5000 AND 5200) AT,
  (SELECT count(*) pmc
   FROM web_sales,
        household_demographics,
        time_dim,
        web_page
   WHERE ws_sold_time_sk = time_dim.t_time_sk
     AND ws_ship_hdemo_sk = household_demographics.hd_demo_sk
     AND ws_web_page_sk = web_page.wp_web_page_sk
     AND time_dim.t_hour BETWEEN 19 AND 19+1
     AND household_demographics.hd_dep_count = 6
     AND web_page.wp_char_count BETWEEN 5000 AND 5200) pt
ORDER BY am_pm_ratio
LIMIT 100;
----
NULL

# Q91

query I
SELECT cc_call_center_id Call_Center,
       cc_name Call_Center_Name,
       cc_manager Manager,
       sum(cr_net_loss) Returns_Loss
FROM call_center,
     catalog_returns,
     date_dim,
     customer,
     customer_address,
     customer_demographics,
     household_demographics
WHERE cr_call_center_sk = cc_call_center_sk
  AND cr_returned_date_sk = d_date_sk
  AND cr_returning_customer_sk= c_customer_sk
  AND cd_demo_sk = c_current_cdemo_sk
  AND hd_demo_sk = c_current_hdemo_sk
  AND ca_address_sk = c_current_addr_sk
  AND d_year = 1998
  AND d_moy = 11
  AND ((cd_marital_status = 'M'
        AND cd_education_status = 'Unknown') or(cd_marital_status = 'W'
                                                AND cd_education_status = 'Advanced Degree'))
  AND hd_buy_potential LIKE 'Unknown%'
  AND ca_gmt_offset = -7
GROUP BY cc_call_center_id,
         cc_name,
         cc_manager,
         cd_marital_status,
         cd_education_status
ORDER BY sum(cr_net_loss) DESC;
----

# Q92

query I
SELECT sum(ws_ext_discount_amt) AS "Excess Discount Amount"
FROM web_sales,
     item,
     date_dim
WHERE i_manufact_id = 350
  AND i_item_sk = ws_item_sk
  AND d_date BETWEEN '2000-01-27' AND cast('2000-04-26' AS date)
  AND d_date_sk = ws_sold_date_sk
  AND ws_ext_discount_amt >
    (SELECT 1.3 * avg(ws_ext_discount_amt)
     FROM web_sales,
          date_dim
     WHERE ws_item_sk = i_item_sk
       AND d_date BETWEEN '2000-01-27' AND cast('2000-04-26' AS date)
       AND d_date_sk = ws_sold_date_sk )
ORDER BY sum(ws_ext_discount_amt)
LIMIT 100;
----
NULL

# Q93

query I
SELECT ss_customer_sk,
       sum(act_sales) sumsales
FROM
  (SELECT ss_item_sk,
          ss_ticket_number,
          ss_customer_sk,
          CASE
              WHEN sr_return_quantity IS NOT NULL THEN (ss_quantity-sr_return_quantity)*ss_sales_price
              ELSE (ss_quantity*ss_sales_price)
          END act_sales
   FROM store_sales
   LEFT OUTER JOIN store_returns ON (sr_item_sk = ss_item_sk
                                     AND sr_ticket_number = ss_ticket_number) ,reason
   WHERE sr_reason_sk = r_reason_sk
     AND r_reason_desc = 'reason 28') t
GROUP BY ss_customer_sk
ORDER BY sumsales NULLS FIRST,
         ss_customer_sk NULLS FIRST
LIMIT 100;
----

# Q94

query I
SELECT count(DISTINCT ws_order_number) AS "order count" ,
       sum(ws_ext_ship_cost) AS "total shipping cost" ,
       sum(ws_net_profit) AS "total net profit"
FROM web_sales ws1 ,
     date_dim ,
     customer_address ,
     web_site
WHERE d_date BETWEEN '1999-02-01' AND cast('1999-04-02' AS date)
  AND ws1.ws_ship_date_sk = d_date_sk
  AND ws1.ws_ship_addr_sk = ca_address_sk
  AND ca_state = 'IL'
  AND ws1.ws_web_site_sk = web_site_sk
  AND web_company_name = 'pri'
  AND EXISTS
    (SELECT *
     FROM web_sales ws2
     WHERE ws1.ws_order_number = ws2.ws_order_number
       AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)
  AND NOT exists
    (SELECT *
     FROM web_returns wr1
     WHERE ws1.ws_order_number = wr1.wr_order_number)
ORDER BY count(DISTINCT ws_order_number)
LIMIT 100;
----
0 NULL NULL

# Q95

query I
WITH ws_wh AS
  (SELECT ws1.ws_order_number,
          ws1.ws_warehouse_sk wh1,
          ws2.ws_warehouse_sk wh2
   FROM web_sales ws1,
        web_sales ws2
   WHERE ws1.ws_order_number = ws2.ws_order_number
     AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)
SELECT count(DISTINCT ws_order_number) AS "order count" ,
       sum(ws_ext_ship_cost) AS "total shipping cost" ,
       sum(ws_net_profit) AS "total net profit"
FROM web_sales ws1 ,
     date_dim ,
     customer_address ,
     web_site
WHERE d_date BETWEEN '1999-02-01' AND cast('1999-04-02' AS date)
  AND ws1.ws_ship_date_sk = d_date_sk
  AND ws1.ws_ship_addr_sk = ca_address_sk
  AND ca_state = 'IL'
  AND ws1.ws_web_site_sk = web_site_sk
  AND web_company_name = 'pri'
  AND ws1.ws_order_number IN
    (SELECT ws_order_number
     FROM ws_wh)
  AND ws1.ws_order_number IN
    (SELECT wr_order_number
     FROM web_returns,
          ws_wh
     WHERE wr_order_number = ws_wh.ws_order_number)
ORDER BY count(DISTINCT ws_order_number)
LIMIT 100;
----
0 NULL NULL

# Q96

query I
SELECT count(*)
FROM store_sales ,
     household_demographics,
     time_dim,
     store
WHERE ss_sold_time_sk = time_dim.t_time_sk
  AND ss_hdemo_sk = household_demographics.hd_demo_sk
  AND ss_store_sk = s_store_sk
  AND time_dim.t_hour = 20
  AND time_dim.t_minute >= 30
  AND household_demographics.hd_dep_count = 7
  AND store.s_store_name = 'ese'
ORDER BY count(*)
LIMIT 100;
----
0

# Q97

query I
WITH ssci AS
  (SELECT ss_customer_sk customer_sk ,
          ss_item_sk item_sk
   FROM store_sales,
        date_dim
   WHERE ss_sold_date_sk = d_date_sk
     AND d_month_seq BETWEEN 1200 AND 1200 + 11
   GROUP BY ss_customer_sk ,
            ss_item_sk),
     csci as
  ( SELECT cs_bill_customer_sk customer_sk ,cs_item_sk item_sk
   FROM catalog_sales,date_dim
   WHERE cs_sold_date_sk = d_date_sk
     AND d_month_seq BETWEEN 1200 AND 1200 + 11
   GROUP BY cs_bill_customer_sk ,cs_item_sk)
SELECT sum(CASE
               WHEN ssci.customer_sk IS NOT NULL
                    AND csci.customer_sk IS NULL THEN 1
               ELSE 0
           END) store_only ,
       sum(CASE
               WHEN ssci.customer_sk IS NULL
                    AND csci.customer_sk IS NOT NULL THEN 1
               ELSE 0
           END) catalog_only ,
       sum(CASE
               WHEN ssci.customer_sk IS NOT NULL
                    AND csci.customer_sk IS NOT NULL THEN 1
               ELSE 0
           END) store_and_catalog
FROM ssci
FULL OUTER JOIN csci ON (ssci.customer_sk=csci.customer_sk
                         AND ssci.item_sk = csci.item_sk)
LIMIT 100;
----
5447 3460 252

# Q98

query I
SELECT i_item_id ,
       i_item_desc,
       i_category,
       i_class,
       i_current_price ,
       sum(ss_ext_sales_price) AS itemrevenue,
       sum(ss_ext_sales_price)*100.0000/sum(sum(ss_ext_sales_price)) OVER (PARTITION BY i_class) AS revenueratio
FROM store_sales ,
     item,
     date_dim
WHERE ss_item_sk = i_item_sk
  AND i_category IN ('Sports',
                     'Books',
                     'Home')
  AND ss_sold_date_sk = d_date_sk
  AND d_date BETWEEN cast('1999-02-22' AS date) AND cast('1999-03-24' AS date)
GROUP BY i_item_id ,
         i_item_desc,
         i_category ,
         i_class ,
         i_current_price
ORDER BY i_category  NULLS FIRST,
         i_class  NULLS FIRST,
         i_item_id  NULLS FIRST,
         i_item_desc  NULLS FIRST,
         revenueratio NULLS FIRST;
----
AAAAAAAABGAAAAAA More reg Books fiction 57.09 4776.72 36.813180461436
AAAAAAAADEAAAAAA Already  Books fiction 1.47 2433.01 18.750698427892
AAAAAAAALIAAAAAA Lines shall describe explicitly northern, firm systems. Later Books fiction 2.99 5765.84 44.436121110672
AAAAAAAAIGAAAAAA Connections must constitute only eastern leaves. Primary, elderly times make expectations. Never tory stores build very points. Books mystery 2.33 2020.50 100.000000000000
AAAAAAAAKHAAAAAA Well lovely hands know even  Books parenting 2.62 812.31 100.000000000000
AAAAAAAANJAAAAAA Recent performances get yet other publications; current patients could not carry comparatively intense, vital times. Wide problems smooth truly. Tomorrow used years catch a Books reference 2.21 361.00 100.000000000000
AAAAAAAABJAAAAAA Prospects know Books self-help 59.77 4781.65 97.494561150610
AAAAAAAAJHAAAAAA However increasing dates meet. Large, ready goals mean now blind structures. Crea Books self-help 38.79 122.88 2.505438849390
AAAAAAAALCAAAAAA Resources shall not continue thus similar, practical results. Practical words f Books travel 6.08 13248.42 74.012857985627
AAAAAAAAMEAAAAAA Original interests see of course british, important terms. Yet appropriate principles conclude in a arrangements; good countries would get sometimes;  Books travel 3.84 4651.74 25.987142014373
AAAAAAAAACAAAAAA Ce Home curtains/drapes 1.77 3684.06 55.389819805598
AAAAAAAAAIAAAAAA Great, tiny animals adopt then outcomes. Terms sweep less dry, physical signs. National, black terms adapt for a reasons; groups shall  Home curtains/drapes 4.06 2967.09 44.610180194402
AAAAAAAADHAAAAAA Policies used to decrease social forms; well massive parts admire lacking, necessary cities. More rational areas deceive therefore only facilities. Yet persist Home furniture 2.68 292.95 100.000000000000
AAAAAAAAPHAAAAAA High, black homes shall not greet also magnificent facts; inc, environmental areas say well howev Home kids 3.66 6354.18 100.000000000000
AAAAAAAAICAAAAAA Usually other children must stop shares. Relations Home lighting 9.93 16068.15 65.478451156498
AAAAAAAAOJAAAAAA Great, absent relations should participate alone wonderful issues; chains will care on behalf of a police. Substantial activities exert grey, free Home lighting 9.17 8471.45 34.521548843502
AAAAAAAANGAAAAAA Solutions may not go central, interesting sectors. Enterprises resist inte Home rugs 9.46 20720.95 100.000000000000
AAAAAAAAKKAAAAAA Important, glad rights change however. Only regular arms ought to operate in a minutes. Units fail quite like a centuries. Simply safe branches accompany major tenants;  Sports camping 1.65 786.60 100.000000000000
AAAAAAAACIAAAAAA Final orders give else. International, living personnel may miss significant companies. Black, american numbers put then  Sports fishing 1.70 3687.63 37.836631545250
AAAAAAAAPBAAAAAA Bright advisers explain i Sports fishing 8.48 6058.56 62.163368454750
AAAAAAAAMKAAAAAA Automatic, black developments get thus new profits. Chemicals describe widely similar temperatures. Easy features used to emphasize different  Sports hockey 0.83 4688.92 80.728201808453
AAAAAAAAOAAAAAAA Important grounds rip there just big vehicles. Journalists w Sports hockey 1.85 1119.36 19.271798191547
AAAAAAAAAEAAAAAA Public, annual h Sports optics 2.02 6766.08 47.591675845857
AAAAAAAAMFAAAAAA New, quick observations merge too worth a children; shares could live there crucial mountains. Simply eastern pounds shall crush immediately married long wives. Corporate, import Sports optics 4.48 7450.86 52.408324154143
AAAAAAAACGAAAAAA Years know merely religious reasons. New animals modernise well racial pieces. Various, chi Sports outdoor 3.16 4899.56 100.000000000000
AAAAAAAAAKAAAAAA Legs cannot make much across a children. Well industrial ports see so. Equal, full systems rise police. Labour departments will leave. Political, social  Sports sailing 1.17 710.10 100.000000000000

# Q99

query I
SELECT w_substr ,
       sm_type ,
       LOWER(cc_name) cc_name_lower ,
       sum(CASE
               WHEN (cs_ship_date_sk - cs_sold_date_sk <= 30) THEN 1
               ELSE 0
           END) AS "30 days",
       sum(CASE
               WHEN (cs_ship_date_sk - cs_sold_date_sk > 30)
                    AND (cs_ship_date_sk - cs_sold_date_sk <= 60) THEN 1
               ELSE 0
           END) AS "31-60 days",
       sum(CASE
               WHEN (cs_ship_date_sk - cs_sold_date_sk > 60)
                    AND (cs_ship_date_sk - cs_sold_date_sk <= 90) THEN 1
               ELSE 0
           END) AS "61-90 days",
       sum(CASE
               WHEN (cs_ship_date_sk - cs_sold_date_sk > 90)
                    AND (cs_ship_date_sk - cs_sold_date_sk <= 120) THEN 1
               ELSE 0
           END) AS "91-120 days",
       sum(CASE
               WHEN (cs_ship_date_sk - cs_sold_date_sk > 120) THEN 1
               ELSE 0
           END) AS ">120 days"
FROM catalog_sales ,
  (SELECT SUBSTRING(w_warehouse_name,1,20) w_substr, *
   FROM warehouse) AS sq1 ,
     ship_mode ,
     call_center ,
     date_dim
WHERE d_month_seq BETWEEN 1200 AND 1200 + 11
  AND cs_ship_date_sk = d_date_sk
  AND cs_warehouse_sk = w_warehouse_sk
  AND cs_ship_mode_sk = sm_ship_mode_sk
  AND cs_call_center_sk = cc_call_center_sk
GROUP BY w_substr ,
         sm_type ,
         cc_name
ORDER BY w_substr  NULLS FIRST,
         sm_type  NULLS FIRST,
        cc_name_lower NULLS FIRST
LIMIT 100;
----
Conventional childr EXPRESS ny metro 265 263 254 0 0
Conventional childr LIBRARY ny metro 176 182 178 0 0
Conventional childr NEXT DAY ny metro 256 251 235 0 0
Conventional childr OVERNIGHT ny metro 188 181 188 0 0
Conventional childr REGULAR ny metro 179 150 215 0 0
Conventional childr TWO DAY ny metro 185 183 158 0 0
